
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA CULPA - App</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/czObXpX.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/czObXpX.png">
    <meta name="theme-color" content="#6B2D91">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkxBIENVTFBBIiwKICAic2hvcnRfbmFtZSI6ICJMYSBDdWxwYSIsCiAgImRlc2NyaXB0aW9uIjogIlJhbmtpbmcgZGUgQXNpc3RlbmNpYXMiLAogICJzdGFydF91cmwiOiAiL2xhLWN1bHBhLWFwcC8iLAogICJzY29wZSI6ICIvbGEtY3VscGEtYXBwLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzEyMEQxRiIsCiAgInRoZW1lX2NvbG9yIjogIiM2QjJEOTEiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2kuaW1ndXIuY29tL2N6T2JYcFgucG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLAogICAgICAicHVycG9zZSI6ICJhbnkgbWFza2FibGUiCiAgICB9CiAgXQp9">
    <style>
     <style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    background: linear-gradient(135deg, #120D1F 0%, #1A1030 50%, #0F0A1A 100%);
    min-height: 100vh;
    color: white;
}

.container { max-width: 500px; margin: 0 auto; padding: 20px; }

.header {
    background: linear-gradient(135deg, #6B2D91 0%, #4A1D6B 50%, #3A1555 100%);
    padding: 40px 20px 30px;
    text-align: center;
    border-radius: 20px;
    margin-bottom: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.logo {
    width: min(280px, 70vw);
    height: min(280px, 70vw);
    margin: 0 auto 15px;
    background: url('https://i.imgur.com/czObXpX.png') center/contain no-repeat;
    border-radius: 20px;
}

.title {
    color: #FFD700;
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 5px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.subtitle { color: rgba(255,255,255,0.9); font-size: 14px; }

.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    background: rgba(20,10,35,0.7);
    padding: 10px;
    border-radius: 15px;
    border: 1px solid rgba(107,45,145,0.3);
}

.tab {
    flex: 1;
    padding: 10px 6px;
    text-align: center;
    background: transparent;
    border: 2px solid rgba(139,77,143,0.3);
    border-radius: 10px;
    color: rgba(255,255,255,0.6);
    cursor: pointer;
    font-size: 12px;
    min-width: 0;
    transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
}

.tab:hover {
    background: rgba(200,168,48,0.15);
    color: #FFD700;
    border-color: #FFD700;
}

.tab.active {
    background: linear-gradient(135deg, #6B2D91 0%, #4A1D6B 100%);
    color: #C8A830;
    border-color: #C8A830;
}

.content { display: none; transition: opacity 0.2s ease; }
.content.active { display: block; }

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 25px;
}

.stat-card,
.card,
.ranking-item {
    background: linear-gradient(145deg, #1b1038, #140c2c);
    border-radius: 15px;
    transition: transform 0.25s ease, box-shadow 0.25s ease;
}

.stat-card {
    padding: 20px;
    text-align: center;
    border: 2px solid rgba(107,45,145,0.35);
}

.card {
    padding: 15px;
    margin-bottom: 15px;
    border-left: 4px solid #C8A830;
}

.ranking-item {
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
    border: 2px solid rgba(107,45,145,0.35);
    box-shadow:
        0 4px 10px rgba(0,0,0,0.5),
        inset 0 1px 0 rgba(255,255,255,0.05);
}

.stat-card:hover,
.card:hover,
.ranking-item:hover {
    transform: translateY(-6px) scale(1.02);
    box-shadow:
        0 10px 25px rgba(0,0,0,0.6),
        0 0 15px rgba(200,168,48,0.35);
}

.ranking-item.top3 {
    border-color: #FFD700;
    box-shadow:
        0 8px 20px rgba(0,0,0,0.6),
        0 0 25px rgba(255,215,0,0.4);
}

.rank-number {
    font-size: 22px;
    font-weight: bold;
    color: #FFD700;
    min-width: 30px;
    letter-spacing: 1px;
}

.rank-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: linear-gradient(135deg, #8B4D8F 0%, #6B3870 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.rank-info { flex: 1; }

.badge {
    background: #FFD700;
    color: #1a1a2e;
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: bold;
}

.login-card {
    padding: 40px;
    border-radius: 20px;
    border: 2px solid rgba(139,77,143,0.3);
    max-width: 400px;
    width: 100%;
}

.mes-selector::-webkit-scrollbar { display: none; }
.mes-selector { -ms-overflow-style: none; scrollbar-width: none; }

@media (max-width: 500px) {
    .container { padding: 12px !important; }
    .ranking-item { padding: 12px !important; }
}
</style>

    </style>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
</head>
<body>
<div class="container" id="app">

    <!-- LOGIN -->
    <div id="loginScreen" class="login-screen">
        <div class="header">
            <div class="logo"></div>
            <div class="title">LA CULPA</div>
            <div class="subtitle">ğŸ‘‘ 8 reyes ğŸ‘‘</div>
        </div>
        <div class="login-card">
            <h2 style="color:#FFD700;margin-bottom:20px;">Bienvenido, Culposo</h2>
            <p style="color:rgba(255,255,255,0.7);margin-bottom:20px;">IngresÃ¡ tu email para ver tus stats</p>
            <input type="email" id="emailInput" class="login-input" placeholder="tu@email.com">
            <button onclick="login()" class="login-button">ENTRAR</button>
            <div id="errorMessage" class="error-message"></div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" style="display:none;">
        <div class="header">
            <button onclick="logout()" style="position:fixed;top:20px;right:20px;z-index:1000;background:rgba(255,255,255,0.2);border:2px solid #FFD700;color:#FFD700;padding:8px 15px;border-radius:10px;font-size:12px;font-weight:bold;cursor:pointer;">
                ğŸšª Cerrar sesiÃ³n
            </button>
            <div class="logo"></div>
            <div class="title">LA CULPA</div>
            <div class="subtitle">ğŸ‘‘ 8 reyes ğŸ‘‘</div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('home',this)">ğŸ <br>Home</div>
            <div class="tab" onclick="showTab('ranking',this)">ğŸ‘‘<br>Culposos</div>
            <div class="tab" onclick="showTab('juntadas',this)">ğŸ“…<br>Juntadas</div>
            <div class="tab" onclick="showTab('awards',this)">ğŸ†<br>Awards</div>
            <div class="tab" onclick="showTab('calculadora',this)">ğŸ’°<br>Calc</div>
            <div class="tab" onclick="showTab('perfil',this)">ğŸ‘¤<br>Perfil</div>
        </div>

        <!-- HOME -->
        <div id="home" class="content active">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-number" id="totalJuntadas">-</div><div class="stat-label">Juntadas</div></div>
                <div class="stat-card"><div class="stat-number" id="totalCulposos">-</div><div class="stat-label">Tu Asistencia</div></div>
            </div>
            <button onclick="abrirModalProponerJuntada()" style="width:100%;margin:15px 0 10px;background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);border:none;color:#1E1E3F;padding:12px;border-radius:10px;font-size:14px;font-weight:bold;cursor:pointer;">
                â• Proponer Juntada
            </button>
            <div id="ultimasJuntadas" class="loading"><div class="spinner"></div>Cargando juntadas...</div>
        </div>

        <!-- RANKING -->
        <div id="ranking" class="content">
            <div class="section-title">ğŸ† Ranking de Culposos</div>
            <div id="rankingList" class="loading"><div class="spinner"></div>Cargando ranking...</div>
        </div>

        <!-- JUNTADAS -->
        <div id="juntadas" class="content">
            <div class="section-title">ğŸ“… Historial de Juntadas</div>
            <div id="juntadasList" class="loading"><div class="spinner"></div>Cargando juntadas...</div>
        </div>

        <!-- DETALLE JUNTADA -->
        <div id="juntadaDetalle" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:2000;overflow-y:auto;padding:20px;">
            <div style="max-width:500px;margin:0 auto;position:relative;">
                <button onclick="cerrarDetalle()" style="position:fixed;top:20px;right:20px;background:rgba(255,255,255,0.2);border:2px solid #FFD700;color:#FFD700;padding:10px 20px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;z-index:2001;">âœ• Cerrar</button>
                <div id="juntadaDetalleContent"></div>
            </div>
        </div>

        <!-- MODAL CONFIRMAR ASISTENCIA -->
        <div id="modalConfirmar" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:2000;overflow-y:auto;padding:20px;">
            <div style="max-width:500px;margin:0 auto;position:relative;">
                <button onclick="cerrarModalConfirmar()" style="position:fixed;top:20px;right:20px;background:rgba(255,255,255,0.2);border:2px solid #FFD700;color:#FFD700;padding:10px 20px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;z-index:2001;">âœ• Cerrar</button>
                <div id="modalConfirmarContent"></div>
            </div>
        </div>

        <!-- AWARDS -->
        <div id="awards" class="content">
            <div class="section-title">ğŸ† LA CULPA Awards</div>
            <div style="text-align:center;margin-bottom:20px;">
                <select id="yearFilter" onchange="renderAwards()" style="background:linear-gradient(135deg,#8B4D8F 0%,#6B3870 100%);border:2px solid #FFD700;color:#FFD700;padding:10px 20px;border-radius:10px;font-size:14px;font-weight:bold;cursor:pointer;">
                    <option value="2025" style="background:#1e1e3f;color:#FFD700;" selected>2025</option>
                    <option value="2024" style="background:#1e1e3f;color:#FFD700;">2024</option>
                    <option value="2023" style="background:#1e1e3f;color:#FFD700;">2023</option>
                </select>
            </div>
            <div id="awardsList" class="loading"><div class="spinner"></div>Cargando premios...</div>
        </div>

        <!-- CALCULADORA -->
        <div id="calculadora" class="content">
            <div class="section-title">ğŸ’° Calculadora de Gastos</div>
            <div id="gastosContainer"></div>
            <button onclick="agregarGasto()" style="width:100%;margin:20px 0;background:linear-gradient(135deg,#8B4D8F 0%,#6B3870 100%);border:none;color:#FFD700;padding:15px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;">â• Agregar Gasto</button>
            <button onclick="calcularDivision()" style="width:100%;background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);border:none;color:#1E1E3F;padding:15px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;">ğŸ§® Calcular DivisiÃ³n</button>
            <div id="resultadoCalculo" style="margin-top:20px;"></div>
        </div>

        <!-- MODAL PROPONER JUNTADA -->
        <div id="modalProponerJuntada" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:2000;overflow-y:auto;padding:20px;">
            <div style="max-width:500px;margin:0 auto;position:relative;">
                <button onclick="cerrarModalProponerJuntada()" style="position:fixed;top:20px;right:20px;background:rgba(255,255,255,0.2);border:2px solid #FFD700;color:#FFD700;padding:10px 20px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;z-index:2001;">âœ• Cerrar</button>
                <div id="modalProponerContent"></div>
            </div>
        </div>

        <!-- MODAL EDITAR JUNTADA -->
        <div id="modalEditarJuntada" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:2000;overflow-y:auto;padding:20px;">
            <div style="max-width:500px;margin:0 auto;position:relative;">
                <button onclick="cerrarModalEditarJuntada()" style="position:fixed;top:20px;right:20px;background:rgba(255,255,255,0.2);border:2px solid #FFD700;color:#FFD700;padding:10px 20px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;z-index:2001;">âœ• Cerrar</button>
                <div id="modalEditarContent"></div>
            </div>
        </div>

        <!-- PERFIL -->
        <div id="perfil" class="content">
            <div class="section-title">ğŸ‘¤ Mi Perfil</div>
            <div id="perfilData" class="loading"><div class="spinner"></div>Cargando perfil...</div>
        </div>
    </div>
</div>

<script>
    const SHEET_ID = '161VeGFs7DuavtXRwt0QRgnoObuD-QeNDnfXnJvlESZE';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxrz7UH8fYW5DbP2wD3QtbNC3nigwv_0ZF6HTPgmpZAnouFvR5m1UE1INZAndRbcyKXRA/exec';
    const ADMIN_EMAIL = 'tomascimmino@gmail.com';

    const CULPOSOS_HOSTS = ['Zabala - Sami','CaamaÃ±o - Manu','Rama','Tirri - Toto','Santi','Toti - Lei','Mateo - Juli','Sin host'];
    const CATEGORIAS = ['Comida','Salida','CumpleaÃ±os','Entrenamiento','Otro'];
    const NOMBRES_MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

    const ALIAS_HOST = {
        'Leila':'Lei','Juli':'Juli','Tirri':'Tirri','Toto':'Toto',
        'Mateo':'Mateo','Toti':'Toti','Zabala':'Zabala','Sami':'Sami','CaamaÃ±o':'CaamaÃ±o','Manu':'Manu'
    };

    const FOTOS = {
        'Toto':'https://i.imgur.com/Y8NOVgH.png','CaamaÃ±o':'https://i.imgur.com/7E7f3Xy.png',
        'Rama':'https://i.imgur.com/8hsqIL8.png','Zabala':'https://i.imgur.com/IsgSjm9.png',
        'Santi':'https://i.imgur.com/iXHdIVT.png','Mateo':'https://i.imgur.com/MY6KbRq.png',
        'Tirri':'https://i.imgur.com/biqacxq.png','Toti':'https://i.imgur.com/fOVTNio.png',
        'Cata':'https://i.imgur.com/jhme4wb.png','Lola':'https://i.imgur.com/qTP4eT2.png',
        'Sami':'https://i.imgur.com/HP41gaP.png','Leila':'https://i.imgur.com/wcf3be4.png',
        'Juli':'https://i.imgur.com/cn779x3.png','Manu':'https://i.imgur.com/BzDK66B.png',
        'Matu':'https://i.imgur.com/gNabdVm.png'
    };

    const DRIVE_MESES = {
        '2026': {
            '1': '1PSdks-O-hEuQwSIbM0K0qiyYgmFnWHD5',
            '2': '1C58pq1fr-bvBX-WNzEBfkXvu5ObInQ6J'
        }
    };

    const DRIVE_FECHAS = {
        '7-1-2026':             '1P-bt4zhv4cDpT_O1dBlnlGhBUgu1f45e',
        '18-1-2026':            '1W8SDF-xEZ9QI6f0GwEqqpA18LM1opkLy',
        '24-1-2026':            '1Pq_2Ab6BWCYfIEuUf3pmjGXSX8h5IqJS',
        '8-2-2026 BRISAS':      '1UZ3iZfeeX8msJNTnTa5lqvVESSCu1OMl',
        '8-2-2026 CABA':        '1zu4_6jC17DYQu1FrpBe8J7c-P6ZeM9Pk',
        '12-2-2026':            '1pf9YS0N4Zvea960Wkvv4o4cLszL7vX-b',
        '14-2-2026':            '1EZ-VYqpUXpu7vhFGYSkfshOFMYtf97Fc',
        '16-2-2026 HURLINGHAM': '1b4PVdlHfPVy_G4cR4CETwL_5ya9IHIYo',
        '16-2-2026 PASTOR':     '1B36Ri17YnjquRxToBtJcmsGk9_aWcBMk'
    };

    function getDriveLink(juntada) {
        const sheetId = juntada['Drive ID'] || juntada['Drive Id'] || juntada['drive_id'] || '';
        if (sheetId) return `https://drive.google.com/drive/folders/${sheetId}`;

        if (!juntada.Fecha) return null;
        const partes = String(juntada.Fecha).split('/');
        if (partes.length !== 3) return null;
        const d = parseInt(partes[0]), m = parseInt(partes[1]), y = partes[2];
        const fechaKey = `${d}-${m}-${y}`;

        if (DRIVE_FECHAS[fechaKey])
            return `https://drive.google.com/drive/folders/${DRIVE_FECHAS[fechaKey]}`;

        const desc = (juntada.DescripciÃ³n || juntada.Descripcion || '').toUpperCase();
        const host = (juntada.Host || '').toUpperCase();
        for (const key of Object.keys(DRIVE_FECHAS)) {
            if (!key.startsWith(fechaKey + ' ')) continue;
            const sufijo = key.replace(fechaKey + ' ', '');
            if (desc.includes(sufijo) || host.includes(sufijo))
                return `https://drive.google.com/drive/folders/${DRIVE_FECHAS[key]}`;
        }

        const mesId = DRIVE_MESES[y]?.[String(m)];
        if (mesId) return `https://drive.google.com/drive/folders/${mesId}`;

        return null;
    }

    let currentUser = null;
    let juntadasData = [];
    let culpososData = [];
    let premiosData  = [];
    window.juntadasMesActivo = null;
    window.juntadasVerMas    = false;

    function esHostDe(hostStr, nombre) {
        if (!hostStr || !nombre) return false;
        const h = hostStr.toLowerCase();
        if (h.includes(nombre.toLowerCase())) return true;
        const ak = ALIAS_HOST[nombre];
        if (ak && h.includes(ak.toLowerCase())) return true;
        return false;
    }
    function tieneQuorum(j) {
        return parseInt(j['NÂ° Culposos'] || j['N Culposos'] || '0') >= 4;
    }
    function getUsuarioActual() {
        return culpososData.find(c => c.Email && c.Email.toLowerCase() === currentUser);
    }
    function parseFecha(fechaStr) {
        if (!fechaStr) return null;
        const s = String(fechaStr).trim();
        const p = s.split('/');
        if (p.length === 3) {
            const [a, b, c] = p.map(Number);
            if (a > 1900) return new Date(a, b-1, c);
            return new Date(c, b-1, a);
        }
        const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (iso) return new Date(Number(iso[1]), Number(iso[2])-1, Number(iso[3]));
        const d = new Date(s);
        return isNaN(d.getTime()) ? null : d;
    }
    function esConfirmadoPositivo(val) { return val === 'TRUE' || val === 'âœ“'; }
    function esConfirmadoNegativo(val) { return val === 'FALSE' || val === 'âœ—'; }
    function estaConfirmado(val)       { return esConfirmadoPositivo(val) || esConfirmadoNegativo(val); }
    function calcularRacha(nombre) {
        const hoy = new Date(); hoy.setHours(0,0,0,0);
        const pasadas = juntadasData
            .filter(j => { if (!j.Fecha) return false; const f = parseFecha(j.Fecha); return f && f < hoy && tieneQuorum(j); })
            .sort((a,b) => parseFecha(b.Fecha) - parseFecha(a.Fecha));
        let racha = 0;
        for (const j of pasadas) { if (esConfirmadoPositivo(j[nombre])) racha++; else break; }
        return racha;
    }

    async function login() {
        const email = document.getElementById('emailInput').value.trim().toLowerCase();
        const errorMsg = document.getElementById('errorMessage');
        if (!email || !email.includes('@')) { errorMsg.textContent = 'Por favor ingresÃ¡ un email vÃ¡lido'; return; }
        try {
            const r = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=CULPOSOS`);
            const temp = parseCSV(await r.text());
            if (!temp.some(c => c.Email && c.Email.toLowerCase() === email)) {
                errorMsg.textContent = 'âŒ Email no autorizado. Solo culposos pueden entrar.'; return;
            }
        } catch { errorMsg.textContent = 'Error conectando con el servidor. IntentÃ¡ de nuevo.'; return; }
        currentUser = email;
        localStorage.setItem('culpaUserEmail', email);
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        loadData();
        setTimeout(pedirPermisoNotificaciones, 3000);
    }

    function logout() {
        localStorage.removeItem('culpaUserEmail');
        currentUser = null;
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('emailInput').value = '';
        document.getElementById('errorMessage').textContent = '';
    }

    async function loadData() {
        try {
            const [jR, cR, pR] = await Promise.all([
                fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Hoja%201`),
                fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=CULPOSOS`),
                fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=PREMIOS`)
            ]);
            juntadasData = parseCSV(await jR.text());
            culpososData = parseCSV(await cR.text());
            premiosData  = parseCSV(await pR.text());
            window.juntadasMesActivo = null;
            window.juntadasVerMas = false;
            renderHome(); renderRanking(); renderJuntadas(); renderAwards(); renderPerfil();
        } catch(e) { console.error(e); alert('Error conectando con Google Sheets.'); }
    }

    function parseCSV(csv) {
        const lines = csv.split('\n');
        const headers = lines[0].split(',').map(h => h.replace(/"/g,'').trim());
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            const values = lines[i].split(',').map(v => v.replace(/"/g,'').trim());
            if (!values.some(v => v)) continue;
            const row = {};
            headers.forEach((h, idx) => row[h] = values[idx] || '');
            if (headers.includes('Fecha') && !row.Fecha && !row.DescripciÃ³n && !row.Descripcion) continue;
            data.push(row);
        }
        return data;
    }

    function renderHome() {
        const hoy = new Date(); hoy.setHours(0,0,0,0);
        let proximaJuntada = null, proximaIndex = -1;
        const juntadasPasadas = [];

        juntadasData.forEach((j, i) => {
            if (!j.Fecha) return;
            const f = parseFecha(j.Fecha);
            if (!f) return;
            if (f >= hoy && !proximaJuntada) { proximaJuntada = j; proximaIndex = i; }
            else if (f < hoy && tieneQuorum(j)) juntadasPasadas.push(j);
        });

        document.getElementById('totalJuntadas').textContent = juntadasPasadas.length;

        const usuario = getUsuarioActual();
        if (usuario) {
            let asistidas = 0;
            juntadasPasadas.forEach(j => { if (esConfirmadoPositivo(j[usuario.Nombre])) asistidas++; });
            const pct = juntadasPasadas.length > 0 ? Math.round((asistidas/juntadasPasadas.length)*100) : 0;
            let col = '#f44336';
            if (pct>=90) col='#4CAF50'; else if (pct>=70) col='#8BC34A'; else if (pct>=40) col='#FF9800';
            document.getElementById('totalCulposos').innerHTML = `<span style="color:${col}">${pct}%</span>`;
        }

        let proximaHTML = '';
        if (proximaJuntada && usuario) {
            const desc = proximaJuntada.DescripciÃ³n || proximaJuntada.Descripcion || '';
            if (desc && desc !== 'undefined') {
                const miVal = proximaJuntada[usuario.Nombre];
                const yaConfirme = estaConfirmado(miVal);
                const positivo = esConfirmadoPositivo(miVal);
                let estadoHTML = '';
                if (yaConfirme) {
                    if (positivo) {
                        estadoHTML = `<div style="text-align:center;padding:15px;background:rgba(76,175,80,0.2);border-radius:10px;margin-top:15px;border:2px solid #4CAF50;">
                            <div style="font-size:22px;margin-bottom:6px;">âœ…</div>
                            <div style="font-size:16px;font-weight:bold;color:#4CAF50;">Â¡Ya confirmaste asistencia!</div>
                            <button onclick="abrirModalConfirmar(${proximaIndex})" style="margin-top:10px;background:rgba(255,255,255,0.15);border:2px solid #FFD700;color:#FFD700;padding:8px 18px;border-radius:8px;font-size:12px;cursor:pointer;font-weight:bold;">âœï¸ Editar respuesta</button>
                        </div>`;
                    } else {
                        estadoHTML = `<div style="text-align:center;padding:15px;background:rgba(244,67,54,0.2);border-radius:10px;margin-top:15px;border:2px solid #f44336;">
                            <div style="font-size:22px;margin-bottom:6px;">âŒ</div>
                            <div style="font-size:16px;font-weight:bold;color:#f44336;">Me abstuve â€” no voy</div>
                            <button onclick="abrirModalConfirmar(${proximaIndex})" style="margin-top:10px;background:rgba(255,255,255,0.15);border:2px solid #FFD700;color:#FFD700;padding:8px 18px;border-radius:8px;font-size:12px;cursor:pointer;font-weight:bold;">âœï¸ Editar respuesta</button>
                        </div>`;
                    }
                } else {
                    estadoHTML = `<button onclick="abrirModalConfirmar(${proximaIndex})" style="width:100%;margin-top:15px;background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);border:none;color:#1E1E3F;padding:15px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;">ğŸ“ Confirmar asistencia</button>`;
                }
                const esHostProxima = esHostDe(proximaJuntada.Host, usuario.Nombre);
                const puedeEditarProxima = esHostProxima || currentUser === ADMIN_EMAIL;
                const botonesProxima = puedeEditarProxima ? `
                    <div style="display:flex;gap:10px;margin-top:12px;">
                        <button onclick="abrirModalEditarJuntada(${proximaIndex})" style="flex:1;background:rgba(255,215,0,0.15);border:2px solid #FFD700;color:#FFD700;padding:10px;border-radius:10px;font-size:13px;font-weight:bold;cursor:pointer;">âœï¸ Editar</button>
                        <button onclick="confirmarEliminar(${proximaIndex})" style="flex:1;background:rgba(244,67,54,0.15);border:2px solid #f44336;color:#f44336;padding:10px;border-radius:10px;font-size:13px;font-weight:bold;cursor:pointer;">ğŸ—‘ï¸ Eliminar</button>
                    </div>` : '';
                proximaHTML = `
                    <div class="section-title" style="margin-top:10px;">ğŸ¯ PrÃ³xima Juntada</div>
                    <div class="card" style="background:linear-gradient(135deg,rgba(255,215,0,0.15) 0%,rgba(255,215,0,0.05) 100%);border-left-color:#FFD700;">
                        <div class="card-date">${proximaJuntada.Fecha}</div>
                        <div class="card-title" style="font-size:20px;">${desc}</div>
                        <div class="card-details" style="margin:10px 0;">
                            <span>ğŸ  ${proximaJuntada.Host || 'Sin host'}</span>
                            ${proximaJuntada.CategorÃ­a || proximaJuntada.Categoria ? `<span>ğŸ·ï¸ ${proximaJuntada.CategorÃ­a || proximaJuntada.Categoria}</span>` : ''}
                        </div>
                        ${estadoHTML}${botonesProxima}
                    </div>`;
            }
        } else if (usuario) {
            proximaHTML = `
                <div class="section-title" style="margin-top:10px;">ğŸ¯ PrÃ³xima Juntada</div>
                <div class="card" style="background:rgba(139,77,143,0.1);text-align:center;">
                    <div style="font-size:40px;margin-bottom:10px;">ğŸ“…</div>
                    <div class="card-title" style="color:rgba(255,255,255,0.7);">No hay prÃ³xima juntada programada</div>
                </div>`;
        }

        const ultimas = juntadasPasadas.slice(-3).reverse();
        const ultimasHTML = ultimas.map(j => {
            const ri = juntadasData.indexOf(j);
            const foto = j['Foto Juntada'] || j['Foto juntada'] || '';
            return `<div class="card" onclick="verDetalleJuntada(${ri})" style="cursor:pointer;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                ${foto ? `<div style="width:100%;border-radius:10px;margin-bottom:12px;overflow:hidden;"><img src="${foto}" style="width:100%;max-height:180px;object-fit:cover;display:block;"></div>` : ''}
                <div class="card-date">${j.Fecha||''}</div>
                <div class="card-title">${j.DescripciÃ³n||j.Descripcion||'Juntada'}</div>
                <div class="card-details"><span>ğŸ  ${j.Host||'Sin host'}</span><span>ğŸ‘¥ ${j['NÂ° Asist']||'0'} asistentes</span></div>
            </div>`;
        }).join('') || '<p style="color:rgba(255,255,255,0.6);">No hay juntadas registradas</p>';

        document.getElementById('ultimasJuntadas').innerHTML =
            proximaHTML +
            (juntadasPasadas.length > 0 ? `<div class="section-title" style="margin-top:25px;">ğŸ”¥ Ãšltimas Juntadas</div>` : '') +
            ultimasHTML;
    }

    function renderRanking() {
        const sorted = [...culpososData].sort((a,b) => parseFloat(b.Porcentaje)-parseFloat(a.Porcentaje));
        const html = sorted.map((c, i) => {
            const pct = parseFloat(c.Porcentaje).toFixed(0);
            const foto = FOTOS[c.Nombre] || '';
            const r = calcularRacha(c.Nombre);
            const rachaHTML = r>=10
                ? `<span class="badge" style="background:rgba(180,80,0,0.2);color:#D4845A;border:1px solid rgba(180,80,0,0.35);cursor:default;" title="${r} juntadas seguidas">ğŸ”¥ ${r}</span>`
                : r>=5
                ? `<span class="badge" style="background:rgba(180,150,0,0.15);color:#C4A84A;border:1px solid rgba(180,150,0,0.3);cursor:default;" title="${r} juntadas seguidas">âš¡ ${r}</span>`
                : '';
            const col = (p => p>=90?'#4CAF50':p>=75?'#8BC34A':p>=60?'#FFD700':p>=45?'#FF9800':'#f44336')(parseFloat(pct));
            return `<div class="ranking-item ${i<3?'top3':''}">
                <div class="rank-number">${i+1}</div>
                <div class="rank-avatar" onclick="verPerfilCulposo('${c.Nombre}')" style="cursor:pointer;${foto?`background-image:url('${foto}');background-size:cover;background-position:center top;`:''}">
                    ${!foto?'ğŸ§”':''}
                </div>
                <div class="rank-info" onclick="verPerfilCulposo('${c.Nombre}')" style="cursor:pointer;">
                    <div class="rank-name">${c.Nombre}${pct==100?'<span class="badge" style="background:rgba(255,215,0,0.12);color:#C8A830;border:1px solid rgba(255,215,0,0.25);cursor:default;">ğŸ‘‘</span>':''}${rachaHTML}</div>
                    <div class="rank-stats">${c.Asistencias} de ${c['Total Juntadas']} juntadas</div>
                </div>
                <div class="rank-percentage" style="color:${col}">${pct}%</div>
            </div>`;
        }).join('');
        document.getElementById('rankingList').innerHTML = html;
    }

    function renderJuntadas() {
        const usuario = getUsuarioActual();
        const nombreUsuario = usuario ? usuario.Nombre : '';
        const hoy = new Date(); hoy.setHours(0,0,0,0);

        const pasadas = juntadasData.filter(j => {
            if (!j.Fecha) return false;
            const f = parseFecha(j.Fecha);
            return f && f < hoy && tieneQuorum(j);
        }).slice().reverse();

        let totalBannerHTML = '';
        if (nombreUsuario && pasadas.length > 0) {
            const asistTot = pasadas.filter(j => esConfirmadoPositivo(j[nombreUsuario])).length;
            const pctTot   = Math.round((asistTot / pasadas.length) * 100);
            let msg, emoji, col;
            if (pctTot < 40)      { msg=`Te venÃ­s absteniendo mucho. Saludos.`;       emoji='ğŸ˜´'; col='#f44336'; }
            else if (pctTot < 66) { msg=`VenÃ­s bien, pero cuidado con abstenerse.`;   emoji='ğŸ’ª'; col='#FF9800'; }
            else if (pctTot < 91) { msg=`Sos un culposo comprometido. SeguÃ­ asÃ­.`;    emoji='ğŸ”¥'; col='#4CAF50'; }
            else                  { msg=`CULPOSO NIVEL LEGENDARIO.`;                  emoji='ğŸ‘‘'; col='#FFD700'; }
            totalBannerHTML = `
                <div style="background:linear-gradient(135deg,rgba(107,45,145,0.25),rgba(74,29,107,0.15));border:2px solid ${col};border-radius:14px;padding:16px 20px;margin-bottom:18px;display:flex;align-items:center;gap:14px;">
                    <div style="font-size:34px;flex-shrink:0;">${emoji}</div>
                    <div>
                        <div style="color:${col};font-size:20px;font-weight:bold;line-height:1;">${asistTot}<span style="font-size:13px;color:rgba(255,255,255,0.5);font-weight:normal;"> / ${pasadas.length} juntadas</span></div>
                        <div style="color:${col};font-size:13px;font-weight:bold;">${pctTot}% de asistencia total</div>
                        <div style="color:rgba(255,255,255,0.5);font-size:12px;margin-top:2px;">${msg}</div>
                    </div>
                </div>`;
        }

        const mesesDisponibles = [];
        const mesesVistos = new Set();
        pasadas.forEach(j => {
            const f = parseFecha(j.Fecha);
            if (!f) return;
            const key = `${f.getFullYear()}-${f.getMonth()}`;
            if (!mesesVistos.has(key)) {
                mesesVistos.add(key);
                mesesDisponibles.push({ year: f.getFullYear(), month: f.getMonth(), key });
            }
        });

        if (!window.juntadasMesActivo && mesesDisponibles.length)
            window.juntadasMesActivo = mesesDisponibles[0].key;

        const activo = mesesDisponibles.find(m => m.key === window.juntadasMesActivo) || mesesDisponibles[0];

        const filtradas = activo
            ? pasadas.filter(j => {
                const f = parseFecha(j.Fecha);
                return f && f.getFullYear() === activo.year && f.getMonth() === activo.month;
              })
            : pasadas;

        const limite   = window.juntadasVerMas ? filtradas.length : 10;
        const mostradas = filtradas.slice(0, limite);

        const selectorHTML = mesesDisponibles.length > 1 ? `
            <div class="mes-selector" style="display:flex;gap:8px;overflow-x:auto;padding-bottom:8px;margin-bottom:18px;">
                ${mesesDisponibles.map(m => `
                    <button onclick="cambiarMesJuntadas('${m.key}')"
                        style="flex-shrink:0;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:bold;cursor:pointer;border:2px solid ${m.key===activo?.key?'#FFD700':'rgba(139,77,143,0.4)'};background:${m.key===activo?.key?'linear-gradient(135deg,#6B2D91,#4A1D6B)':'rgba(30,16,64,0.6)'};color:${m.key===activo?.key?'#FFD700':'rgba(255,255,255,0.6)'};">
                        ${NOMBRES_MESES[m.month]} ${m.year}
                    </button>`).join('')}
            </div>` : '';

        const cardsHTML = mostradas.map(j => {
            const ri = juntadasData.indexOf(j);
            const asistio   = esConfirmadoPositivo(j[nombreUsuario]);
            const foto      = j['Foto Juntada'] || j['Foto juntada'] || '';
            const driveLink = getDriveLink(j);
            // Solo mostrar Fotos si hay carpeta especÃ­fica (no fallback de mes)
            const tieneDrive = !!(j['Drive ID'] || j['Drive Id'] || j['drive_id'] || (() => {
                if (!j.Fecha) return false;
                const partes = String(j.Fecha).split('/');
                if (partes.length !== 3) return false;
                const d = parseInt(partes[0]), m = parseInt(partes[1]), y = partes[2];
                const fechaKey = `${d}-${m}-${y}`;
                if (DRIVE_FECHAS[fechaKey]) return true;
                const desc = (j.DescripciÃ³n || j.Descripcion || '').toUpperCase();
                const host = (j.Host || '').toUpperCase();
                return Object.keys(DRIVE_FECHAS).some(key => {
                    if (!key.startsWith(fechaKey + ' ')) return false;
                    const sufijo = key.replace(fechaKey + ' ', '');
                    return desc.includes(sufijo) || host.includes(sufijo);
                });
            })());
            return `<div class="card" onclick="verDetalleJuntada(${ri})" style="cursor:pointer;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                ${foto ? `<div style="width:100%;border-radius:10px;margin-bottom:15px;overflow:hidden;"><img src="${foto}" style="width:100%;max-height:200px;object-fit:cover;display:block;"></div>` : ''}
                <div class="card-date">${j.Fecha||'Fecha'}</div>
                <div class="card-title">${j.DescripciÃ³n||j.Descripcion||'Juntada'}</div>
                <div class="card-details">
                    <span>ğŸ  ${j.Host||'Sin host'}</span><span style="margin-left:10px;">ğŸ‘¥ ${j['NÂ° Asist']||'0'}</span>
                </div>
                <div style="display:flex;align-items:center;gap:8px;margin-top:8px;flex-wrap:wrap;">
                    ${tieneDrive && driveLink ? `<a href="${driveLink}" target="_blank" onclick="event.stopPropagation()" style="display:inline-flex;align-items:center;gap:4px;padding:5px 10px;border-radius:8px;background:rgba(66,133,244,0.2);border:1.5px solid #4285F4;color:#4285F4;font-size:11px;font-weight:bold;text-decoration:none;white-space:nowrap;">ğŸ“ Fotos</a>` : ''}
                    ${nombreUsuario ? `<span style="display:inline-block;padding:5px 10px;border-radius:8px;font-size:11px;font-weight:bold;white-space:nowrap;${asistio?'background:rgba(76,175,80,0.2);color:#4CAF50;':'background:rgba(244,67,54,0.2);color:#f44336;'}">${asistio?'âœ… FUISTE':'âŒ NO FUISTE'}</span>` : ''}
                </div>
            </div>`;
        }).join('');

        const verMasHTML = filtradas.length > 10 && !window.juntadasVerMas
            ? `<button onclick="verMasJuntadas()" style="width:100%;margin:5px 0 20px;background:rgba(139,77,143,0.2);border:2px solid rgba(139,77,143,0.5);color:#C8A830;padding:12px;border-radius:10px;font-size:14px;font-weight:bold;cursor:pointer;">
                Ver ${filtradas.length - 10} juntadas mÃ¡s de ${NOMBRES_MESES[activo?.month]} â†“
               </button>` : '';

        let motivacional = '';
        if (nombreUsuario && filtradas.length > 0) {
            const asistMes = filtradas.filter(j => esConfirmadoPositivo(j[nombreUsuario])).length;
            const pctMes   = Math.round((asistMes / filtradas.length) * 100);
            const mes      = NOMBRES_MESES[activo?.month] || '';
            let msg, emoji, col;
            if (pctMes < 40)      { msg=`Fuiste al ${pctMes}% en ${mes}. Muy ausente loco.`;     emoji='ğŸ˜´'; col='#f44336'; }
            else if (pctMes < 70) { msg=`Fuiste al ${pctMes}% en ${mes}. Bien, no te relajes.`;  emoji='ğŸ’ª'; col='#FF9800'; }
            else if (pctMes < 90) { msg=`Fuiste al ${pctMes}% en ${mes}. Culposo comprometido.`; emoji='ğŸ”¥'; col='#4CAF50'; }
            else                  { msg=`Fuiste al ${pctMes}% en ${mes}. CULPOSO DE LEY.`;       emoji='ğŸ‘‘'; col='#FFD700'; }
            motivacional = `<div class="card" style="background:rgba(139,77,143,0.2);border-left-color:${col};margin-top:10px;"><div style="text-align:center;"><div style="font-size:36px;margin-bottom:8px;">${emoji}</div><div style="color:${col};font-weight:bold;font-size:15px;">${msg}</div></div></div>`;
        }

        const totalMes = filtradas.length;
        document.getElementById('juntadasList').innerHTML = `
            ${totalBannerHTML}
            <div style="color:rgba(255,255,255,0.45);font-size:12px;margin-bottom:10px;">${totalMes} juntada${totalMes!==1?'s':''} en ${NOMBRES_MESES[activo?.month]||''} ${activo?.year||''}</div>
            ${selectorHTML}
            ${cardsHTML || `<p style="color:rgba(255,255,255,0.5);text-align:center;padding:30px;">Sin juntadas en este mes</p>`}
            ${verMasHTML}
            ${motivacional}`;
    }

    function cambiarMesJuntadas(key) {
        window.juntadasMesActivo = key;
        window.juntadasVerMas = false;
        renderJuntadas();
    }
    function verMasJuntadas() {
        window.juntadasVerMas = true;
        renderJuntadas();
    }

    function verDetalleJuntada(index) {
        const j = juntadasData[index];
        const usuario = getUsuarioActual();
        const asistentes = Object.keys(FOTOS).filter(n => esConfirmadoPositivo(j[n]));
        const hoy = new Date(); hoy.setHours(0,0,0,0);
        const fechaJ = j.Fecha ? parseFecha(j.Fecha) : null;
        const esFutura = fechaJ && fechaJ >= hoy;
        const esAdmin = currentUser === ADMIN_EMAIL;
        const esHostJuntada = usuario && esHostDe(j.Host, usuario.Nombre);
        const puedeEditar = esFutura ? esHostJuntada : esAdmin;

        const driveLink = getDriveLink(j);
        const driveBtn = driveLink ? `
            <a href="${driveLink}" target="_blank"
               style="display:flex;align-items:center;justify-content:center;gap:10px;margin-top:20px;padding:14px;border-radius:12px;background:rgba(66,133,244,0.15);border:2px solid #4285F4;color:#4285F4;font-size:15px;font-weight:bold;text-decoration:none;">
                ğŸ“ Ver o subir fotos en Google Drive
            </a>` : '';

        const botonesAdmin = puedeEditar ? `
            <div style="display:flex;gap:10px;margin-top:15px;">
                <button onclick="abrirModalEditarJuntada(${index})" style="flex:1;background:rgba(255,215,0,0.15);border:2px solid #FFD700;color:#FFD700;padding:12px;border-radius:10px;font-size:14px;font-weight:bold;cursor:pointer;">âœï¸ Editar</button>
                <button onclick="confirmarEliminar(${index})" style="flex:1;background:rgba(244,67,54,0.15);border:2px solid #f44336;color:#f44336;padding:12px;border-radius:10px;font-size:14px;font-weight:bold;cursor:pointer;">ğŸ—‘ï¸ Eliminar</button>
            </div>` : '';

        document.getElementById('juntadaDetalleContent').innerHTML = `
            <div style="background:linear-gradient(135deg,#1e1e3f 0%,#2a2a4f 100%);padding:30px;border-radius:20px;margin-top:60px;border:2px solid rgba(139,77,143,0.5);">
                ${j['Foto Juntada']||j['Foto']?`<div style="width:100%;margin:0 auto 25px;border-radius:15px;overflow:hidden;border:3px solid #C8A830;"><img src="${j['Foto Juntada']||j['Foto']}" style="width:100%;max-height:400px;object-fit:contain;background:#0a0614;display:block;"></div>`:''}
                <div style="text-align:center;margin-bottom:25px;">
                    <div style="color:#FFD700;font-size:14px;font-weight:bold;margin-bottom:10px;">${j.Fecha||'Fecha'}</div>
                    <div style="color:white;font-size:24px;font-weight:bold;margin-bottom:10px;">${j.DescripciÃ³n||j.Descripcion||'Juntada'}</div>
                    <div style="color:rgba(255,255,255,0.7);font-size:14px;margin-bottom:5px;">ğŸ  Host: ${j.Host||'Sin host'}</div>
                    ${j.CategorÃ­a||j.Categoria?`<div style="color:rgba(255,255,255,0.7);font-size:14px;margin-bottom:5px;">ğŸ·ï¸ ${j.CategorÃ­a||j.Categoria}</div>`:''}
                    <div style="color:#FFD700;font-size:18px;font-weight:bold;margin-top:10px;">ğŸ‘¥ ${asistentes.length} Asistentes</div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:15px;margin-top:25px;">
                    ${asistentes.map(n=>`
                        <div style="text-align:center;cursor:pointer;" onclick="verPerfilCulposo('${n}')">
                            <div style="width:70px;height:70px;border-radius:50%;background-image:url('${FOTOS[n]}');background-size:cover;background-position:center;margin:0 auto 8px;border:3px solid #FFD700;"></div>
                            <div style="color:white;font-size:12px;font-weight:bold;">${n}</div>
                        </div>`).join('')}
                </div>
                ${driveBtn}
                ${botonesAdmin}
            </div>`;

        document.getElementById('juntadaDetalle').style.display = 'block';
    }

    function cerrarDetalle() { document.getElementById('juntadaDetalle').style.display = 'none'; }

    function confirmarEliminar(index) {
        const j = juntadasData[index];
        if (confirm(`Â¿Seguro que querÃ©s eliminar "${j.DescripciÃ³n||j.Descripcion||'esta juntada'}" del ${j.Fecha}?`)) eliminarJuntada(index);
    }

    async function eliminarJuntada(index) {
        try {
            const r = await fetch(APPS_SCRIPT_URL, { method:'POST', body:JSON.stringify({ accion:'eliminar_juntada', fila:index+2 }) });
            const res = await r.json();
            if (res.success) { alert('âœ… Juntada eliminada'); cerrarDetalle(); await recargarJuntadas(); renderHome(); renderJuntadas(); }
            else alert('âŒ Error: ' + res.error);
        } catch { alert('âŒ Error de conexiÃ³n'); }
    }

    function abrirModalEditarJuntada(index) {
        cerrarDetalle();
        const j = juntadasData[index];
        window.editandoIndex = index;
        let fechaInput = '';
        if (j.Fecha) { const p = j.Fecha.split('/'); if (p.length===3) fechaInput=`${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`; }
        const hostOptions = CULPOSOS_HOSTS.map(n=>`<option value="${n}" ${j.Host===n?'selected':''}>${n}</option>`).join('');
        const catActual = j.CategorÃ­a||j.Categoria||'';
        const catOptions = CATEGORIAS.map(c=>`<option value="${c}" ${catActual===c?'selected':''}>${c}</option>`).join('');

        document.getElementById('modalEditarContent').innerHTML = `
            <div style="background:linear-gradient(135deg,#1e1e3f 0%,#2a2a4f 100%);padding:30px;border-radius:20px;margin-top:60px;border:2px solid rgba(139,77,143,0.5);">
                <div style="text-align:center;margin-bottom:25px;"><div style="font-size:28px;margin-bottom:8px;">âœï¸</div><div style="color:#FFD700;font-size:22px;font-weight:bold;">Editar Juntada</div></div>
                <div style="margin-bottom:15px;"><label style="color:rgba(255,255,255,0.9);font-size:14px;display:block;margin-bottom:8px;">ğŸ“… Fecha</label><input type="date" id="editFecha" value="${fechaInput}" style="width:100%;padding:12px;border-radius:8px;border:2px solid rgba(139,77,143,0.3);background:rgba(30,30,63,0.5);color:white;font-size:14px;"></div>
                <div style="margin-bottom:15px;"><label style="color:rgba(255,255,255,0.9);font-size:14px;display:block;margin-bottom:8px;">ğŸ  Host</label><select id="editHost" class="form-select">${hostOptions}</select></div>
                <div style="margin-bottom:15px;"><label style="color:rgba(255,255,255,0.9);font-size:14px;display:block;margin-bottom:8px;">ğŸ“ DescripciÃ³n</label><input type="text" id="editDescripcion" value="${j.DescripciÃ³n||j.Descripcion||''}" style="width:100%;padding:12px;border-radius:8px;border:2px solid rgba(139,77,143,0.3);background:rgba(30,30,63,0.5);color:white;font-size:14px;"></div>
                <div style="margin-bottom:20px;"><label style="color:rgba(255,255,255,0.9);font-size:14px;display:block;margin-bottom:8px;">ğŸ·ï¸ CategorÃ­a</label><select id="editCategoria" class="form-select"><option value="">Sin categorÃ­a</option>${catOptions}</select></div>
                <button onclick="enviarEdicion()" style="width:100%;background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);border:none;color:#1E1E3F;padding:15px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;">ğŸ’¾ Guardar cambios</button>
                <div id="mensajeEdicion" style="margin-top:15px;text-align:center;display:none;"></div>
            </div>`;
        document.getElementById('modalEditarJuntada').style.display = 'block';
    }

    function cerrarModalEditarJuntada() { document.getElementById('modalEditarJuntada').style.display = 'none'; }

    async function enviarEdicion() {
        const fecha = document.getElementById('editFecha').value;
        const host = document.getElementById('editHost').value;
        const descripcion = document.getElementById('editDescripcion').value;
        const categoria = document.getElementById('editCategoria').value;
        const msg = document.getElementById('mensajeEdicion');
        if (!fecha||!host||!descripcion) { msg.style.display='block'; msg.innerHTML='<div style="color:#f44336;">âš ï¸ CompletÃ¡ todos los campos</div>'; return; }
        const [y,m,d] = fecha.split('-');
        msg.style.display='block'; msg.innerHTML='<div style="color:#FFD700;">â³ Guardando...</div>';
        try {
            const r = await fetch(APPS_SCRIPT_URL, { method:'POST', body:JSON.stringify({ accion:'editar_juntada', fila:window.editandoIndex+2, fecha:`${d}/${m}/${y}`, host, descripcion, categoria }) });
            const res = await r.json();
            if (res.success) { msg.innerHTML='<div style="color:#4CAF50;font-weight:bold;">âœ… Â¡Juntada actualizada!</div>'; setTimeout(async()=>{ cerrarModalEditarJuntada(); await recargarJuntadas(); renderHome(); renderJuntadas(); }, 1500); }
            else msg.innerHTML=`<div style="color:#f44336;">âŒ Error: ${res.error}</div>`;
        } catch { msg.innerHTML='<div style="color:#f44336;">âŒ Error de conexiÃ³n</div>'; }
    }

    function abrirModalConfirmar(indexJuntada) {
        const j = juntadasData[indexJuntada];
        const usuario = getUsuarioActual();
        if (!usuario) return;
        window.proximaJuntadaIndex = indexJuntada;
        const culpososOriginales = ['Mateo','Rama','Tirri','Toti','Toto','CaamaÃ±o','Zabala','Santi'];
        const confirmados = [], noConfirmados = [];
        let culpososConf = 0;
        culpososData.forEach(c => {
            const val = j[c.Nombre];
            if (esConfirmadoPositivo(val)) { confirmados.push(c.Nombre); if (culpososOriginales.includes(c.Nombre)) culpososConf++; }
            else if (esConfirmadoNegativo(val)) noConfirmados.push(c.Nombre);
        });
        const hayQuorum = culpososConf >= 4;
        const miVal = j[usuario.Nombre];
        const yaConfirme = estaConfirmado(miVal);
        const confirmePos = esConfirmadoPositivo(miVal);
        let botonesHTML = '';
        if (yaConfirme) {
            botonesHTML = confirmePos
                ? `<div style="text-align:center;padding:20px;background:rgba(76,175,80,0.2);border-radius:12px;border:2px solid #4CAF50;"><div style="font-size:32px;margin-bottom:8px;">âœ…</div><div style="font-size:18px;font-weight:bold;color:#4CAF50;margin-bottom:4px;">Â¡Ya confirmaste asistencia!</div><div style="font-size:13px;color:rgba(255,255,255,0.6);margin-bottom:12px;">Los culposos te esperan ğŸ”¥</div><button onclick="mostrarEdicion()" style="background:rgba(255,255,255,0.15);border:2px solid #FFD700;color:#FFD700;padding:10px 22px;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;">âœï¸ Editar respuesta</button></div>`
                : `<div style="text-align:center;padding:20px;background:rgba(244,67,54,0.2);border-radius:12px;border:2px solid #f44336;"><div style="font-size:32px;margin-bottom:8px;">âŒ</div><div style="font-size:18px;font-weight:bold;color:#f44336;margin-bottom:4px;">Me abstuve â€” no voy</div><div style="font-size:13px;color:rgba(255,255,255,0.6);margin-bottom:12px;">Los trolos se abstuvieron. Saludos!</div><button onclick="mostrarEdicion()" style="background:rgba(255,255,255,0.15);border:2px solid #FFD700;color:#FFD700;padding:10px 22px;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;">âœï¸ Editar respuesta</button></div>`;
        } else {
            botonesHTML = `<div style="color:white;font-size:18px;font-weight:bold;text-align:center;margin-bottom:15px;">Â¿Vas a asistir?</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <button onclick="confirmarAsistencia(true)" style="background:linear-gradient(135deg,#4CAF50 0%,#45a049 100%);border:none;color:white;padding:15px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;">âœ… ASISTIRÃ‰</button>
                    <button onclick="confirmarAsistencia(false)" style="background:linear-gradient(135deg,#f44336 0%,#d32f2f 100%);border:none;color:white;padding:15px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;">âŒ NO ASISTIRÃ‰</button>
                </div>
                <div style="text-align:center;margin-top:10px;color:rgba(255,255,255,0.4);font-size:11px;font-style:italic;">(trolos abstenerse)</div>`;
        }
        document.getElementById('modalConfirmarContent').innerHTML = `
            <div style="background:linear-gradient(135deg,#1e1e3f 0%,#2a2a4f 100%);padding:30px;border-radius:20px;margin-top:60px;border:2px solid rgba(139,77,143,0.5);">
                <div style="text-align:center;margin-bottom:25px;">
                    <div style="color:#FFD700;font-size:14px;font-weight:bold;margin-bottom:10px;">${j.Fecha}</div>
                    <div style="color:white;font-size:24px;font-weight:bold;margin-bottom:10px;">${j.DescripciÃ³n||j.Descripcion}</div>
                    <div style="color:rgba(255,255,255,0.7);font-size:14px;">ğŸ  ${j.Host||'Sin host'}</div>
                </div>
                <div style="background:${hayQuorum?'rgba(76,175,80,0.15)':'rgba(139,77,143,0.15)'};padding:15px;border-radius:10px;margin-bottom:20px;border:2px solid ${hayQuorum?'#4CAF50':'rgba(139,77,143,0.5)'};">
                    <div style="text-align:center;">
                        <div style="font-size:12px;color:rgba(255,255,255,0.7);margin-bottom:5px;text-transform:uppercase;">Confirmaciones</div>
                        <div style="font-size:28px;font-weight:bold;color:${hayQuorum?'#4CAF50':'#FFD700'};">${confirmados.length}/${culpososData.length}</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.6);margin-top:5px;">Culposos: ${culpososConf}/8 ${hayQuorum?'âœ… Hay quorum':'â³ Sin quorum'}</div>
                    </div>
                </div>
                <div style="margin:25px 0;">${botonesHTML}</div>
                ${confirmados.length>0||noConfirmados.length>0?`
                    <div style="margin-top:25px;padding-top:25px;border-top:1px solid rgba(255,255,255,0.2);">
                        ${confirmados.length>0?`<div style="margin-bottom:15px;"><div style="color:#4CAF50;font-size:14px;font-weight:bold;margin-bottom:8px;">âœ… Confirmaron (${confirmados.length}):</div><div style="color:rgba(255,255,255,0.8);font-size:13px;">${confirmados.join(', ')}</div></div>`:''}
                        ${noConfirmados.length>0?`<div><div style="color:#f44336;font-size:14px;font-weight:bold;margin-bottom:8px;">âŒ No asisten (${noConfirmados.length}):</div><div style="color:rgba(255,255,255,0.8);font-size:13px;">${noConfirmados.join(', ')}</div></div>`:''}
                    </div>`:''}
                <div id="mensajeConfirmacion" style="margin-top:15px;text-align:center;display:none;"></div>
            </div>`;
        document.getElementById('modalConfirmar').style.display = 'block';
    }

    function mostrarEdicion() {
        document.getElementById('mensajeConfirmacion').style.display = 'block';
        document.getElementById('mensajeConfirmacion').innerHTML = `
            <div style="background:rgba(139,77,143,0.2);padding:15px;border-radius:10px;">
                <div style="color:white;font-size:14px;font-weight:bold;margin-bottom:10px;">Cambiar respuesta:</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <button onclick="confirmarAsistencia(true)" style="background:linear-gradient(135deg,#4CAF50 0%,#45a049 100%);border:none;color:white;padding:12px;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;">âœ… VOY</button>
                    <button onclick="confirmarAsistencia(false)" style="background:linear-gradient(135deg,#f44336 0%,#d32f2f 100%);border:none;color:white;padding:12px;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;">âŒ NO VOY</button>
                </div>
            </div>`;
    }

    function cerrarModalConfirmar() { document.getElementById('modalConfirmar').style.display = 'none'; }

    async function confirmarAsistencia(asistira) {
        const msg = document.getElementById('mensajeConfirmacion');
        msg.style.display='block'; msg.innerHTML='<div style="color:#FFD700;">â³ Guardando...</div>';
        try {
            const r = await fetch(APPS_SCRIPT_URL, { method:'POST', body:JSON.stringify({ email:currentUser, fila:window.proximaJuntadaIndex+2, asistira }) });
            const res = await r.json();
            if (res.success) {
                msg.innerHTML=`<div style="color:#4CAF50;font-weight:bold;">âœ… ${res.mensaje||'ConfirmaciÃ³n guardada'}</div>`;
                setTimeout(async()=>{ await recargarJuntadas(); abrirModalConfirmar(window.proximaJuntadaIndex); renderHome(); }, 800);
            } else msg.innerHTML=`<div style="color:#f44336;">âŒ Error: ${res.error}</div>`;
        } catch { msg.innerHTML='<div style="color:#f44336;">âŒ Error de conexiÃ³n</div>'; }
    }

    async function recargarJuntadas() {
        const r = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Hoja%201`);
        juntadasData = parseCSV(await r.text());
    }

    function abrirModalProponerJuntada() {
        const hostOptions = CULPOSOS_HOSTS.map(n=>`<option value="${n}">${n}</option>`).join('');
        const catOptions = CATEGORIAS.map(c=>`<option value="${c}">${c}</option>`).join('');
        document.getElementById('modalProponerContent').innerHTML = `
            <div style="background:linear-gradient(135deg,#1e1e3f 0%,#2a2a4f 100%);padding:30px;border-radius:20px;margin-top:60px;border:2px solid rgba(139,77,143,0.5);">
                <div style="text-align:center;margin-bottom:25px;"><div style="font-size:32px;margin-bottom:10px;">ğŸ‰</div><div style="color:#FFD700;font-size:24px;font-weight:bold;">Proponer Juntada</div></div>
                <div style="margin-bottom:15px;"><label style="color:rgba(255,255,255,0.9);font-size:14px;display:block;margin-bottom:8px;">ğŸ“… Fecha</label><input type="date" id="propFecha" style="width:100%;padding:12px;border-radius:8px;border:2px solid rgba(139,77,143,0.3);background:rgba(30,30,63,0.5);color:white;font-size:14px;"></div>
                <div style="margin-bottom:15px;"><label style="color:rgba(255,255,255,0.9);font-size:14px;display:block;margin-bottom:8px;">ğŸ  Host</label><select id="propHost" class="form-select"><option value="">Seleccionar...</option>${hostOptions}</select></div>
                <div style="margin-bottom:15px;"><label style="color:rgba(255,255,255,0.9);font-size:14px;display:block;margin-bottom:8px;">ğŸ“ DescripciÃ³n</label><input type="text" id="propDescripcion" placeholder="Ej: Asado en lo de..." style="width:100%;padding:12px;border-radius:8px;border:2px solid rgba(139,77,143,0.3);background:rgba(30,30,63,0.5);color:white;font-size:14px;"></div>
                <div style="margin-bottom:20px;"><label style="color:rgba(255,255,255,0.9);font-size:14px;display:block;margin-bottom:8px;">ğŸ·ï¸ CategorÃ­a</label><select id="propCategoria" class="form-select"><option value="">Sin categorÃ­a</option>${catOptions}</select></div>
                <button onclick="enviarPropuesta()" style="width:100%;background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);border:none;color:#1E1E3F;padding:15px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;">ğŸš€ Proponer</button>
                <div id="mensajePropuesta" style="margin-top:15px;text-align:center;display:none;"></div>
            </div>`;
        document.getElementById('modalProponerJuntada').style.display = 'block';
    }

    function cerrarModalProponerJuntada() { document.getElementById('modalProponerJuntada').style.display = 'none'; }

    async function enviarPropuesta() {
        const fecha=document.getElementById('propFecha').value, host=document.getElementById('propHost').value;
        const desc=document.getElementById('propDescripcion').value, cat=document.getElementById('propCategoria').value;
        const msg=document.getElementById('mensajePropuesta');
        if (!fecha||!host||!desc) { msg.style.display='block'; msg.innerHTML='<div style="color:#f44336;">âš ï¸ CompletÃ¡ fecha, host y descripciÃ³n</div>'; return; }
        const [y,m,d]=fecha.split('-');
        msg.style.display='block'; msg.innerHTML='<div style="color:#FFD700;">â³ Creando juntada...</div>';
        try {
            const r=await fetch(APPS_SCRIPT_URL,{method:'POST',body:JSON.stringify({accion:'crear_juntada',fecha:`${d}/${m}/${y}`,host,descripcion:desc,categoria:cat})});
            const res=await r.json();
            if (res.success) { msg.innerHTML='<div style="color:#4CAF50;font-weight:bold;">âœ… Â¡Juntada propuesta!</div>'; setTimeout(()=>{ cerrarModalProponerJuntada(); location.reload(); },2000); }
            else msg.innerHTML=`<div style="color:#f44336;">âŒ Error: ${res.error}</div>`;
        } catch { msg.innerHTML='<div style="color:#f44336;">âŒ Error de conexiÃ³n</div>'; }
    }

    function renderPerfil() { renderPerfilCulposo(null); }

    function renderPerfilCulposo(nombreCulposo) {
        const esMio = !nombreCulposo;
        const usuario = esMio ? getUsuarioActual() : culpososData.find(c=>c.Nombre===nombreCulposo);
        if (!usuario) { document.getElementById('perfilData').innerHTML=`<div class="card"><p style="color:rgba(255,255,255,0.7);">No se encontrÃ³ el perfil.</p></div>`; return; }
        const pct = parseFloat(usuario.Porcentaje).toFixed(0);
        const isPerfecto = pct==100;
        let col='#f44336';
        if(pct>=100)col='#4CAF50';else if(pct>=90)col='#8BC34A';else if(pct>=60)col='#FFD700';else if(pct>=35)col='#FF9800';
        const premios=premiosData.filter(p=>p.Ganador&&p.Ganador.trim()===usuario.Nombre&&p.Tipo==='Persona');
        const oro=premios.filter(p=>p.Terna&&p.Terna.includes('CULPOSO DE ORO'));
        const otros=premios.filter(p=>p.Terna&&!p.Terna.includes('CULPOSO DE ORO'));
        const premiosHTML=premios.length>0?`<div class="section-title" style="margin-top:25px;">ğŸ† PalmarÃ©s</div><div class="card" style="padding:20px;">${oro.map(p=>`<div style="margin:12px 0;padding:12px;background:rgba(255,215,0,0.15);border-radius:8px;"><span style="font-size:18px;font-weight:bold;color:#FFD700;">ğŸ† CULPOSO DE ORO (${p.AÃ±o||''})</span></div>`).join('')}${otros.map(p=>`<div style="margin:8px 0;color:rgba(255,255,255,0.9);">ğŸ¥‡ <span style="text-transform:uppercase;font-weight:bold;">${p.Terna||'PREMIO'} (${p.AÃ±o||''})</span></div>`).join('')}</div>`:'' ;
        const fotoUrl=FOTOS[usuario.Nombre]||'';
        const usuarioLogueado=getUsuarioActual();
        const esMiPerfil=usuarioLogueado&&usuarioLogueado.Nombre===usuario.Nombre;
        const r=calcularRacha(usuario.Nombre);
        const rachaCard=r>=10?`<div class="card" style="background:linear-gradient(135deg,rgba(255,100,0,0.15) 0%,rgba(255,60,0,0.05) 100%);border-left-color:#FF6600;"><div style="display:flex;align-items:center;gap:12px;"><div style="font-size:36px;">ğŸ”¥</div><div><div class="card-title" style="color:#FF6600;">Â¡${r} EN RACHA!</div><div class="card-details">${esMiPerfil?'Llevas':'Lleva'} ${r} juntadas seguidas sin faltar.</div></div></div></div>`:r>=5?`<div class="card" style="background:linear-gradient(135deg,rgba(204,153,0,0.15) 0%,rgba(204,153,0,0.05) 100%);border-left-color:#CC9900;"><div style="display:flex;align-items:center;gap:12px;"><div style="font-size:36px;">âš¡</div><div><div class="card-title" style="color:#CC9900;">Â¡${r} en racha!</div><div class="card-details">${esMiPerfil?'Llevas':'Lleva'} ${r} juntadas seguidas.</div></div></div></div>`:'';
        document.getElementById('perfilData').innerHTML=`
            ${!esMiPerfil?`<div style="text-align:center;margin-bottom:15px;"><button onclick="renderPerfil()" style="background:rgba(139,77,143,0.3);border:2px solid #8B4D8F;color:#FFD700;padding:8px 15px;border-radius:10px;font-size:12px;font-weight:bold;cursor:pointer;">â† Volver a mi perfil</button></div>`:''}
            ${fotoUrl?`<div style="text-align:center;margin-bottom:20px;"><img src="${fotoUrl}" style="width:100px;height:100px;border-radius:50%;border:3px solid #C8A830;object-fit:cover;object-position:center top;"></div>`:''}
            <div class="card" style="border-left-color:${isPerfecto?'#FFD700':'#8B4D8F'};"><div class="card-title" style="font-size:24px;">${usuario.Nombre}</div></div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-number" style="color:${col};">${usuario.Asistencias}/${usuario['Total Juntadas']}</div><div class="stat-label">Asistencias</div></div>
                <div class="stat-card"><div class="stat-number" style="color:${col};">${pct}%</div><div class="stat-label">Porcentaje</div></div>
            </div>
            ${isPerfecto?`<div class="card" style="background:linear-gradient(135deg,rgba(255,215,0,0.1) 0%,rgba(255,215,0,0.05) 100%);border-left-color:#FFD700;"><div class="card-title">ğŸ† Â¡CULPOSO PERFECTO!</div><div class="card-details">${esMiPerfil?'No te perdiste ninguna juntada. Sos un crack.':'No se perdiÃ³ ninguna juntada. Un verdadero crack.'}</div></div>`:''}
            ${rachaCard}
            ${renderHostPanel(usuario.Nombre)}
            ${premiosHTML}
            ${esMiPerfil?`
            <div class="section-title">ğŸ“… Mi ParticipaciÃ³n</div>
            <div class="card" onclick="showTab('juntadas',document.querySelectorAll('.tab')[2])" style="cursor:pointer;text-align:center;background:linear-gradient(135deg,rgba(139,77,143,0.2) 0%,rgba(139,77,143,0.1) 100%);">
                <div class="card-title" style="color:#FFD700;font-size:16px;">ğŸ“Š Ver todas mis juntadas â†’</div>
                <div class="card-details" style="margin-top:5px;">RevisÃ¡ tu historial completo de asistencias</div>
            </div>
            <div class="card" style="margin-top:10px;text-align:center;background:linear-gradient(135deg,rgba(107,45,145,0.15) 0%,rgba(74,29,107,0.1) 100%);">
                <div style="color:rgba(255,255,255,0.7);font-size:12px;margin-bottom:10px;">ğŸ”” Notificaciones de nueva juntada</div>
                <button id="btnNotif" onclick="activarNotificaciones()" style="background:linear-gradient(135deg,#6B2D91 0%,#4A1D6B 100%);border:2px solid #C8A830;color:#C8A830;padding:10px 20px;border-radius:10px;font-size:13px;font-weight:bold;cursor:pointer;">Activar notificaciones</button>
                <div id="notifStatus" style="margin-top:8px;font-size:12px;color:rgba(255,255,255,0.5);"></div>
            </div>`:''}`;
    }

    function renderHostPanel(nombre) {
        const hoy = new Date(); hoy.setHours(0,0,0,0);
        const hosteadas = juntadasData.filter(j => {
            if (!j.Host || !esHostDe(j.Host, nombre) || !j.Fecha) return false;
            const f = parseFecha(j.Fecha);
            return f && f < hoy && tieneQuorum(j);
        });
        if (!hosteadas.length) return '';
        const cards = hosteadas.slice().reverse().map(j => {
            const ri = juntadasData.indexOf(j);
            const foto = j['Foto Juntada']||j['Foto juntada']||'';
            return `<div onclick="verDetalleJuntada(${ri})" style="cursor:pointer;background:linear-gradient(135deg,#1e1e3f 0%,#2a2a4f 100%);border-radius:12px;overflow:hidden;border:2px solid rgba(139,77,143,0.3);transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
                ${foto?`<div style="overflow:hidden;"><img src="${foto}" style="width:100%;height:90px;object-fit:cover;display:block;"></div>`:`<div style="height:80px;background:linear-gradient(135deg,rgba(139,77,143,0.3),rgba(107,56,112,0.3));display:flex;align-items:center;justify-content:center;font-size:28px;">ğŸ </div>`}
                <div style="padding:10px;"><div style="color:#FFD700;font-size:10px;font-weight:bold;">${j.Fecha||''}</div><div style="color:white;font-size:12px;font-weight:bold;margin-top:3px;line-height:1.3;">${j.DescripciÃ³n||j.Descripcion||'Juntada'}</div><div style="color:rgba(255,255,255,0.5);font-size:11px;margin-top:4px;">ğŸ‘¥ ${j['NÂ° Asist']||'0'}</div></div>
            </div>`;
        }).join('');
        return `<div class="section-title" style="margin-top:25px;">ğŸ  Host (${hosteadas.length})</div><div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:10px;">${cards}</div>`;
    }

    function verPerfilCulposo(nombre) {
        cerrarDetalle();
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.tab')[5].classList.add('active');
        document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
        document.getElementById('perfil').classList.add('active');
        renderPerfilCulposo(nombre);
    }

    function renderAwards() {
        const year=document.getElementById('yearFilter').value;
        const filtrados=premiosData.filter(p=>p.AÃ±o==year);
        const oro=filtrados.filter(p=>p.Tipo==='Persona'&&p.Terna&&p.Terna.toUpperCase().includes('CULPOSO DE ORO'));
        const individuales=filtrados.filter(p=>p.Tipo==='Persona'&&p.Terna&&!p.Terna.toUpperCase().includes('CULPOSO DE ORO'));
        const juntadas=filtrados.filter(p=>p.Tipo==='Juntada');
        let html='';
        oro.forEach(p=>{ const f=FOTOS[p.Ganador]||''; html+=`<div style="background:linear-gradient(135deg,rgba(255,215,0,0.2) 0%,rgba(255,215,0,0.05) 100%);padding:30px;border-radius:20px;margin-bottom:30px;border:3px solid #FFD700;text-align:center;">${f?`<img src="${f}" onclick="verPerfilCulposo('${p.Ganador}')" style="width:100px;height:100px;border-radius:50%;border:4px solid #FFD700;object-fit:cover;object-position:center top;margin-bottom:15px;cursor:pointer;">`:''}<div style="font-size:40px;margin-bottom:10px;">ğŸ†</div><div style="color:#FFD700;font-size:24px;font-weight:bold;margin-bottom:10px;">CULPOSO DE ORO ${year}</div><div onclick="verPerfilCulposo('${p.Ganador}')" style="color:white;font-size:28px;font-weight:bold;cursor:pointer;">${p.Ganador||'Sin ganador'}</div></div>`; });
        if(individuales.length>0){ html+='<div class="section-title" style="margin-top:25px;">ğŸ¥‡ Premios Individuales</div>';
            individuales.forEach(p=>{ const f=FOTOS[p.Ganador]||''; html+=`<div onclick="verPerfilCulposo('${p.Ganador}')" style="background:linear-gradient(135deg,#160D2E 0%,#1E1040 100%);border-radius:12px;border:2px solid rgba(107,45,145,0.4);padding:14px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:transform 0.2s;margin-bottom:10px;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'"><div style="width:52px;height:52px;min-width:52px;border-radius:50%;border:2px solid #C8A830;overflow:hidden;flex-shrink:0;"><img src="${f||'https://i.imgur.com/czObXpX.png'}" style="width:100%;height:100%;object-fit:cover;object-position:center top;display:block;"></div><div style="flex:1;min-width:0;"><div style="color:#C8A830;font-size:11px;font-weight:bold;text-transform:uppercase;letter-spacing:0.5px;">${p.Terna||'Premio'}</div><div style="color:white;font-size:15px;font-weight:bold;margin-top:3px;">${p.Ganador||'Sin ganador'}</div></div></div>`; }); }
        if(juntadas.length>0){ html+='<div class="section-title" style="margin-top:25px;">ğŸ‰ Mejores Juntadas</div>'; juntadas.forEach(p=>{ html+=`<div class="card"><div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;"><div style="font-size:24px;">ğŸ†</div><div style="color:#FFD700;font-size:14px;font-weight:bold;text-transform:uppercase;flex:1;">${p.Terna||'Premio'}</div></div><div style="color:white;font-size:16px;font-weight:bold;">${p.Ganador||'Sin ganador'}</div></div>`; }); }
        if(!html) html=`<p style="color:rgba(255,255,255,0.6);text-align:center;padding:40px;">No hay premios registrados para ${year}</p>`;
        document.getElementById('awardsList').innerHTML=html;
    }

    let gastosArray=[];
    const TODOS_NOMBRES=['Toto','CaamaÃ±o','Rama','Zabala','Santi','Mateo','Tirri','Toti','Cata','Lola','Sami','Leila','Juli','Manu','Matu'];

    function getAlias(nombre) { const c=culpososData.find(x=>x.Nombre===nombre); return c&&c.Alias?c.Alias:''; }

    function agregarGasto() { gastosArray.push({id:Date.now(),quien:'',concepto:'',monto:0,consumidores:[]}); renderGastos(); }
    function eliminarGasto(id) { gastosArray=gastosArray.filter(g=>g.id!==id); renderGastos(); }
    function toggleTodos(idx) { const todos=gastosArray[idx].consumidores.length===TODOS_NOMBRES.length; gastosArray[idx].consumidores=todos?[]:[...TODOS_NOMBRES]; renderGastos(); }

    function renderGastos() {
        const c=document.getElementById('gastosContainer');
        if(!gastosArray.length){ c.innerHTML=`<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.6);"><div style="font-size:48px;margin-bottom:15px;">ğŸ’¸</div><div>No hay gastos agregados</div></div>`; return; }
        c.innerHTML=gastosArray.map((g,idx)=>`
            <div class="card" style="margin-bottom:20px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;"><div style="color:#FFD700;font-weight:bold;">Gasto ${idx+1}</div><button onclick="eliminarGasto(${g.id})" style="background:rgba(244,67,54,0.2);border:2px solid #f44336;color:#f44336;padding:5px 10px;border-radius:5px;font-size:12px;cursor:pointer;">âœ• Eliminar</button></div>
                <div style="margin-bottom:10px;"><label style="color:rgba(255,255,255,0.8);font-size:13px;display:block;margin-bottom:5px;">Â¿QuiÃ©n pagÃ³?</label><select onchange="gastosArray[${idx}].quien=this.value" class="form-select"><option value="">Seleccionar...</option>${TODOS_NOMBRES.map(n=>`<option value="${n}" ${g.quien===n?'selected':''}>${n}</option>`).join('')}</select></div>
                <div style="margin-bottom:10px;"><label style="color:rgba(255,255,255,0.8);font-size:13px;display:block;margin-bottom:5px;">Concepto</label><input type="text" value="${g.concepto}" oninput="gastosArray[${idx}].concepto=this.value" placeholder="Ej: Carne, Pan..." style="width:100%;padding:10px;border-radius:8px;border:2px solid rgba(139,77,143,0.3);background:rgba(30,30,63,0.5);color:white;font-size:14px;"></div>
                <div style="margin-bottom:10px;"><label style="color:rgba(255,255,255,0.8);font-size:13px;display:block;margin-bottom:5px;">Monto ($)</label><input type="number" value="${g.monto||''}" oninput="gastosArray[${idx}].monto=parseFloat(this.value)||0" placeholder="0" style="width:100%;padding:10px;border-radius:8px;border:2px solid rgba(139,77,143,0.3);background:rgba(30,30,63,0.5);color:white;font-size:14px;"></div>
                <div><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><label style="color:rgba(255,255,255,0.8);font-size:13px;">Â¿QuiÃ©nes consumen/usan?</label><button onclick="toggleTodos(${idx})" style="background:rgba(255,215,0,0.15);border:2px solid #FFD700;color:#FFD700;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:bold;cursor:pointer;">${g.consumidores.length===TODOS_NOMBRES.length?"â˜ Ninguno":"â˜‘ï¸ Todos"}</button></div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">${TODOS_NOMBRES.map(n=>`<label style="display:flex;align-items:center;gap:6px;color:rgba(255,255,255,0.9);font-size:13px;cursor:pointer;"><input type="checkbox" ${g.consumidores.includes(n)?'checked':''} onchange="if(this.checked){if(!gastosArray[${idx}].consumidores.includes('${n}'))gastosArray[${idx}].consumidores.push('${n}');}else{gastosArray[${idx}].consumidores=gastosArray[${idx}].consumidores.filter(x=>x!=='${n}');}" style="cursor:pointer;">${n}</label>`).join('')}</div></div>
            </div>`).join('');
    }

    function calcularDivision() {
        const res=document.getElementById('resultadoCalculo');
        if(!gastosArray.length){res.innerHTML='<div class="card" style="background:rgba(244,67,54,0.2);border-left-color:#f44336;"><div style="color:#f44336;">âš ï¸ No hay gastos para calcular</div></div>';return;}
        for(let g of gastosArray){if(!g.quien||!g.concepto||g.monto<=0||!g.consumidores.length){res.innerHTML='<div class="card" style="background:rgba(244,67,54,0.2);border-left-color:#f44336;"><div style="color:#f44336;">âš ï¸ CompletÃ¡ todos los campos</div></div>';return;}}
        const bal={};
        TODOS_NOMBRES.forEach(n=>bal[n]=0);
        gastosArray.forEach(g=>{ const cpp=g.monto/g.consumidores.length; g.consumidores.forEach(c=>bal[c]-=cpp); bal[g.quien]+=g.monto; });
        const deu=[],acr=[];
        Object.entries(bal).forEach(([n,b])=>{ if(Math.abs(b)<1)return; if(b<0)deu.push({n,m:Math.abs(b)}); else acr.push({n,m:b}); });
        const trans=[],dc=[...deu],ac=[...acr];
        while(dc.length&&ac.length){ const d=dc[0],a=ac[0],m=Math.min(d.m,a.m); trans.push({de:d.n,a:a.n,monto:m}); d.m-=m;a.m-=m; if(d.m<1)dc.shift();if(a.m<1)ac.shift(); }
        const total=gastosArray.reduce((s,g)=>s+g.monto,0);
        const acreedores=[...new Set(trans.map(t=>t.a))];
        const aliases=acreedores.map(n=>{const a=getAlias(n);return a?`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);"><span style="color:rgba(255,255,255,0.8);font-weight:bold;">${n}</span><span style="color:#FFD700;">ğŸ’³ ${a}</span></div>`:''}).filter(Boolean).join('');
        res.innerHTML=`<div class="card" style="background:linear-gradient(135deg,rgba(76,175,80,0.15) 0%,rgba(76,175,80,0.05) 100%);border-left-color:#4CAF50;">
            <div style="text-align:center;margin-bottom:20px;"><div style="font-size:14px;color:rgba(255,255,255,0.7);margin-bottom:5px;">TOTAL GASTADO</div><div style="font-size:32px;font-weight:bold;color:#4CAF50;">$${total.toLocaleString('es-AR')}</div></div>
            <div style="border-top:1px solid rgba(255,255,255,0.2);padding-top:15px;"><div style="color:#FFD700;font-weight:bold;margin-bottom:15px;text-align:center;">ğŸ’¸ TRANSFERENCIAS A REALIZAR</div>
            ${trans.map(t=>`<div style="background:rgba(139,77,143,0.2);padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;"><div style="color:white;font-size:14px;"><span style="font-weight:bold;">${t.de}</span> â†’ <span style="font-weight:bold;color:#4CAF50;">${t.a}</span></div><div style="color:#FFD700;font-weight:bold;font-size:16px;">$${Math.round(t.monto).toLocaleString('es-AR')}</div></div>`).join('')}</div>
            ${aliases?`<div style="margin-top:15px;padding:12px;background:rgba(255,215,0,0.08);border-radius:8px;border:1px solid rgba(255,215,0,0.3);"><div style="color:#FFD700;font-size:12px;font-weight:bold;text-transform:uppercase;margin-bottom:8px;">Alias para transferir</div>${aliases}</div>`:''}
            <button onclick="compartirResultado()" style="width:100%;margin-top:15px;background:rgba(37,211,102,0.2);border:2px solid #25D366;color:#25D366;padding:12px;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;">ğŸ“± Compartir por WhatsApp</button>
        </div>`;
    }

    function compartirResultado() {
        const total=gastosArray.reduce((s,g)=>s+g.monto,0);
        let txt=`ğŸ’° *DIVISIÃ“N DE GASTOS - LA CULPA*\n\nTotal: $${total.toLocaleString('es-AR')}\n\n`;
        gastosArray.forEach((g,i)=>{ txt+=`${i+1}. ${g.concepto}: $${g.monto.toLocaleString('es-AR')} (${g.quien})\n`; });
        txt+=`\nğŸ’¸ *TRANSFERENCIAS:*\n`;
        const bal={};TODOS_NOMBRES.forEach(n=>bal[n]=0);
        gastosArray.forEach(g=>{ const cpp=g.monto/g.consumidores.length; g.consumidores.forEach(c=>bal[c]-=cpp); bal[g.quien]+=g.monto; });
        const deu=[],acr=[];
        Object.entries(bal).forEach(([n,b])=>{ if(Math.abs(b)<1)return; if(b<0)deu.push({n,m:Math.abs(b)}); else acr.push({n,m:b}); });
        const dc=[...deu],ac=[...acr],tw=[];
        while(dc.length&&ac.length){ const d=dc[0],a=ac[0],m=Math.min(d.m,a.m); tw.push({de:d.n,a:a.n,monto:m}); d.m-=m;a.m-=m; if(d.m<1)dc.shift();if(a.m<1)ac.shift(); }
        tw.forEach(t=>{ txt+=`${t.de} â†’ ${t.a}: $${Math.round(t.monto).toLocaleString('es-AR')}\n`; });
        const aw=[...new Set(tw.map(t=>t.a))].map(n=>{const a=getAlias(n);return a?`${n}: ğŸ’³ ${a}`:null;}).filter(Boolean);
        if(aw.length) txt+=`\nğŸ’³ *ALIAS:*\n`+aw.join('\n');
        window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`,'_blank');
    }

    function showTab(tabName, el) {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        if(el) el.classList.add('active');
        document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
    }

    const FIREBASE_CONFIG = {
        apiKey:"AIzaSyAamBVJC48CtEd41HtvF5Ek0Bxui5TfsjA",authDomain:"la-culpa.firebaseapp.com",
        projectId:"la-culpa",storageBucket:"la-culpa.firebasestorage.app",
        messagingSenderId:"339936091040",appId:"1:339936091040:web:608ec8df925b088472a2c5"
    };
    const VAPID_KEY = "BLTKtmHW3u6CS-uITlN19AF0IWzlQmOBSwWarERODdaqPZ0jXSoVvhqvz2E64w_Jue5Sa3cazO8gkFHXRfb1Zzs";
    let messagingInstance = null;

    async function initFirebase() {
        try {
            firebase.initializeApp(FIREBASE_CONFIG);
            messagingInstance = firebase.messaging();
            messagingInstance.onMessage(payload => {
                const { title, body } = payload.notification || {};
                if (title) showInAppNotification(title, body);
            });
        } catch(e) { console.warn('Firebase init error:', e); }
    }

    function showInAppNotification(title, body) {
        const el = document.createElement('div');
        el.style.cssText = `position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:9999;background:linear-gradient(135deg,#6B2D91 0%,#4A1D6B 100%);color:white;padding:16px 22px;border-radius:16px;border:2px solid #C8A830;box-shadow:0 8px 30px rgba(0,0,0,0.6);max-width:340px;width:90%;text-align:center;animation:slideDown 0.3s ease;`;
        el.innerHTML = `<div style="font-size:22px;margin-bottom:6px;">ğŸ‰</div><div style="font-weight:bold;color:#FFD700;font-size:15px;margin-bottom:4px;letter-spacing:0.5px;">${title}</div><div style="font-size:13px;opacity:0.85;line-height:1.4;">${body||''}</div>`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 5000);
    }

    async function pedirPermisoNotificaciones() {
        if (!messagingInstance) return;
        try {
            const perm = await Notification.requestPermission();
            if (perm !== 'granted') return;
            let swReg = null;
            if ('serviceWorker' in navigator) {
                swReg = await navigator.serviceWorker.register('/la-culpa-app/firebase-messaging-sw.js');
                await navigator.serviceWorker.ready;
            }
            const tokenOpts = { vapidKey: VAPID_KEY };
            if (swReg) tokenOpts.serviceWorkerRegistration = swReg;
            const token = await messagingInstance.getToken(tokenOpts);
            if (!token) return;
            const saved = localStorage.getItem('fcmToken');
            if (saved === token) return;
            await fetch(APPS_SCRIPT_URL, { method:'POST', body:JSON.stringify({ accion:'guardar_token', email:currentUser, token }) });
            localStorage.setItem('fcmToken', token);
        } catch(e) { console.warn('Error registrando notificaciones:', e); }
    }

    async function activarNotificaciones() {
        const btn = document.getElementById('btnNotif');
        const status = document.getElementById('notifStatus');
        if (btn) btn.disabled = true;
        if (status) status.textContent = 'â³ Registrando...';
        localStorage.removeItem('fcmToken');
        try {
            if (!messagingInstance) throw new Error('Firebase no inicializado');
            const perm = await Notification.requestPermission();
            if (perm !== 'granted') throw new Error('Permiso denegado: ' + perm);
            let swReg = null;
            if ('serviceWorker' in navigator) {
                swReg = await navigator.serviceWorker.register('/la-culpa-app/firebase-messaging-sw.js', { scope:'/la-culpa-app/' });
                await navigator.serviceWorker.ready;
            }
            const tokenOpts = { vapidKey: VAPID_KEY };
            if (swReg) tokenOpts.serviceWorkerRegistration = swReg;
            const token = await messagingInstance.getToken(tokenOpts);
            if (!token) throw new Error('Token vacÃ­o');
            const r = await fetch(APPS_SCRIPT_URL, { method:'POST', body:JSON.stringify({ accion:'guardar_token', email:currentUser, token }) });
            const res = await r.json();
            if (!res.success) throw new Error('Error guardando token');
            localStorage.setItem('fcmToken', token);
            if (btn) { btn.textContent='âœ… Notificaciones activas'; btn.style.borderColor='#4CAF50'; btn.style.color='#4CAF50'; btn.disabled=false; }
            if (status) status.textContent='Este dispositivo va a recibir avisos de nuevas juntadas ğŸ””';
        } catch(e) {
            if (btn) { btn.disabled=false; btn.textContent='Reintentar'; }
            if (status) status.textContent='âŒ ' + e.message;
        }
    }

    window.onload = function() {
        initFirebase();
        const saved = localStorage.getItem('culpaUserEmail');
        if (saved) { document.getElementById('emailInput').value=saved; login(); }
    };
</script>
</body>
</html>
