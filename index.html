<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA CULPA - App</title>
    
    <link rel="icon" type="image/png" href="https://i.imgur.com/tq9wwwK.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/tq9wwwK.png">
    <meta name="theme-color" content="#8B4D8F">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: white; }
        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #8B4D8F 0%, #6B3870 100%); padding: 40px 20px 30px; text-align: center; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .logo { width: 350px; height: 350px; margin: 0 auto 15px; background: url('https://i.imgur.com/tq9wwwK.png') center/contain no-repeat; border-radius: 20px; display: flex; align-items: center; justify-content: center; }
        .title { color: #FFD700; font-size: 32px; font-weight: bold; margin-bottom: 5px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .subtitle { color: rgba(255,255,255,0.9); font-size: 14px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: rgba(30, 30, 63, 0.5); padding: 10px; border-radius: 15px; }
        .tab { flex: 1; padding: 12px; text-align: center; background: transparent; border: 2px solid rgba(139, 77, 143, 0.3); border-radius: 10px; color: rgba(255,255,255,0.6); cursor: pointer; transition: all 0.3s; font-size: 14px; }
        .tab.active { background: linear-gradient(135deg, #8B4D8F 0%, #6B3870 100%); color: #FFD700; border-color: #FFD700; }
        .content { display: none; }
        .content.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .stat-card { background: linear-gradient(135deg, #1e1e3f 0%, #2a2a4f 100%); padding: 20px; border-radius: 15px; text-align: center; border: 2px solid rgba(139, 77, 143, 0.3); }
        .stat-number { font-size: 32px; font-weight: bold; color: #FFD700; margin-bottom: 5px; }
        .stat-label { color: rgba(255,255,255,0.7); font-size: 12px; text-transform: uppercase; }
        .section-title { color: #FFD700; font-size: 18px; font-weight: bold; margin: 25px 0 15px; display: flex; align-items: center; gap: 10px; }
        .card { background: linear-gradient(135deg, #1e1e3f 0%, #2a2a4f 100%); padding: 15px; border-radius: 15px; margin-bottom: 15px; border-left: 4px solid #FFD700; }
        .card-date { color: #FFD700; font-size: 12px; font-weight: bold; margin-bottom: 5px; }
        .card-title { color: white; font-size: 16px; font-weight: bold; margin-bottom: 5px; }
        .card-details { color: rgba(255,255,255,0.6); font-size: 13px; display: flex; gap: 15px; }
        .ranking-item { background: linear-gradient(135deg, #1e1e3f 0%, #2a2a4f 100%); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; border: 2px solid rgba(139, 77, 143, 0.3); }
        .ranking-item.top3 { border-color: #FFD700; }
        .rank-number { font-size: 20px; font-weight: bold; color: #FFD700; min-width: 30px; }
        .rank-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #8B4D8F 0%, #6B3870 100%); display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .rank-info { flex: 1; }
        .rank-name { color: white; font-weight: bold; font-size: 15px; margin-bottom: 3px; }
        .rank-stats { color: rgba(255,255,255,0.6); font-size: 12px; }
        .rank-percentage { font-size: 18px; font-weight: bold; color: #FFD700; }
        .badge { display: inline-block; background: #FFD700; color: #1a1a2e; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; margin-left: 5px; }
        .loading { text-align: center; padding: 40px; color: rgba(255,255,255,0.6); }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #FFD700; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; text-align: center; }
        .login-card { background: linear-gradient(135deg, #1e1e3f 0%, #2a2a4f 100%); padding: 40px; border-radius: 20px; border: 2px solid rgba(139, 77, 143, 0.3); max-width: 400px; width: 100%; }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 2px solid rgba(139, 77, 143, 0.3); background: rgba(30, 30, 63, 0.5); color: white; font-size: 16px; }
        .login-button { width: 100%; padding: 15px; margin-top: 20px; border-radius: 10px; border: none; background: linear-gradient(135deg, #8B4D8F 0%, #6B3870 100%); color: #FFD700; font-size: 16px; font-weight: bold; cursor: pointer; }
        .error-message { color: #ff4444; margin-top: 10px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container" id="app">
        <div id="loginScreen" class="login-screen">
            <div class="header"><div class="logo"></div><div class="title">LA CULPA</div><div class="subtitle">Ranking de Asistencias</div></div>
            <div class="login-card">
                <h2 style="color: #FFD700; margin-bottom: 20px;">Bienvenido, Culposo</h2>
                <input type="email" id="emailInput" class="login-input" placeholder="tu@email.com">
                <button onclick="login()" class="login-button">ENTRAR</button>
                <div id="errorMessage" class="error-message"></div>
            </div>
        </div>

        <div id="mainApp" style="display: none;">
            <div class="header">
                <button onclick="logout()" style="position: fixed; top: 20px; right: 20px; z-index: 1000; background: rgba(255,255,255,0.2); border: 2px solid #FFD700; color: #FFD700; padding: 8px 15px; border-radius: 10px; font-size: 12px; font-weight: bold; cursor: pointer;"> Cerrar sesi贸n</button>
                <div class="logo"></div><div class="title">LA CULPA</div><div class="subtitle">Ranking de Asistencias</div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('home')"> Home</div>
                <div class="tab" onclick="showTab('ranking')"> Ranking</div>
                <div class="tab" onclick="showTab('juntadas')"> Eventos</div>
                <div class="tab" onclick="showTab('perfil')"> Perfil</div>
            </div>
            
            <div id="home" class="content active">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-number" id="totalJuntadas">-</div><div class="stat-label">Juntadas</div></div>
                    <div class="stat-card"><div class="stat-number" id="totalCulposos">-</div><div class="stat-label">Tu Asistencia</div></div>
                </div>
                <div class="section-title"> Pr贸xima Juntada</div>
                <div id="proximaJuntadaCont"></div>
                <div class="section-title"> ltimas Juntadas</div>
                <div id="ultimasJuntadas" class="loading"><div class="spinner"></div>Cargando...</div>
            </div>
            
            <div id="ranking" class="content"><div id="rankingList" class="loading"><div class="spinner"></div></div></div>
            <div id="juntadas" class="content"><div id="juntadasList" class="loading"><div class="spinner"></div></div></div>
            <div id="perfil" class="content"><div id="perfilData" class="loading"><div class="spinner"></div></div></div>

            <div id="modalConfirmar" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; padding: 20px;">
                <div id="modalConfirmarContent"></div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_ID = '161VeGFs7DuavtXRwt0QRgnoObuD-QeNDnfXnJvlESZE';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxxtE7v2i2VV5OckqWdN9C3DFNKMNYGaTu4BMYgTS1qtu0RUdh7q9uZvUworV5062GtIA/exec';
        
        let currentUser = localStorage.getItem('culpaUserEmail');
        let juntadasData = [];
        let culpososData = [];

        window.onload = () => { if(currentUser) { loginAuto(); } };

        async function login() {
            const email = document.getElementById('emailInput').value.trim().toLowerCase();
            if (!email.includes('@')) return alert("Email no v谩lido");
            currentUser = email;
            localStorage.setItem('culpaUserEmail', email);
            loginAuto();
        }

        function loginAuto() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadData();
        }

        function logout() {
            localStorage.removeItem('culpaUserEmail');
            location.reload();
        }

        async function loadData() {
            try {
                const culURL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=CULPOSOS`;
                const junURL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Asistencias`;
                
                const [resC, resJ] = await Promise.all([fetch(culURL), fetch(junURL)]);
                const csvC = await resC.text();
                const csvJ = await resJ.text();
                
                culpososData = parseCSV(csvC);
                juntadasData = parseCSV(csvJ);
                
                renderHome();
                renderRanking();
                renderPerfil();
            } catch (e) { alert("Error cargando datos de Google Sheets"); }
        }

        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            return lines.slice(1).filter(l => l.trim()).map(line => {
                const values = line.split(',').map(v => v.replace(/"/g, '').trim());
                let obj = {};
                headers.forEach((h, i) => obj[h] = values[i]);
                return obj;
            });
        }

        function renderHome() {
            const user = culpososData.find(c => c.Email?.toLowerCase() === currentUser);
            document.getElementById('totalJuntadas').textContent = juntadasData.length;
            document.getElementById('totalCulposos').textContent = user ? (parseFloat(user.Porcentaje)*100).toFixed(0) + "%" : "-%";
            
            // L贸gica de Pr贸xima Juntada (Fijada a la columna C del Sheet)
            const proxima = juntadasData[0]; // Tomamos la primera fila como la pr贸xima
            const cont = document.getElementById('proximaJuntadaCont');
            cont.innerHTML = `
                <div class="card" style="border-left-color: #FFD700; padding: 20px;">
                    <div class="card-date">PRXIMO EVENTO</div>
                    <div class="card-title" style="font-size: 20px;">D铆a de pile y patys</div>
                    <button onclick="abrirModalConfirmar()" class="login-button" style="margin-top: 15px;"> CONFIRMAR ASISTENCIA</button>
                </div>`;
            
            document.getElementById('ultimasJuntadas').innerHTML = juntadasData.slice(0, 3).map(j => `
                <div class="card">
                    <div class="card-date">${j.Fecha || 'Reciente'}</div>
                    <div class="card-title">${j.Descripci贸n || 'Juntada'}</div>
                </div>`).join('');
        }

        function renderRanking() {
            const sorted = [...culpososData].sort((a,b) => b.Porcentaje - a.Porcentaje);
            document.getElementById('rankingList').innerHTML = sorted.map((c, i) => `
                <div class="ranking-item ${i<3?'top3':''}">
                    <div class="rank-number">${i+1}</div>
                    <div class="rank-info">
                        <div class="rank-name">${c.Nombre}</div>
                        <div class="rank-stats">${c.Asistencias} asistencias</div>
                    </div>
                    <div class="rank-percentage">${(parseFloat(c.Porcentaje)*100).toFixed(0)}%</div>
                </div>`).join('');
        }

        function renderPerfil() {
            const user = culpososData.find(c => c.Email?.toLowerCase() === currentUser);
            document.getElementById('perfilData').innerHTML = user ? `
                <div class="card" style="text-align: center; padding: 30px;">
                    <h2 style="color:#FFD700">${user.Nombre}</h2>
                    <p>${user.Email}</p>
                    <div style="font-size: 30px; margin-top:20px">${(parseFloat(user.Porcentaje)*100).toFixed(0)}%</div>
                </div>` : "No encontrado";
        }

        function abrirModalConfirmar() {
            const modal = document.getElementById('modalConfirmar');
            document.getElementById('modalConfirmarContent').innerHTML = `
                <div class="login-card" style="margin: 100px auto;">
                    <h2 style="color:#FFD700">驴Confirm谩s?</h2>
                    <button onclick="confirmar(true)" class="login-button" style="background:#4CAF50; color:white">S, VOY</button>
                    <button onclick="confirmar(false)" class="login-button" style="background:#f44336; color:white">NO PUEDO</button>
                    <button onclick="cerrar()" class="login-button" style="background:gray">CANCELAR</button>
                </div>`;
            modal.style.display = 'block';
        }

        async function confirmar(asiste) {
            try {
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ email: currentUser, asiste: asiste })
                });
                alert("隆Listo! Se guard贸 en el Excel.");
                cerrar();
            } catch (e) { alert("Error al conectar"); }
        }

        function cerrar() { document.getElementById('modalConfirmar').style.display = 'none'; }
        
        function showTab(id) {
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }
    </script>
</body>
</html>
