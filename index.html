

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA CULPA - App</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/czObXpX.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/qJl5bjR.png">
    <meta name="theme-color" content="#120D1F">
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjogIkxBIENVTFBBIiwgInNob3J0X25hbWUiOiAiTGEgQ3VscGEiLCAiZGVzY3JpcHRpb24iOiAiUmFua2luZyBkZSBBc2lzdGVuY2lhcyIsICJzdGFydF91cmwiOiAiL2xhLWN1bHBhLWFwcC8iLCAic2NvcGUiOiAiL2xhLWN1bHBhLWFwcC8iLCAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwgImJhY2tncm91bmRfY29sb3IiOiAiIzEyMEQxRiIsICJ0aGVtZV9jb2xvciI6ICIjMTIwRDFGIiwgImljb25zIjogW3sic3JjIjogImh0dHBzOi8vaS5pbWd1ci5jb20vcUpsNWJqUi5wbmciLCAic2l6ZXMiOiAiNTEyeDUxMiIsICJ0eXBlIjogImltYWdlL3BuZyIsICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSJ9XX0=">
    <style> 
           * { margin: 0; padding: 0; box-sizing: border-box; }
           body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #120D1F;
            min-height: 100vh; color: white;
        }
        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        .header {
            background: linear-gradient(135deg, #6B2D91 0%, #4A1D6B 50%, #3A1555 100%);
            padding: 40px 20px 30px; text-align: center; border-radius: 20px;
            margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .logo {
            width: min(280px, 70vw); height: min(280px, 70vw); margin: 0 auto 15px;
            background: url('https://i.imgur.com/czObXpX.png') center/contain no-repeat; border-radius: 20px;
        }
        .title { color: #FFD700; font-size: 32px; font-weight: bold; margin-bottom: 5px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .subtitle { color: rgba(255,255,255,0.9); font-size: 14px; }
        .tabs {
            display: flex; gap: 10px; margin-bottom: 20px;
            background: rgba(20,10,35,0.7); padding: 10px; border-radius: 15px; border: 1px solid rgba(107,45,145,0.3);
        }
        .tab {
            flex: 1; padding: 10px 6px; text-align: center; background: transparent;
            border: 2px solid rgba(139,77,143,0.3); border-radius: 10px; color: rgba(255,255,255,0.6);
            cursor: pointer; transition: all 0.3s; font-size: 12px; min-width: 0;
        }
        @media (max-width: 500px) {
            .tabs { gap: 5px !important; padding: 8px !important; }
            .tab { padding: 8px 4px !important; font-size: 11px !important; }
            .container { padding: 12px !important; }
            .stats-grid { gap: 10px !important; }
            .stat-number { font-size: 24px !important; }
            .ranking-item { gap: 10px !important; padding: 12px !important; }
            .rank-avatar { width: 38px !important; height: 38px !important; min-width: 38px; }
            .rank-number { min-width: 22px !important; font-size: 16px !important; }
            .rank-percentage { font-size: 15px !important; }
            .badge { font-size: 10px !important; padding: 2px 6px !important; }
            img { max-width: 100% !important; height: auto !important; }
            .card { padding: 12px !important; }
        }
        .tab.active { background: linear-gradient(135deg, #6B2D91 0%, #4A1D6B 100%); color: #C8A830; border-color: #C8A830; }
        .content { display: none; }
        .content.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .stat-card {
            padding: 20px; border-radius: 15px; text-align: center; border: 2px solid rgba(107,45,145,0.35);
        }
        .stat-number { font-size: 32px; font-weight: bold; color: #FFD700; margin-bottom: 5px; }
        .stat-label { color: rgba(255,255,255,0.7); font-size: 12px; text-transform: uppercase; }
        .section-title {
            color: #C8A830; font-size: 18px; font-weight: bold;
            margin: 25px 0 15px; display: flex; align-items: center; gap: 10px;
        }
        .card {
            background: linear-gradient(135deg, #0D0820 0%, #110C2A 100%);
            padding: 15px; border-radius: 15px; margin-bottom: 15px; border-left: 4px solid #C8A830;
        }
        .card-date { color: #FFD700; font-size: 12px; font-weight: bold; margin-bottom: 5px; }
        .card-title { color: white; font-size: 16px; font-weight: bold; margin-bottom: 5px; }
        .card-details { color: rgba(255,255,255,0.6); font-size: 13px; display: flex; gap: 15px; }
        .ranking-item {
            background: linear-gradient(135deg, #160D2E 0%, #1E1040 100%);
            padding: 15px; border-radius: 12px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 15px; border: 2px solid rgba(107,45,145,0.35);
        }
        .ranking-item.top3 { border-color: #FFD700; }
        .rank-number { font-size: 20px; font-weight: bold; color: #FFD700; min-width: 30px; }
        .rank-avatar {
            width: 45px; height: 45px; border-radius: 50%;
            background: linear-gradient(135deg, #8B4D8F 0%, #6B3870 100%);
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        .rank-info { flex: 1; }
        .rank-name { color: white; font-weight: bold; font-size: 14px; margin-bottom: 3px; display:flex; flex-wrap:wrap; align-items:center; gap:4px; justify-content:flex-start; }
        .rank-stats { color: rgba(255,255,255,0.6); font-size: 12px; display:block; text-align:left; width:100%; }
        .rank-percentage { font-size: 18px; font-weight: bold; color: #FFD700; }
        .badge { display: inline-block; background: #FFD700; color: #1a1a2e; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; margin-left: 5px; }
        .loading { text-align: center; padding: 40px; color: rgba(255,255,255,0.6); }
        .spinner {
            border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #C8A830;
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideDown { from { opacity:0; transform:translateX(-50%) translateY(-20px); } to { opacity:1; transform:translateX(-50%) translateY(0); } }
        .login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; text-align: center; }
        .login-card {
            background: linear-gradient(135deg, #160D2E 0%, #1E1040 100%);
            padding: 40px; border-radius: 20px; border: 2px solid rgba(139,77,143,0.3); max-width: 400px; width: 100%;
        }
        .login-input {
            width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px;
            border: 2px solid rgba(139,77,143,0.3); background: rgba(30,30,63,0.5); color: white; font-size: 16px;
        }
        .login-button {
            width: 100%; padding: 15px; margin-top: 20px; border-radius: 10px; border: none;
            background: linear-gradient(135deg, #6B2D91 0%, #4A1D6B 100%); color: #C8A830; font-size: 16px; font-weight: bold; cursor: pointer;
        }
        .login-button:hover { opacity: 0.9; }
        .error-message { color: #ff4444; margin-top: 10px; font-size: 14px; }
        .form-select {
            width: 100%; padding: 12px; border-radius: 8px; border: 2px solid rgba(139,77,143,0.3);
            background: rgba(30,30,63,0.5); color: white; font-size: 14px;
        }
        .form-select option { background: #1e1e3f; color: white; }
        /* Selector de meses ‚Äî ocultar scrollbar */
        .mes-selector::-webkit-scrollbar { display: none; }
        .mes-selector { -ms-overflow-style: none; scrollbar-width: none; }
        /* ===== TRANSICIONES GLOBALES SUAVES ===== */

* {
    transition: background 0.25s ease,
                color 0.25s ease,
                border-color 0.25s ease;
}

.card,
.stat-card,
.ranking-item,
.tab {
    transition: transform 0.25s ease,
                box-shadow 0.25s ease,
                background 0.25s ease;
}

.content {
    transition: opacity 0.2s ease;
}

.stat-card:hover,
.card:hover,
.ranking-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(200,168,48,0.25);
}

/* Top 3 m√°s √©pico */
.ranking-item.top3 {
    background: linear-gradient(135deg, #1E1040 0%, #2A1455 100%);
    box-shadow: 0 0 15px rgba(255,215,0,0.3);
}

/* N√∫mero ranking m√°s grande */
.rank-number {
    font-size: 22px;
    letter-spacing: 1px;
}

.tab:hover {
    background: rgba(200,168,48,0.15);
    color: #FFD700;
    border-color: #FFD700;
}
       @keyframes splaShPulse {
    0%   { transform: scale(0.7); filter: drop-shadow(0 0 5px rgba(107,45,145,0.3)); opacity: 0.6; }
    100% { transform: scale(1.15); filter: drop-shadow(0 0 30px rgba(200,168,48,0.9)); opacity: 1; }
}
@keyframes splashFade {
    0%,100% { opacity: 1; }
    50%      { opacity: 0.5; }
}

        @keyframes flamePulse {
    0%   { transform:scale(1) rotate(-3deg);    filter:brightness(1); }
    50%  { transform:scale(1.18) rotate(2deg);  filter:brightness(1.4) drop-shadow(0 0 4px #FF6600); }
    100% { transform:scale(0.95) rotate(-1deg); filter:brightness(0.9); }
}
@keyframes boltPulse {
    0%   { opacity:0.7; transform:scale(1); }
    100% { opacity:1;   transform:scale(1.2); filter:drop-shadow(0 0 3px #FFD700); }
}
        
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
</head>
<body>
<div class="container" id="app">
    
    <!-- PANTALLA DE CARGA -->
<div id="splashScreen" style="position:fixed;top:0;left:0;right:0;bottom:0;background:#120D1F;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 0.6s ease;">
    <div style="width:140px;height:140px;background:url('https://i.imgur.com/czObXpX.png') center/contain no-repeat;animation:splaShPulse 1.8s ease-out forwards;"></div>
    <div style="color:#FFD700;font-size:28px;font-weight:bold;letter-spacing:3px;margin-top:25px;animation:splashFade 1.2s ease-in-out infinite;">LA CULPA</div>
    <div style="color:rgba(255,255,255,0.4);font-size:13px;margin-top:8px;letter-spacing:1px;">üëë 8 REYES üëë</div>
</div>

    <!-- LOGIN -->
    <div id="loginScreen" class="login-screen">
        <div class="header">
            <div class="logo"></div>
            <div class="title">LA CULPA</div>
            <div class="subtitle">üëë 8 REYES üëë</div>
        </div>
        <div class="login-card">
            <h2 style="color:#FFD700;margin-bottom:20px;">Bienvenido, Culposo</h2>
            <p style="color:rgba(255,255,255,0.7);margin-bottom:20px;">Ingres√° tu email para ver tus stats</p>
            <input type="email" id="emailInput" class="login-input" placeholder="tu@email.com">
            <button onclick="login()" class="login-button">ENTRAR</button>
            <div id="errorMessage" class="error-message"></div>
        </div>
    </div>
    <!-- MAIN APP -->
    <div id="mainApp" style="display:none;">
        <div class="header" style="position:relative;overflow:hidden;background:linear-gradient(135deg,#6B2D91 0%,#4A1D6B 50%,#3A1555 100%);">
    <button onclick="logout()" style="position:fixed;top:20px;right:20px;z-index:1000;background:rgba(255,255,255,0.2);border:2px solid #FFD700;color:#FFD700;padding:8px 15px;border-radius:10px;font-size:12px;font-weight:bold;cursor:pointer;">
        üö™ Cerrar sesi√≥n
    </button>
    <!-- Fondo con patr√≥n sutil -->
    <div style="position:absolute;inset:0;background:radial-gradient(ellipse at 20% 50%,rgba(200,168,48,0.08) 0%,transparent 60%),radial-gradient(ellipse at 80% 20%,rgba(107,45,145,0.4) 0%,transparent 50%);pointer-events:none;"></div>
    <!-- L√≠neas decorativas -->
    <div style="position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 40px,rgba(200,168,48,0.03) 40px,rgba(200,168,48,0.03) 41px);pointer-events:none;"></div>
    <div class="logo" style="position:relative;z-index:1;filter:drop-shadow(0 4px 20px rgba(200,168,48,0.4));"></div>
    <div class="title" style="position:relative;z-index:1;font-family:'Georgia',serif;font-size:38px;letter-spacing:6px;background:linear-gradient(180deg,#FFE566 0%,#C8A830 50%,#A07820 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:none;">LA CULPA</div>
    <div style="position:relative;z-index:1;margin-top:8px;display:flex;align-items:center;justify-content:center;gap:10px;">
        <div style="height:1px;width:40px;background:linear-gradient(to right,transparent,#C8A830);"></div>
        <div style="font-family:'Georgia',serif;color:#C8A830;font-size:11px;letter-spacing:4px;text-transform:uppercase;opacity:0.85;">8 Reyes</div>
        <div style="height:1px;width:40px;background:linear-gradient(to left,transparent,#C8A830);"></div>
    </div>
</div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('home',this)">üè†<br>Home</div>
            <div class="tab" onclick="showTab('ranking',this)">üëë<br>Culposos</div>
            <div class="tab" onclick="showTab('juntadas',this)">üìÖ<br>Juntadas</div>
            <div class="tab" onclick="showTab('awards',this)">üèÜ<br>Awards</div>
            <div class="tab" onclick="showTab('calculadora',this)">üí∞<br>Calc</div>
            <div class="tab" onclick="showTab('perfil',this)">üë§<br>Perfil</div>
        </div>

        <!-- HOME -->
        <div id="home" class="content active">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-number" id="totalJuntadas">-</div><div class="stat-label">Juntadas</div></div>
                <div class="stat-card"><div class="stat-number" id="totalCulposos">-</div><div class="stat-label">Tu Asistencia</div></div>
            </div>

   <div id="culpapp-player">
  <div id="songName" style="font-size:12px; margin-bottom:6px; text-align:center;"></div>
  <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
    <button onclick="prevSong()">‚èÆ</button>
    <button onclick="togglePlay()" id="playBtn">‚ñ∂</button>
    <button onclick="nextSong()">‚è≠</button>
    <input type="range" id="volume" min="0" max="1" step="0.01" value="1">
  </div>
  <input type="range" id="progressBar" value="0" min="0" step="1" style="width:100%; margin-top:10px;">
  <div id="timeDisplay" style="display:flex;justify-content:space-between;font-size:11px;margin-top:4px;color:rgba(255,255,255,0.7);">
    <span id="currentTime">0:00</span>
    <span id="duration">0:00</span>
  </div>
</div>
<div id="ultimasJuntadas" class="loading"><div class="spinner"></div>Cargando juntadas...</div>
        </div>
        <!-- RANKING -->
        <div id="ranking" class="content">
            <div class="section-title">üèÜ Ranking de Culposos</div>
            <div id="rankingList" class="loading"><div class="spinner"></div>Cargando ranking...</div>
        </div>

        <!-- JUNTADAS -->
        <div id="juntadas" class="content">
            <div class="section-title">üìÖ Historial de Juntadas</div>
            <div id="juntadasList" class="loading"><div class="spinner"></div>Cargando juntadas...</div>
        </div>

        <!-- DETALLE JUNTADA -->
        <div id="juntadaDetalle" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:2000;overflow-y:auto;padding:20px;">
            <div style="max-width:500px;margin:0 auto;position:relative;">
                <button onclick="cerrarDetalle()" style="position:fixed;top:20px;right:20px;background:rgba(255,255,255,0.2);border:2px solid #FFD700;color:#FFD700;padding:10px 20px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;z-index:2001;">‚úï Cerrar</button>
                <div id="juntadaDetalleContent"></div>
            </div>
        </div>

        <!-- MODAL CONFIRMAR ASISTENCIA -->
        <div id="modalConfirmar" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:2000;overflow-y:auto;padding:20px;">
            <div style="max-width:500px;margin:0 auto;position:relative;">
                <button onclick="cerrarModalConfirmar()" style="position:fixed;top:20px;right:20px;background:rgba(255,255,255,0.2);border:2px solid #FFD700;color:#FFD700;padding:10px 20px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;z-index:2001;">‚úï Cerrar</button>
                <div id="modalConfirmarContent"></div>
            </div>
        </div>

        <!-- AWARDS -->
        <div id="awards" class="content">
            <div class="section-title">üèÜ LA CULPA Awards</div>
       <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:20px;">
    <select id="yearFilter" onchange="renderAwards()" style="background:linear-gradient(135deg,#8B4D8F 0%,#6B3870 100%);border:2px solid #FFD700;color:#FFD700;padding:10px 20px;border-radius:10px;font-size:14px;font-weight:bold;cursor:pointer;">
        <option value="2025" style="background:#1e1e3f;color:#FFD700;" selected>2025</option>
        <option value="2024" style="background:#1e1e3f;color:#FFD700;">2024</option>
        <option value="2023" style="background:#1e1e3f;color:#FFD700;">2023</option>
    </select>
    <div id="driveLinkInline"></div>
</div>
                
            <div id="awardsList" class="loading"><div class="spinner"></div>Cargando premios...</div>
        </div>

        <!-- CALCULADORA -->
        <div id="calculadora" class="content">
            <div class="section-title">üí∞ Calculadora de Gastos</div>
            <div id="gastosContainer"></div>
            <button onclick="agregarGasto()" style="width:100%;margin:20px 0;background:linear-gradient(135deg,#8B4D8F 0%,#6B3870 100%);border:none;color:#FFD700;padding:15px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;">‚ûï Agregar Gasto</button>
            <button onclick="calcularDivision()" style="width:100%;background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);border:none;color:#1E1E3F;padding:15px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;">üßÆ Calcular Divisi√≥n</button>
            <div id="resultadoCalculo" style="margin-top:20px;"></div>
        </div>

        <!-- MODAL PROPONER JUNTADA -->
        <div id="modalProponerJuntada" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:2000;overflow-y:auto;padding:20px;">
            <div style="max-width:500px;margin:0 auto;position:relative;">
                <button onclick="cerrarModalProponerJuntada()" style="position:fixed;top:20px;right:20px;background:rgba(255,255,255,0.2);border:2px solid #FFD700;color:#FFD700;padding:10px 20px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;z-index:2001;">‚úï Cerrar</button>
                <div id="modalProponerContent"></div>
            </div>
        </div>

        <!-- MODAL EDITAR JUNTADA -->
        <div id="modalEditarJuntada" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:2000;overflow-y:auto;padding:20px;">
            <div style="max-width:500px;margin:0 auto;position:relative;">
                <button onclick="cerrarModalEditarJuntada()" style="position:fixed;top:20px;right:20px;background:rgba(255,255,255,0.2);border:2px solid #FFD700;color:#FFD700;padding:10px 20px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;z-index:2001;">‚úï Cerrar</button>
                <div id="modalEditarContent"></div>
            </div>
        </div>

        <!-- PERFIL -->
        <div id="perfil" class="content">
            <div class="section-title">üë§ Mi Perfil</div>
            <div id="perfilData" class="loading"><div class="spinner"></div>Cargando perfil...</div>
        </div>
    </div>
</div>

<script>
    const SHEET_ID = '161VeGFs7DuavtXRwt0QRgnoObuD-QeNDnfXnJvlESZE';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxrz7UH8fYW5DbP2wD3QtbNC3nigwv_0ZF6HTPgmpZAnouFvR5m1UE1INZAndRbcyKXRA/exec';
    const ADMIN_EMAIL = 'tomascimmino@gmail.com';

    const CULPOSOS_HOSTS = ['Zabala - Sami','Caama√±o - Manu','Rama','Tirri - Toto','Santi','Toti - Lei','Mateo - Juli','Sin host'];
    const CATEGORIAS = ['Comida','Salida','Cumplea√±os','Entrenamiento','Otro'];
    const NOMBRES_MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

    const ALIAS_HOST = {
        'Leila':'Lei','Juli':'Juli','Tirri':'Tirri','Toto':'Toto',
        'Mateo':'Mateo','Toti':'Toti','Zabala':'Zabala','Sami':'Sami','Caama√±o':'Caama√±o','Manu':'Manu'
    };

    const FOTOS = {
        'Toto':'https://i.imgur.com/Y8NOVgH.png','Caama√±o':'https://i.imgur.com/7E7f3Xy.png',
        'Rama':'https://i.imgur.com/8hsqIL8.png','Zabala':'https://i.imgur.com/IsgSjm9.png',
        'Santi':'https://i.imgur.com/iXHdIVT.png','Mateo':'https://i.imgur.com/MY6KbRq.png',
        'Tirri':'https://i.imgur.com/biqacxq.png','Toti':'https://i.imgur.com/fOVTNio.png',
        'Cata':'https://i.imgur.com/jhme4wb.png','Lola':'https://i.imgur.com/qTP4eT2.png',
        'Sami':'https://i.imgur.com/HP41gaP.png','Leila':'https://i.imgur.com/wcf3be4.png',
        'Juli':'https://i.imgur.com/cn779x3.png','Manu':'https://i.imgur.com/BzDK66B.png',
        'Matu':'https://i.imgur.com/gNabdVm.png'
    };

    const DRIVE_FECHAS = {
        '7-1-2026':             '1P-bt4zhv4cDpT_O1dBlnlGhBUgu1f45e',
        '18-1-2026':            '1W8SDF-xEZ9QI6f0GwEqqpA18LM1opkLy',
        '24-1-2026':            '1Pq_2Ab6BWCYfIEuUf3pmjGXSX8h5IqJS',
        '8-2-2026 BRISAS':      '1UZ3iZfeeX8msJNTnTa5lqvVESSCu1OMl',
        '8-2-2026 CABA':        '1zu4_6jC17DYQu1FrpBe8J7c-P6ZeM9Pk',
        '12-2-2026':            '1pf9YS0N4Zvea960Wkvv4o4cLszL7vX-b',
        '14-2-2026':            '1EZ-VYqpUXpu7vhFGYSkfshOFMYtf97Fc',
        '16-2-2026 HURLINGHAM': '1b4PVdlHfPVy_G4cR4CETwL_5ya9IHIYo',
        '16-2-2026 PASTOR':     '1B36Ri17YnjquRxToBtJcmsGk9_aWcBMk'
    };

    function getDriveLink(juntada) {
        const sheetId = juntada['Drive ID'] || juntada['Drive Id'] || juntada['drive_id'] || '';
        if (sheetId) return `https://drive.google.com/drive/folders/${sheetId}`;

        if (!juntada.Fecha) return null;
        const partes = String(juntada.Fecha).split('/');
        if (partes.length !== 3) return null;
        const d = parseInt(partes[0]), m = parseInt(partes[1]), y = partes[2];
        const fechaKey = `${d}-${m}-${y}`;

        if (DRIVE_FECHAS[fechaKey])
            return `https://drive.google.com/drive/folders/${DRIVE_FECHAS[fechaKey]}`;

        const desc = (juntada.Descripci√≥n || juntada.Descripcion || '').toUpperCase();
        const host = (juntada.Host || '').toUpperCase();
        for (const key of Object.keys(DRIVE_FECHAS)) {
            if (!key.startsWith(fechaKey + ' ')) continue;
            const sufijo = key.replace(fechaKey + ' ', '');
            if (desc.includes(sufijo) || host.includes(sufijo))
                return `https://drive.google.com/drive/folders/${DRIVE_FECHAS[key]}`;
        }

        return null;
    }

    let currentUser = null;
    let juntadasData = [];
    let culpososData = [];
    let premiosData  = [];
    window.juntadasMesActivo = null;
    window.juntadasVerMas    = false;
    window.juntadasHostActivo = null;
window.juntadasAsistenteActivo = null;

    function esHostDe(hostStr, nombre) {
        if (!hostStr || !nombre) return false;
        const h = hostStr.toLowerCase();
        if (h.includes(nombre.toLowerCase())) return true;
        const ak = ALIAS_HOST[nombre];
        if (ak && h.includes(ak.toLowerCase())) return true;
        return false;
    }
    function tieneQuorum(j) {
        return parseInt(j['N¬∞ Culposos'] || j['N Culposos'] || '0') >= 4;
    }
    function getUsuarioActual() {
        return culpososData.find(c => c.Email && c.Email.toLowerCase() === currentUser);
    }
    function parseFecha(fechaStr) {
        if (!fechaStr) return null;
        const s = String(fechaStr).trim();
        const p = s.split('/');
        if (p.length === 3) {
            const [a, b, c] = p.map(Number);
            if (a > 1900) return new Date(a, b-1, c);
            return new Date(c, b-1, a);
        }
        const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (iso) return new Date(Number(iso[1]), Number(iso[2])-1, Number(iso[3]));
        const d = new Date(s);
        return isNaN(d.getTime()) ? null : d;
    }
    function esConfirmadoPositivo(val) { return val === 'TRUE' || val === '‚úì'; }
    function esConfirmadoNegativo(val) { return val === 'FALSE' || val === '‚úó'; }
    function estaConfirmado(val)       { return esConfirmadoPositivo(val) || esConfirmadoNegativo(val); }
    function calcularRacha(nombre) {
        const hoy = new Date(); hoy.setHours(0,0,0,0);
        const pasadas = juntadasData
            .filter(j => { if (!j.Fecha) return false; const f = parseFecha(j.Fecha); return f && f < hoy && tieneQuorum(j); })
            .sort((a,b) => parseFecha(b.Fecha) - parseFecha(a.Fecha));
        let racha = 0;
        for (const j of pasadas) { if (esConfirmadoPositivo(j[nombre])) racha++; else break; }
        return racha;
    }

    async function login() {
        const email = document.getElementById('emailInput').value.trim().toLowerCase();
        const errorMsg = document.getElementById('errorMessage');
        if (!email || !email.includes('@')) { errorMsg.textContent = 'Por favor ingres√° un email v√°lido'; return; }
        try {
            const r = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=CULPOSOS`);
            const temp = parseCSV(await r.text());
            if (!temp.some(c => c.Email && c.Email.toLowerCase() === email)) {
                errorMsg.textContent = '‚ùå Email no autorizado. Solo culposos pueden entrar.'; return;
            }
        } catch { errorMsg.textContent = 'Error conectando con el servidor. Intent√° de nuevo.'; return; }
        currentUser = email;
        localStorage.setItem('culpaUserEmail', email);
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        loadData();
        setTimeout(pedirPermisoNotificaciones, 3000);
    }

    function logout() {
        localStorage.removeItem('culpaUserEmail');
        currentUser = null;
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('emailInput').value = '';
        document.getElementById('errorMessage').textContent = '';
    }

    async function loadData() {
        try {
            const [jR, cR, pR] = await Promise.all([
                fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Hoja%201`),
                fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=CULPOSOS`),
                fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=PREMIOS`)
            ]);
            juntadasData = parseCSV(await jR.text());
            culpososData = parseCSV(await cR.text());
            premiosData  = parseCSV(await pR.text());
            window.juntadasMesActivo = null;
            window.juntadasVerMas = false;
            window.juntadasHostActivo = null;
window.juntadasAsistenteActivo = null;
            renderHome(); renderRanking(); renderJuntadas(); renderAwards(); renderPerfil();
        } catch(e) { console.error(e); alert('Error conectando con Google Sheets.'); }
    }

   function parseCSV(csv) {
    const lines = csv.split('\n');
    const headers = parseCSVLine(lines[0]);
    const data = [];
    for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        const values = parseCSVLine(lines[i]);
        if (!values.some(v => v)) continue;
        const row = {};
        headers.forEach((h, idx) => row[h] = values[idx] || '');
        if (headers.includes('Fecha') && !row.Fecha && !row.Descripci√≥n && !row.Descripcion) continue;
        data.push(row);
    }
    return data;
}

function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') { inQuotes = !inQuotes; }
        else if (ch === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
        else { current += ch; }
    }
    result.push(current.trim());
    return result;
}
function renderContadorAsistencia(j) {
    const REYES = ['Toto','Caama√±o','Rama','Zabala','Santi','Mateo','Tirri','Toti'];
    const AGREGADOS = ['Cata','Lola','Sami','Leila','Juli','Manu','Matu'];
    let totalConf = 0, reyesConf = 0;
    culpososData.forEach(c => { if (esConfirmadoPositivo(j[c.Nombre])) { totalConf++; if (REYES.includes(c.Nombre)) reyesConf++; } });
    const hayQ = reyesConf >= 4;

    function avHTML(nombre) {
        const val = j[nombre];
        const conf = esConfirmadoPositivo(val);
        const noConf = esConfirmadoNegativo(val);
        const foto = FOTOS[nombre] || '';
        return `<div style="display:flex;flex-direction:column;align-items:center;gap:1px;flex-shrink:0;">
            <div style="width:24px;height:24px;border-radius:50%;background:url('${foto}') center top/cover;
                border:1.5px solid ${conf?'#4CAF50':noConf?'#f44336':'rgba(255,255,255,0.2)'};
                opacity:${noConf?'0.35':conf?'1':'0.55'};
                filter:${noConf?'grayscale(60%)':'none'};
                transition:transform 0.15s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'"></div>
            <span style="font-size:7px;color:rgba(255,255,255,0.4);max-width:24px;text-align:center;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">${nombre}</span>
        </div>`;
    }

    const reyesHTML = REYES.map(avHTML).join('');
    const agHTML = AGREGADOS.filter(n => culpososData.find(c=>c.Nombre===n)).map(avHTML).join('');

    return `<div style="background:rgba(0,0,0,0.25);border-radius:12px;padding:8px 10px;margin-bottom:12px;border:1px solid rgba(200,168,48,0.2);">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:7px;">
            <span style="color:rgba(255,255,255,0.4);font-size:9px;letter-spacing:1px;text-transform:uppercase;">Confirmaciones</span>
            <div style="display:flex;gap:5px;align-items:center;">
                <div style="padding:1px 6px;border-radius:20px;font-size:10px;font-weight:bold;white-space:nowrap;background:${hayQ?'rgba(76,175,80,0.15)':'rgba(255,152,0,0.12)'};color:${hayQ?'#4CAF50':'#FF9800'};border:1px solid ${hayQ?'rgba(76,175,80,0.35)':'rgba(255,152,0,0.3)'};">üëë ${reyesConf}/8${hayQ?' ‚úì':''}</div>
                <div style="padding:1px 6px;border-radius:20px;font-size:10px;font-weight:bold;white-space:nowrap;background:rgba(200,168,48,0.12);color:#C8A830;border:1px solid rgba(200,168,48,0.3);">üë• ${totalConf}/${culpososData.length}</div>
            </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;">
            <div style="display:flex;gap:4px;align-items:flex-start;flex-wrap:nowrap;">${reyesHTML}</div>
            <div style="height:1px;background:linear-gradient(to right,transparent,rgba(200,168,48,0.25),transparent);"></div>
            <div style="display:flex;gap:4px;align-items:flex-start;flex-wrap:nowrap;">${agHTML}</div>
        </div>
    </div>`;
}
    function renderHome() {
        const hoy = new Date(); hoy.setHours(0,0,0,0);
        let proximaJuntada = null, proximaIndex = -1;
        const juntadasPasadas = [];

        juntadasData.forEach((j, i) => {
            if (!j.Fecha) return;
            const f = parseFecha(j.Fecha);
            if (!f) return;
            if (f >= hoy && !proximaJuntada) { proximaJuntada = j; proximaIndex = i; }
            else if (f < hoy && tieneQuorum(j)) juntadasPasadas.push(j);
        });

        document.getElementById('totalJuntadas').textContent = juntadasPasadas.length;

        const usuario = getUsuarioActual();
        if (usuario) {
            let asistidas = 0;
            juntadasPasadas.forEach(j => { if (esConfirmadoPositivo(j[usuario.Nombre])) asistidas++; });
            const pct = juntadasPasadas.length > 0 ? Math.round((asistidas/juntadasPasadas.length)*100) : 0;
            let col = '#f44336';
            if (pct>=90) col='#4CAF50'; else if (pct>=70) col='#8BC34A'; else if (pct>=40) col='#FF9800';
            document.getElementById('totalCulposos').innerHTML = `<span style="color:${col}">${pct}%</span>`;
        }

        let proximaHTML = '';
        if (proximaJuntada && usuario) {
            const desc = proximaJuntada.Descripci√≥n || proximaJuntada.Descripcion || '';
            if (desc && desc !== 'undefined') {
                const miVal = proximaJuntada[usuario.Nombre];
                const yaConfirme = estaConfirmado(miVal);
                const positivo = esConfirmadoPositivo(miVal);
                let estadoHTML = '';
                if (yaConfirme) {
                    if (positivo) {
                        estadoHTML = `<div style="text-align:center;padding:15px;background:rgba(76,175,80,0.2);border-radius:10px;margin-top:15px;border:2px solid #4CAF50;">
                            <div style="font-size:22px;margin-bottom:6px;">‚úÖ</div>
                            <div style="font-size:16px;font-weight:bold;color:#4CAF50;">¬°Ya confirmaste asistencia!</div>
                            <button onclick="abrirModalConfirmar(${proximaIndex})" style="margin-top:10px;background:rgba(255,255,255,0.15);border:2px solid #FFD700;color:#FFD700;padding:8px 18px;border-radius:8px;font-size:12px;cursor:pointer;font-weight:bold;">‚úèÔ∏è Editar respuesta</button>
                        </div>`;
                    } else {
                        estadoHTML = `<div style="text-align:center;padding:15px;background:rgba(244,67,54,0.2);border-radius:10px;margin-top:15px;border:2px solid #f44336;">
                            <div style="font-size:22px;margin-bottom:6px;">‚ùå</div>
                            <div style="font-size:16px;font-weight:bold;color:#f44336;">Me abstuve ‚Äî no voy</div>
                            <button onclick="abrirModalConfirmar(${proximaIndex})" style="margin-top:10px;background:rgba(255,255,255,0.15);border:2px solid #FFD700;color:#FFD700;padding:8px 18px;border-radius:8px;font-size:12px;cursor:pointer;font-weight:bold;">‚úèÔ∏è Editar respuesta</button>
                        </div>`;
                    }
                } else {
                    estadoHTML = `<button onclick="abrirModalConfirmar(${proximaIndex})" style="width:100%;margin-top:15px;background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);border:none;color:#1E1E3F;padding:15px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;">üìù Confirmar asistencia</button>`;
                }
                const esHostProxima = esHostDe(proximaJuntada.Host, usuario.Nombre);
                const puedeEditarProxima = esHostProxima || currentUser === ADMIN_EMAIL;
                const botonesProxima = puedeEditarProxima ? `
                    <div style="display:flex;gap:10px;margin-top:12px;">
                        <button onclick="abrirModalEditarJuntada(${proximaIndex})" style="flex:1;background:rgba(255,215,0,0.15);border:2px solid #FFD700;color:#FFD700;padding:10px;border-radius:10px;font-size:13px;font-weight:bold;cursor:pointer;">‚úèÔ∏è Editar</button>
                        <button onclick="confirmarEliminar(${proximaIndex})" style="flex:1;background:rgba(244,67,54,0.15);border:2px solid #f44336;color:#f44336;padding:10px;border-radius:10px;font-size:13px;font-weight:bold;cursor:pointer;">üóëÔ∏è Eliminar</button>
                    </div>` : '';
                proximaHTML = `
                    <div class="section-title" style="margin-top:10px;">üéØ Pr√≥xima Juntada</div>
                    <div class="card" style="background:linear-gradient(135deg,rgba(255,215,0,0.15) 0%,rgba(255,215,0,0.05) 100%);border-left-color:#FFD700;">
                        <div class="card-date">${proximaJuntada.Fecha}</div>
                        <div class="card-title" style="font-size:20px;">${desc}</div>
                       <div class="card-details" style="margin:10px 0;">
                            <span>üè† ${proximaJuntada.Host || 'Sin host'}</span>
                            ${proximaJuntada.Categor√≠a || proximaJuntada.Categoria ? `<span>üè∑Ô∏è ${proximaJuntada.Categor√≠a || proximaJuntada.Categoria}</span>` : ''}
                        </div>
                      ${renderContadorAsistencia(proximaJuntada)}
                        ${estadoHTML}${botonesProxima}
                    </div>`;
            }
        } else if (usuario) {
    proximaHTML = `
        <div class="section-title" style="margin-top:10px;">üéØ Pr√≥xima Juntada</div>

        <div class="card" style="background:rgba(139,77,143,0.1);text-align:center;">
            <div style="font-size:40px;margin-bottom:10px;">üìÖ</div>
            <div class="card-title" style="color:rgba(255,255,255,0.7);">
                No hay pr√≥xima juntada programada
            </div>
        </div>

        <button onclick="abrirModalProponerJuntada()" 
            style="width:100%;margin:15px 0 10px;
                   background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);
                   border:none;color:#1E1E3F;padding:12px;
                   border-radius:10px;font-size:14px;
                   font-weight:bold;cursor:pointer;">
            ‚ûï Proponer Juntada
        </button>
    `;
}
        const ultimas = juntadasPasadas.slice(-3).reverse();
        const ultimasHTML = ultimas.map(j => {
            const ri = juntadasData.indexOf(j);
            const foto = j['Foto Juntada'] || j['Foto juntada'] || '';
            return `<div class="card" onclick="verDetalleJuntada(${ri})" style="cursor:pointer;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                ${foto ? `<div style="width:100%;border-radius:10px;margin-bottom:12px;overflow:hidden;"><img src="${foto}" style="width:100%;max-height:180px;object-fit:cover;display:block;"></div>` : ''}
                <div class="card-date">${j.Fecha||''}</div>
                <div class="card-title">${j.Descripci√≥n||j.Descripcion||'Juntada'}</div>
                <div class="card-details"><span>üè† ${j.Host||'Sin host'}</span><span>üë• ${j['N¬∞ Asist']||'0'} asistentes</span></div>
            </div>`;
        }).join('') || '<p style="color:rgba(255,255,255,0.6);">No hay juntadas registradas</p>';

        document.getElementById('ultimasJuntadas').innerHTML =
            proximaHTML +
            (juntadasPasadas.length > 0 ? `<div class="section-title" style="margin-top:25px;">üî• √öltimas Juntadas</div>` : '') +
            ultimasHTML;
    }

    function renderRanking() {
        const sorted = [...culpososData].sort((a,b) => parseFloat(b.Porcentaje)-parseFloat(a.Porcentaje));
        const html = sorted.map((c, i) => {
            const pct = parseFloat(c.Porcentaje).toFixed(0);
            const foto = FOTOS[c.Nombre] || '';
            const r = calcularRacha(c.Nombre);
            const rachaHTML = r>=10
    ? `<span class="badge" style="background:linear-gradient(135deg,rgba(255,80,0,0.2),rgba(200,60,0,0.1));color:#FF6B2B;border:1px solid rgba(255,100,0,0.4);cursor:default;position:relative;overflow:hidden;" title="${r} juntadas seguidas"><span style="display:inline-block;animation:flamePulse 1.2s ease-in-out infinite alternate;transform-origin:bottom center;">üî•</span> ${r}</span>`
    : r>=5
    ? `<span class="badge" style="background:linear-gradient(135deg,rgba(200,168,0,0.2),rgba(160,130,0,0.1));color:#D4A830;border:1px solid rgba(200,168,0,0.35);cursor:default;" title="${r} juntadas seguidas"><span style="display:inline-block;animation:boltPulse 1.8s ease-in-out infinite alternate;">‚ö°</span> ${r}</span>`
    : '';
const col = (p => p>=90?'#4CAF50':p>=75?'#8BC34A':p>=60?'#FFD700':p>=45?'#FF9800':'#f44336')(parseFloat(pct));
            return `<div class="ranking-item ${i<3?'top3':''}">
                <div class="rank-number">${i+1}</div>
                <div class="shield-wrap" onclick="verPerfilCulposo('${c.Nombre}')" style="cursor:pointer;position:relative;width:48px;height:54px;flex-shrink:0;">
    ${i===0?`<div style="position:absolute;top:-11px;left:50%;transform:translateX(-50%);z-index:10;"><svg width="24" height="15" viewBox="0 0 40 24" fill="none"><path d="M2 20 L2 10 L10 16 L20 4 L30 16 L38 10 L38 20 Z" fill="#C8A830" stroke="#FFE566" stroke-width="1.5" stroke-linejoin="round"/><circle cx="20" cy="4" r="2.5" fill="#FFE566"/><circle cx="2" cy="10" r="2" fill="#C8A830"/><circle cx="38" cy="10" r="2" fill="#C8A830"/><rect x="2" y="19" width="36" height="3" rx="1" fill="#A07820"/></svg></div>`:''}
    <svg style="position:absolute;inset:0;width:100%;height:100%;filter:drop-shadow(0 2px 5px rgba(0,0,0,0.6));" viewBox="0 0 48 54" fill="none">
        <path d="M24 51C24 51 3 39 3 22L3 7L24 3L45 7L45 22C45 39 24 51 24 51Z" fill="${i<3?'#1A0830':'#0D0520'}"/>
        <path d="M24 51C24 51 3 39 3 22L3 7L24 3L45 7L45 22C45 39 24 51 24 51Z" fill="none" stroke="${i<3?'#C8A830':'rgba(200,168,48,0.2)'}" stroke-width="${i<3?'1.5':'1'}"/>
        ${i<3?`<line x1="24" y1="4" x2="24" y2="47" stroke="rgba(200,168,48,0.25)" stroke-width="0.8"/><circle cx="3" cy="7" r="1.5" fill="#C8A830" opacity="${i===0?'0.8':i===1?'0.65':'0.5'}"/><circle cx="45" cy="7" r="1.5" fill="#C8A830" opacity="${i===0?'0.8':i===1?'0.65':'0.5'}"/>`:''}
    </svg>
    <div style="position:absolute;top:6px;left:6px;width:36px;height:36px;border-radius:50%;background-size:cover;background-position:center top;background-image:url('${foto}');"></div>
</div>
                     <div class="rank-info" onclick="verPerfilCulposo('${c.Nombre}')" style="cursor:pointer;">
                    <div class="rank-name">${c.Nombre}${pct==100?'<span class="badge" style="background:rgba(255,215,0,0.12);color:#C8A830;border:1px solid rgba(255,215,0,0.25);cursor:default;">üëë</span>':''}${rachaHTML}</div>
                    <div class="rank-stats">${c.Asistencias} de ${c['Total Juntadas']} juntadas</div>
                </div>
                <div class="rank-percentage" style="color:${col}">${pct}%</div>
            </div>`;
        }).join('');
        document.getElementById('rankingList').innerHTML = html;
    }

    function renderJuntadas() {
    const usuario = getUsuarioActual();
    const nombreUsuario = usuario ? usuario.Nombre : '';
    const hoy = new Date(); hoy.setHours(0,0,0,0);

    const pasadas = juntadasData.filter(j => {
        if (!j.Fecha) return false;
        const f = parseFecha(j.Fecha);
        return f && f < hoy && tieneQuorum(j);
    }).slice().reverse();

    let totalBannerHTML = '';
    if (nombreUsuario && pasadas.length > 0) {
        const asistTot = pasadas.filter(j => esConfirmadoPositivo(j[nombreUsuario])).length;
        const pctTot   = Math.round((asistTot / pasadas.length) * 100);
        let msg, emoji, col;
        if (pctTot < 40)      { msg='Te ven√≠s absteniendo mucho. Saludos.';      emoji='üò¥'; col='#f44336'; }
        else if (pctTot < 66) { msg='Ven√≠s bien, pero cuidado con abstenerse.';  emoji='üí™'; col='#FF9800'; }
        else if (pctTot < 91) { msg='Sos un culposo comprometido. Segu√≠ as√≠.';   emoji='üî•'; col='#4CAF50'; }
        else                  { msg='CULPOSO NIVEL LEGENDARIO.';                 emoji='üëë'; col='#FFD700'; }
        totalBannerHTML = '<div style="background:linear-gradient(135deg,rgba(107,45,145,0.25),rgba(74,29,107,0.15));border:2px solid ' + col + ';border-radius:14px;padding:16px 20px;margin-bottom:18px;display:flex;align-items:center;justify-content:center;gap:14px;"><div style="font-size:34px;flex-shrink:0;">' + emoji + '</div><div style="text-align:center;"><div style="color:' + col + ';font-size:20px;font-weight:bold;line-height:1;">' + asistTot + '<span style="font-size:13px;color:rgba(255,255,255,0.5);font-weight:normal;"> / ' + pasadas.length + ' juntadas</span></div><div style="color:' + col + ';font-size:13px;font-weight:bold;">' + pctTot + '% de asistencia total</div><div style="color:rgba(255,255,255,0.5);font-size:12px;margin-top:2px;">' + msg + '</div></div></div>';
    }

    // Filtros
    const filtradas = pasadas.filter(j => {
        const f = parseFecha(j.Fecha);
        if (!f) return false;
        if (window.juntadasDesde) { const desde = new Date(window.juntadasDesde); if (f < desde) return false; }
        if (window.juntadasHasta) { const hasta = new Date(window.juntadasHasta); hasta.setHours(23,59,59); if (f > hasta) return false; }
        if (window.juntadasCatActiva) { const cat = j.Categor√≠a||j.Categoria||''; if (cat !== window.juntadasCatActiva) return false; }
        if (window.juntadasHostActivo) { if (!(j.Host||'').toLowerCase().includes(window.juntadasHostActivo.toLowerCase())) return false; }
        if (window.juntadasAsistenteActivo) { if (!esConfirmadoPositivo(j[window.juntadasAsistenteActivo])) return false; }
        return true;
    });
 const mesesVistos = [];
    const mesesKeys = new Set();
    pasadas.forEach(j => {
        const f = parseFecha(j.Fecha);
        if (!f) return;
        const key = f.getFullYear() + '-' + f.getMonth();
        if (!mesesKeys.has(key)) {
            mesesKeys.add(key);
            const desde = f.getFullYear() + '-' + String(f.getMonth()+1).padStart(2,'0') + '-01';
            const lastDay = new Date(f.getFullYear(), f.getMonth()+1, 0).getDate();
            const hasta = f.getFullYear() + '-' + String(f.getMonth()+1).padStart(2,'0') + '-' + lastDay;
            mesesVistos.push({ label: NOMBRES_MESES[f.getMonth()], desde, hasta });
        }
    });

    let botonesmes = '<button onclick="window.juntadasDesde=\'\';window.juntadasHasta=\'\';window.juntadasVerMas=false;renderJuntadas()" style="padding:5px 12px;border-radius:20px;font-size:12px;font-weight:bold;cursor:pointer;border:1.5px solid ' + ((!window.juntadasDesde&&!window.juntadasHasta)?'#FFD700':'rgba(139,77,143,0.4)') + ';background:' + ((!window.juntadasDesde&&!window.juntadasHasta)?'linear-gradient(135deg,#6B2D91,#4A1D6B)':'rgba(30,16,64,0.6)') + ';color:' + ((!window.juntadasDesde&&!window.juntadasHasta)?'#FFD700':'rgba(255,255,255,0.6)') + ';">Todo</button>';
    mesesVistos.forEach(function(op) {
        const activo = window.juntadasDesde===op.desde && window.juntadasHasta===op.hasta;
        botonesmes += '<button onclick="window.juntadasDesde=\'' + op.desde + '\';window.juntadasHasta=\'' + op.hasta + '\';window.juntadasVerMas=false;renderJuntadas()" style="padding:5px 12px;border-radius:20px;font-size:12px;font-weight:bold;cursor:pointer;border:1.5px solid ' + (activo?'#FFD700':'rgba(139,77,143,0.4)') + ';background:' + (activo?'linear-gradient(135deg,#6B2D91,#4A1D6B)':'rgba(30,16,64,0.6)') + ';color:' + (activo?'#FFD700':'rgba(255,255,255,0.6)') + ';">' + op.label + '</button>';
    });

    const selectorHTML = '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px;">' + botonesmes + '</div>';
    const limite = window.juntadasVerMas ? filtradas.length : 10;
    const mostradas = filtradas.slice(0, limite);

let cardsHTML = '';
let i = 0;
while (i < mostradas.length) {
    const j = mostradas[i];
    const jSig = mostradas[i + 1];
    const mismaFecha = jSig && j.Fecha && jSig.Fecha && j.Fecha === jSig.Fecha;

    const ri = juntadasData.indexOf(j);
    const asistio = esConfirmadoPositivo(j[nombreUsuario]);
    const foto = j['Foto Juntada'] || j['Foto juntada'] || '';
    const driveLink = getDriveLink(j);

    if (mismaFecha) {
        i++;
        const j2 = mostradas[i];
        const ri2 = juntadasData.indexOf(j2);
        const asistio2 = esConfirmadoPositivo(j2[nombreUsuario]);
        const foto2 = j2['Foto Juntada'] || j2['Foto juntada'] || '';
        const driveLink2 = getDriveLink(j2);

        cardsHTML += '<div style="position:relative;padding-left:22px;margin-bottom:15px;">'
            + '<div style="position:absolute;left:0;top:0;bottom:0;width:22px;">'
            + '<div style="position:absolute;left:6px;top:10px;width:10px;height:2px;background:#C8A830;"></div>'
            + '<div style="position:absolute;left:6px;top:10px;width:2px;height:calc(50% - 16px);background:linear-gradient(to bottom,#C8A830,#FFE566);"></div>'
            + '<div style="position:absolute;left:2px;top:50%;transform:translateY(-50%) rotate(45deg);width:10px;height:10px;background:#C8A830;box-shadow:0 0 8px rgba(200,168,48,0.6);"></div>'
            + '<div style="position:absolute;left:6px;bottom:10px;width:2px;height:calc(50% - 16px);background:linear-gradient(to top,#C8A830,#FFE566);"></div>'
            + '<div style="position:absolute;left:6px;bottom:10px;width:10px;height:2px;background:#C8A830;"></div>'
            + '</div>'
            + '<div style="display:flex;align-items:center;justify-content:center;gap:10px;padding:6px 0;">'
            + '<div style="flex:1;height:1px;background:linear-gradient(to right,transparent,rgba(200,168,48,0.4));"></div>'
            + '<div style="color:#C8A830;font-size:9px;letter-spacing:3px;text-transform:uppercase;white-space:nowrap;padding:4px 12px;border:1px solid rgba(200,168,48,0.3);background:rgba(200,168,48,0.06);">‚öî DOBLE JORNADA ‚öî</div>'
            + '<div style="flex:1;height:1px;background:linear-gradient(to left,transparent,rgba(200,168,48,0.4));"></div>'
            + '</div>'
            + '<div class="card" onclick="verDetalleJuntada(' + ri + ')" style="cursor:pointer;margin-bottom:4px;" onmouseover="this.style.transform=\'scale(1.02)\'" onmouseout="this.style.transform=\'scale(1)\'">'
            + (foto ? '<div style="width:100%;border-radius:10px;margin-bottom:15px;overflow:hidden;"><img src="' + foto + '" style="width:100%;max-height:200px;object-fit:cover;display:block;"></div>' : '')
            + '<div class="card-date">' + (j.Fecha||'Fecha') + '</div>'
            + '<div class="card-title">' + (j.Descripci√≥n||j.Descripcion||'Juntada') + '</div>'
            + '<div class="card-details"><span>üè† ' + (j.Host||'Sin host') + '</span><span style="margin-left:10px;">üë• ' + (j['N¬∞ Asist']||'0') + '</span></div>'
            + '<div style="display:flex;align-items:center;gap:8px;margin-top:8px;flex-wrap:wrap;">'
            + (driveLink ? '<a href="' + driveLink + '" target="_blank" onclick="event.stopPropagation()" style="display:inline-flex;align-items:center;gap:4px;padding:5px 10px;border-radius:8px;background:rgba(66,133,244,0.2);border:1.5px solid #4285F4;color:#4285F4;font-size:11px;font-weight:bold;text-decoration:none;white-space:nowrap;">üìÅ Fotos</a>' : '<span style="display:inline-block;padding:5px 10px;border-radius:8px;font-size:11px;font-weight:bold;background:rgba(244,67,54,0.15);color:#f44336;white-space:nowrap;">ü§¶ Sin fotos</span>')
            + (nombreUsuario ? '<span style="display:inline-block;padding:5px 10px;border-radius:8px;font-size:11px;font-weight:bold;white-space:nowrap;' + (asistio?'background:rgba(76,175,80,0.2);color:#4CAF50;':'background:rgba(244,67,54,0.2);color:#f44336;') + '">' + (asistio?'‚úÖ FUISTE':'‚ùå NO FUISTE') + '</span>' : '')
            + '</div></div>'
            + '<div class="card" onclick="verDetalleJuntada(' + ri2 + ')" style="cursor:pointer;margin-top:4px;" onmouseover="this.style.transform=\'scale(1.02)\'" onmouseout="this.style.transform=\'scale(1)\'">'
            + (foto2 ? '<div style="width:100%;border-radius:10px;margin-bottom:15px;overflow:hidden;"><img src="' + foto2 + '" style="width:100%;max-height:200px;object-fit:cover;display:block;"></div>' : '')
            + '<div class="card-date">' + (j2.Fecha||'Fecha') + '</div>'
            + '<div class="card-title">' + (j2.Descripci√≥n||j2.Descripcion||'Juntada') + '</div>'
            + '<div class="card-details"><span>üè† ' + (j2.Host||'Sin host') + '</span><span style="margin-left:10px;">üë• ' + (j2['N¬∞ Asist']||'0') + '</span></div>'
            + '<div style="display:flex;align-items:center;gap:8px;margin-top:8px;flex-wrap:wrap;">'
            + (driveLink2 ? '<a href="' + driveLink2 + '" target="_blank" onclick="event.stopPropagation()" style="display:inline-flex;align-items:center;gap:4px;padding:5px 10px;border-radius:8px;background:rgba(66,133,244,0.2);border:1.5px solid #4285F4;color:#4285F4;font-size:11px;font-weight:bold;text-decoration:none;white-space:nowrap;">üìÅ Fotos</a>' : '<span style="display:inline-block;padding:5px 10px;border-radius:8px;font-size:11px;font-weight:bold;background:rgba(244,67,54,0.15);color:#f44336;white-space:nowrap;">ü§¶ Sin fotos</span>')
            + (nombreUsuario ? '<span style="display:inline-block;padding:5px 10px;border-radius:8px;font-size:11px;font-weight:bold;white-space:nowrap;' + (asistio2?'background:rgba(76,175,80,0.2);color:#4CAF50;':'background:rgba(244,67,54,0.2);color:#f44336;') + '">' + (asistio2?'‚úÖ FUISTE':'‚ùå NO FUISTE') + '</span>' : '')
            + '</div></div>'
            + '</div>';
    } else {
        cardsHTML += '<div class="card" onclick="verDetalleJuntada(' + ri + ')" style="cursor:pointer;transition:transform 0.2s;" onmouseover="this.style.transform=\'scale(1.02)\'" onmouseout="this.style.transform=\'scale(1)\'">'
            + (foto ? '<div style="width:100%;border-radius:10px;margin-bottom:15px;overflow:hidden;"><img src="' + foto + '" style="width:100%;max-height:200px;object-fit:cover;display:block;"></div>' : '')
            + '<div class="card-date">' + (j.Fecha||'Fecha') + '</div>'
            + '<div class="card-title">' + (j.Descripci√≥n||j.Descripcion||'Juntada') + '</div>'
            + '<div class="card-details"><span>üè† ' + (j.Host||'Sin host') + '</span><span style="margin-left:10px;">üë• ' + (j['N¬∞ Asist']||'0') + '</span></div>'
            + '<div style="display:flex;align-items:center;gap:8px;margin-top:8px;flex-wrap:wrap;">'
            + (driveLink ? '<a href="' + driveLink + '" target="_blank" onclick="event.stopPropagation()" style="display:inline-flex;align-items:center;gap:4px;padding:5px 10px;border-radius:8px;background:rgba(66,133,244,0.2);border:1.5px solid #4285F4;color:#4285F4;font-size:11px;font-weight:bold;text-decoration:none;white-space:nowrap;">üìÅ Fotos</a>' : '<span style="display:inline-block;padding:5px 10px;border-radius:8px;font-size:11px;font-weight:bold;background:rgba(244,67,54,0.15);color:#f44336;white-space:nowrap;">ü§¶ Sin fotos</span>')
            + (nombreUsuario ? '<span style="display:inline-block;padding:5px 10px;border-radius:8px;font-size:11px;font-weight:bold;white-space:nowrap;' + (asistio?'background:rgba(76,175,80,0.2);color:#4CAF50;':'background:rgba(244,67,54,0.2);color:#f44336;') + '">' + (asistio?'‚úÖ FUISTE':'‚ùå NO FUISTE') + '</span>' : '')
            + '</div></div>';
    }

    i++;
}

    const verMasHTML = filtradas.length > 10 && !window.juntadasVerMas
        ? '<button onclick="window.juntadasVerMas=true;renderJuntadas()" style="width:100%;margin:5px 0 20px;background:rgba(139,77,143,0.2);border:2px solid rgba(139,77,143,0.5);color:#C8A830;padding:12px;border-radius:10px;font-size:14px;font-weight:bold;cursor:pointer;">Ver ' + (filtradas.length - 10) + ' juntadas m√°s ‚Üì</button>'
        : '';

    let motivacionalHTML = '';
    if (nombreUsuario && filtradas.length > 0) {
        const asistFilt = filtradas.filter(j => esConfirmadoPositivo(j[nombreUsuario])).length;
        const pctFilt = Math.round((asistFilt / filtradas.length) * 100);
        const contexto = window.juntadasCatActiva ? 'de los ' + window.juntadasCatActiva.toLowerCase() + 's' : 'en este per√≠odo';
        let emoji2, col2;
        if (pctFilt < 40)      { emoji2='üò¥'; col2='#f44336'; }
        else if (pctFilt < 70) { emoji2='üí™'; col2='#FF9800'; }
        else if (pctFilt < 90) { emoji2='üî•'; col2='#4CAF50'; }
        else                   { emoji2='üëë'; col2='#FFD700'; }
        motivacionalHTML = '<div class="card" style="background:rgba(139,77,143,0.15);border-left-color:' + col2 + ';margin-top:10px;text-align:center;"><div style="font-size:32px;margin-bottom:8px;">' + emoji2 + '</div><div style="color:' + col2 + ';font-weight:bold;font-size:15px;">Fuiste al ' + pctFilt + '% ' + contexto + '</div></div>';
    }

    document.getElementById('juntadasList').innerHTML =
        totalBannerHTML +
        '<div style="color:rgba(255,255,255,0.45);font-size:12px;margin-bottom:10px;">' + filtradas.length + ' juntada' + (filtradas.length!==1?'s':'') + ' encontradas</div>' +
        selectorHTML +
        (cardsHTML || '<p style="color:rgba(255,255,255,0.5);text-align:center;padding:30px;">Sin juntadas para este filtro</p>') +
        verMasHTML +
        motivacionalHTML;
}

    function cambiarMesJuntadas(key) {
        window.juntadasMesActivo = key;
        window.juntadasVerMas = false;
        renderJuntadas();
    }
    function verMasJuntadas() {
        window.juntadasVerMas = true;
        renderJuntadas();
    }

    function verDetalleJuntada(index) {
        const j = juntadasData[index];
        const usuario = getUsuarioActual();
        const asistentes = Object.keys(FOTOS).filter(n => esConfirmadoPositivo(j[n]));
        const hoy = new Date(); hoy.setHours(0,0,0,0);
        const fechaJ = j.Fecha ? parseFecha(j.Fecha) : null;
        const esFutura = fechaJ && fechaJ >= hoy;
        const esAdmin = currentUser === ADMIN_EMAIL;
        const esHostJuntada = usuario && esHostDe(j.Host, usuario.Nombre);
        const puedeEditar = esFutura ? esHostJuntada : esAdmin;

        const driveLink = getDriveLink(j);
       const driveBtn = driveLink ? `
    <a href="${driveLink}" target="_blank"
       style="display:flex;align-items:center;justify-content:center;gap:10px;margin-top:20px;padding:14px;border-radius:12px;background:rgba(66,133,244,0.15);border:2px solid #4285F4;color:#4285F4;font-size:15px;font-weight:bold;text-decoration:none;">
        üìÅ Ver o subir fotos en Google Drive
    </a>` 
    : `<div style="margin-top:20px;padding:14px;border-radius:12px;background:rgba(244,67,54,0.1);border:2px solid rgba(244,67,54,0.4);color:#f44336;font-size:13px;text-align:center;">
         Ni una puta foto sacamos ü§¶.
    </div>`;

        const botonesAdmin = puedeEditar ? `
            <div style="display:flex;gap:10px;margin-top:15px;">
                <button onclick="abrirModalEditarJuntada(${index})" style="flex:1;background:rgba(255,215,0,0.15);border:2px solid #FFD700;color:#FFD700;padding:12px;border-radius:10px;font-size:14px;font-weight:bold;cursor:pointer;">‚úèÔ∏è Editar</button>
                <button onclick="confirmarEliminar(${index})" style="flex:1;background:rgba(244,67,54,0.15);border:2px solid #f44336;color:#f44336;padding:12px;border-radius:10px;font-size:14px;font-weight:bold;cursor:pointer;">üóëÔ∏è Eliminar</button>
            </div>` : '';

        document.getElementById('juntadaDetalleContent').innerHTML = `
            <div style="background:linear-gradient(135deg,#1e1e3f 0%,#2a2a4f 100%);padding:30px;border-radius:20px;margin-top:60px;border:2px solid rgba(139,77,143,0.5);">
                ${j['Foto Juntada']||j['Foto']?`<div style="width:100%;margin:0 auto 25px;border-radius:15px;overflow:hidden;border:3px solid #C8A830;"><img src="${j['Foto Juntada']||j['Foto']}" style="width:100%;max-height:400px;object-fit:contain;background:#0a0614;display:block;"></div>`:''}
                <div style="text-align:center;margin-bottom:25px;">
                    <div style="color:#FFD700;font-size:14px;font-weight:bold;margin-bottom:10px;">${j.Fecha||'Fecha'}</div>
                    <div style="color:white;font-size:24px;font-weight:bold;margin-bottom:10px;">${j.Descripci√≥n||j.Descripcion||'Juntada'}</div>
                    <div style="color:rgba(255,255,255,0.7);font-size:14px;margin-bottom:5px;">üè† Host: ${j.Host||'Sin host'}</div>
                    ${j.Categor√≠a||j.Categoria?`<div style="color:rgba(255,255,255,0.7);font-size:14px;margin-bottom:5px;">üè∑Ô∏è ${j.Categor√≠a||j.Categoria}</div>`:''}
                    <div style="color:#FFD700;font-size:18px;font-weight:bold;margin-top:10px;">üë• ${asistentes.length} Asistentes</div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:15px;margin-top:25px;">
                    ${asistentes.map(n=>`
                        <div style="text-align:center;cursor:pointer;" onclick="verPerfilCulposo('${n}')">
                            <div style="width:70px;height:70px;border-radius:50%;background-image:url('${FOTOS[n]}');background-size:cover;background-position:center;margin:0 auto 8px;border:3px solid #FFD700;"></div>
                            <div style="color:white;font-size:12px;font-weight:bold;">${n}</div>
                        </div>`).join('')}
                </div>
                ${driveBtn}
                ${botonesAdmin}
            </div>`;

        document.getElementById('juntadaDetalle').style.display = 'block';
    }

    function cerrarDetalle() { document.getElementById('juntadaDetalle').style.display = 'none'; }

    function confirmarEliminar(index) {
        const j = juntadasData[index];
        if (confirm(`¬øSeguro que quer√©s eliminar "${j.Descripci√≥n||j.Descripcion||'esta juntada'}" del ${j.Fecha}?`)) eliminarJuntada(index);
    }

    async function eliminarJuntada(index) {
        try {
            const r = await fetch(APPS_SCRIPT_URL, { method:'POST', body:JSON.stringify({ accion:'eliminar_juntada', fila:index+2 }) });
            const res = await r.json();
            if (res.success) { alert('‚úÖ Juntada eliminada'); cerrarDetalle(); await recargarJuntadas(); renderHome(); renderJuntadas(); }
            else alert('‚ùå Error: ' + res.error);
        } catch { alert('‚ùå Error de conexi√≥n'); }
    }

    function abrirModalEditarJuntada(index) {
        cerrarDetalle();
        const j = juntadasData[index];
        window.editandoIndex = index;
        let fechaInput = '';
        if (j.Fecha) { const p = j.Fecha.split('/'); if (p.length===3) fechaInput=`${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`; }
        const hostOptions = CULPOSOS_HOSTS.map(n=>`<option value="${n}" ${j.Host===n?'selected':''}>${n}</option>`).join('');
        const catActual = j.Categor√≠a||j.Categoria||'';
        const catOptions = CATEGORIAS.map(c=>`<option value="${c}" ${catActual===c?'selected':''}>${c}</option>`).join('');

        document.getElementById('modalEditarContent').innerHTML = `
            <div style="background:linear-gradient(135deg,#1e1e3f 0%,#2a2a4f 100%);padding:30px;border-radius:20px;margin-top:60px;border:2px solid rgba(139,77,143,0.5);">
                <div style="text-align:center;margin-bottom:25px;"><div style="font-size:28px;margin-bottom:8px;">‚úèÔ∏è</div><div style="color:#FFD700;font-size:22px;font-weight:bold;">Editar Juntada</div></div>
                <div style="margin-bottom:15px;"><label style="color:rgba(255,255,255,0.9);font-size:14px;display:block;margin-bottom:8px;">üìÖ Fecha</label><input type="date" id="editFecha" value="${fechaInput}" style="width:100%;padding:12px;border-radius:8px;border:2px solid rgba(139,77,143,0.3);background:rgba(30,30,63,0.5);color:white;font-size:14px;"></div>
                <div style="margin-bottom:15px;"><label style="color:rgba(255,255,255,0.9);font-size:14px;display:block;margin-bottom:8px;">üè† Host</label><select id="editHost" class="form-select">${hostOptions}</select></div>
                <div style="margin-bottom:15px;"><label style="color:rgba(255,255,255,0.9);font-size:14px;display:block;margin-bottom:8px;">üìù Descripci√≥n</label><input type="text" id="editDescripcion" value="${j.Descripci√≥n||j.Descripcion||''}" style="width:100%;padding:12px;border-radius:8px;border:2px solid rgba(139,77,143,0.3);background:rgba(30,30,63,0.5);color:white;font-size:14px;"></div>
                <div style="margin-bottom:20px;"><label style="color:rgba(255,255,255,0.9);font-size:14px;display:block;margin-bottom:8px;">üè∑Ô∏è Categor√≠a</label><select id="editCategoria" class="form-select"><option value="">Sin categor√≠a</option>${catOptions}</select></div>
                <div style="margin-bottom:15px;"><label style="color:rgba(255,255,255,0.9);font-size:14px;display:block;margin-bottom:8px;">üïê Hora (opcional)</label><input type="time" id="editHora" value="${j.Hora||''}" style="width:100%;padding:12px;border-radius:8px;border:2px solid rgba(139,77,143,0.3);background:rgba(30,30,63,0.5);color:white;font-size:14px;"></div>
                <button onclick="enviarEdicion()" style="width:100%;background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);border:none;color:#1E1E3F;padding:15px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;">üíæ Guardar cambios</button>
                <div id="mensajeEdicion" style="margin-top:15px;text-align:center;display:none;"></div>
            </div>`;
        document.getElementById('modalEditarJuntada').style.display = 'block';
    }

    function cerrarModalEditarJuntada() { document.getElementById('modalEditarJuntada').style.display = 'none'; }

    async function enviarEdicion() {
        const fecha = document.getElementById('editFecha').value;
        const host = document.getElementById('editHost').value;
        const descripcion = document.getElementById('editDescripcion').value;
        const categoria = document.getElementById('editCategoria').value;
        const hora = document.getElementById('editHora').value;
        const msg = document.getElementById('mensajeEdicion');
        if (!fecha||!host||!descripcion) { msg.style.display='block'; msg.innerHTML='<div style="color:#f44336;">‚ö†Ô∏è Complet√° todos los campos</div>'; return; }
        const [y,m,d] = fecha.split('-');
        msg.style.display='block'; msg.innerHTML='<div style="color:#FFD700;">‚è≥ Guardando...</div>';
        try {
            const r = await fetch(APPS_SCRIPT_URL, { method:'POST', body:JSON.stringify({ accion:'editar_juntada', fila:window.editandoIndex+2, fecha:`${d}/${m}/${y}`, host, descripcion, categoria, hora }) });
            const res = await r.json();
            if (res.success) { msg.innerHTML='<div style="color:#4CAF50;font-weight:bold;">‚úÖ ¬°Juntada actualizada!</div>'; setTimeout(async()=>{ cerrarModalEditarJuntada(); await recargarJuntadas(); renderHome(); renderJuntadas(); }, 1500); }
            else msg.innerHTML=`<div style="color:#f44336;">‚ùå Error: ${res.error}</div>`;
        } catch { msg.innerHTML='<div style="color:#f44336;">‚ùå Error de conexi√≥n</div>'; }
    }

    function abrirModalConfirmar(indexJuntada) {
        const j = juntadasData[indexJuntada];
        const usuario = getUsuarioActual();
        if (!usuario) return;
        window.proximaJuntadaIndex = indexJuntada;
        const culpososOriginales = ['Mateo','Rama','Tirri','Toti','Toto','Caama√±o','Zabala','Santi'];
        const confirmados = [], noConfirmados = [];
        let culpososConf = 0;
        culpososData.forEach(c => {
            const val = j[c.Nombre];
            if (esConfirmadoPositivo(val)) { confirmados.push(c.Nombre); if (culpososOriginales.includes(c.Nombre)) culpososConf++; }
            else if (esConfirmadoNegativo(val)) noConfirmados.push(c.Nombre);
        });
        const hayQuorum = culpososConf >= 4;
        const miVal = j[usuario.Nombre];
        const yaConfirme = estaConfirmado(miVal);
        const confirmePos = esConfirmadoPositivo(miVal);
        let botonesHTML = '';
        if (yaConfirme) {
            botonesHTML = confirmePos
                ? `<div style="text-align:center;padding:20px;background:rgba(76,175,80,0.2);border-radius:12px;border:2px solid #4CAF50;"><div style="font-size:32px;margin-bottom:8px;">‚úÖ</div><div style="font-size:18px;font-weight:bold;color:#4CAF50;margin-bottom:4px;">¬°Ya confirmaste asistencia!</div><div style="font-size:13px;color:rgba(255,255,255,0.6);margin-bottom:12px;">Los culposos te esperan üî•</div><button onclick="mostrarEdicion()" style="background:rgba(255,255,255,0.15);border:2px solid #FFD700;color:#FFD700;padding:10px 22px;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;">‚úèÔ∏è Editar respuesta</button></div>`
                : `<div style="text-align:center;padding:20px;background:rgba(244,67,54,0.2);border-radius:12px;border:2px solid #f44336;"><div style="font-size:32px;margin-bottom:8px;">‚ùå</div><div style="font-size:18px;font-weight:bold;color:#f44336;margin-bottom:4px;">Me abstuve ‚Äî no voy</div><div style="font-size:13px;color:rgba(255,255,255,0.6);margin-bottom:12px;">Los trolos se abstuvieron. Saludos!</div><button onclick="mostrarEdicion()" style="background:rgba(255,255,255,0.15);border:2px solid #FFD700;color:#FFD700;padding:10px 22px;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;">‚úèÔ∏è Editar respuesta</button></div>`;
        } else {
            botonesHTML = `<div style="color:white;font-size:18px;font-weight:bold;text-align:center;margin-bottom:15px;">¬øVas a asistir?</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <button onclick="confirmarAsistencia(true)" style="background:linear-gradient(135deg,#4CAF50 0%,#45a049 100%);border:none;color:white;padding:15px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;">‚úÖ ASISTIR√â</button>
                    <button onclick="confirmarAsistencia(false)" style="background:linear-gradient(135deg,#f44336 0%,#d32f2f 100%);border:none;color:white;padding:15px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;">‚ùå NO ASISTIR√â</button>
                </div>
                <div style="text-align:center;margin-top:10px;color:rgba(255,255,255,0.4);font-size:11px;font-style:italic;">(trolos abstenerse)</div>`;
        }
        document.getElementById('modalConfirmarContent').innerHTML = `
            <div style="background:linear-gradient(135deg,#1e1e3f 0%,#2a2a4f 100%);padding:30px;border-radius:20px;margin-top:60px;border:2px solid rgba(139,77,143,0.5);">
                <div style="text-align:center;margin-bottom:25px;">
                    <div style="color:#FFD700;font-size:14px;font-weight:bold;margin-bottom:10px;">${j.Fecha}</div>
                    <div style="color:white;font-size:24px;font-weight:bold;margin-bottom:10px;">${j.Descripci√≥n||j.Descripcion}</div>
                    <div style="color:rgba(255,255,255,0.7);font-size:14px;">üè† ${j.Host||'Sin host'}</div>
                </div>
             ${renderContadorAsistencia(j)}
                <div style="margin:25px 0;">${botonesHTML}</div>
                <div id="mensajeConfirmacion" style="margin-top:15px;text-align:center;display:none;"></div>
            </div>`;
        document.getElementById('modalConfirmar').style.display = 'block';
    }

    function mostrarEdicion() {
        document.getElementById('mensajeConfirmacion').style.display = 'block';
        document.getElementById('mensajeConfirmacion').innerHTML = `
            <div style="background:rgba(139,77,143,0.2);padding:15px;border-radius:10px;">
                <div style="color:white;font-size:14px;font-weight:bold;margin-bottom:10px;">Cambiar respuesta:</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <button onclick="confirmarAsistencia(true)" style="background:linear-gradient(135deg,#4CAF50 0%,#45a049 100%);border:none;color:white;padding:12px;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;">‚úÖ VOY</button>
                    <button onclick="confirmarAsistencia(false)" style="background:linear-gradient(135deg,#f44336 0%,#d32f2f 100%);border:none;color:white;padding:12px;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;">‚ùå NO VOY</button>
                </div>
            </div>`;
    }

    function cerrarModalConfirmar() { document.getElementById('modalConfirmar').style.display = 'none'; }

    async function confirmarAsistencia(asistira) {
        const msg = document.getElementById('mensajeConfirmacion');
        msg.style.display='block'; msg.innerHTML='<div style="color:#FFD700;">‚è≥ Guardando...</div>';
        try {
            const r = await fetch(APPS_SCRIPT_URL, { method:'POST', body:JSON.stringify({ email:currentUser, fila:window.proximaJuntadaIndex+2, asistira }) });
            const res = await r.json();
            if (res.success) {
                msg.innerHTML=`<div style="color:#4CAF50;font-weight:bold;">‚úÖ ${res.mensaje||'Confirmaci√≥n guardada'}</div>`;
                setTimeout(async()=>{ await recargarJuntadas(); abrirModalConfirmar(window.proximaJuntadaIndex); renderHome(); }, 800);
            } else msg.innerHTML=`<div style="color:#f44336;">‚ùå Error: ${res.error}</div>`;
        } catch { msg.innerHTML='<div style="color:#f44336;">‚ùå Error de conexi√≥n</div>'; }
    }

    async function recargarJuntadas() {
        const r = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Hoja%201`);
        juntadasData = parseCSV(await r.text());
    }

    function abrirModalProponerJuntada() {
        const hostOptions = CULPOSOS_HOSTS.map(n=>`<option value="${n}">${n}</option>`).join('');
        const catOptions = CATEGORIAS.map(c=>`<option value="${c}">${c}</option>`).join('');
        document.getElementById('modalProponerContent').innerHTML = `
            <div style="background:linear-gradient(135deg,#1e1e3f 0%,#2a2a4f 100%);padding:30px;border-radius:20px;margin-top:60px;border:2px solid rgba(139,77,143,0.5);">
                <div style="text-align:center;margin-bottom:25px;"><div style="font-size:32px;margin-bottom:10px;">üéâ</div><div style="color:#FFD700;font-size:24px;font-weight:bold;">Proponer Juntada</div></div>
                <div style="margin-bottom:15px;"><label style="color:rgba(255,255,255,0.9);font-size:14px;display:block;margin-bottom:8px;">üìÖ Fecha</label><input type="date" id="propFecha" style="width:100%;padding:12px;border-radius:8px;border:2px solid rgba(139,77,143,0.3);background:rgba(30,30,63,0.5);color:white;font-size:14px;"></div>
                <div style="margin-bottom:15px;"><label style="color:rgba(255,255,255,0.9);font-size:14px;display:block;margin-bottom:8px;">üè† Host</label><select id="propHost" class="form-select"><option value="">Seleccionar...</option>${hostOptions}</select></div>
                <div style="margin-bottom:15px;"><label style="color:rgba(255,255,255,0.9);font-size:14px;display:block;margin-bottom:8px;">üìù Descripci√≥n</label><input type="text" id="propDescripcion" placeholder="Ej: Asado en lo de..." style="width:100%;padding:12px;border-radius:8px;border:2px solid rgba(139,77,143,0.3);background:rgba(30,30,63,0.5);color:white;font-size:14px;"></div>
                <div style="margin-bottom:20px;"><label style="color:rgba(255,255,255,0.9);font-size:14px;display:block;margin-bottom:8px;">üè∑Ô∏è Categor√≠a</label><select id="propCategoria" class="form-select"><option value="">Sin categor√≠a</option>${catOptions}</select></div>
                <div style="margin-bottom:15px;"><label style="color:rgba(255,255,255,0.9);font-size:14px;display:block;margin-bottom:8px;">üïê Hora (opcional)</label><input type="time" id="propHora" style="width:100%;padding:12px;border-radius:8px;border:2px solid rgba(139,77,143,0.3);background:rgba(30,30,63,0.5);color:white;font-size:14px;"></div>
                <button onclick="enviarPropuesta()" style="width:100%;background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);border:none;color:#1E1E3F;padding:15px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;">üöÄ Proponer</button>
                <div id="mensajePropuesta" style="margin-top:15px;text-align:center;display:none;"></div>
            </div>`;
        document.getElementById('modalProponerJuntada').style.display = 'block';
    }

    function cerrarModalProponerJuntada() { document.getElementById('modalProponerJuntada').style.display = 'none'; }

    async function enviarPropuesta() {
        const fecha=document.getElementById('propFecha').value, host=document.getElementById('propHost').value;
const hora=document.getElementById('propHora').value;
        const desc=document.getElementById('propDescripcion').value, cat=document.getElementById('propCategoria').value;
        const msg=document.getElementById('mensajePropuesta');
        if (!fecha||!host||!desc) { msg.style.display='block'; msg.innerHTML='<div style="color:#f44336;">‚ö†Ô∏è Complet√° fecha, host y descripci√≥n</div>'; return; }
        const [y,m,d]=fecha.split('-');
        msg.style.display='block'; msg.innerHTML='<div style="color:#FFD700;">‚è≥ Creando juntada...</div>';
        try {
            const r=await fetch(APPS_SCRIPT_URL,{method:'POST',body:JSON.stringify({accion:'crear_juntada',fecha:`${d}/${m}/${y}`,host,descripcion:desc,categoria:cat,hora:hora})});
            const res=await r.json();
            if (res.success) { msg.innerHTML='<div style="color:#4CAF50;font-weight:bold;">‚úÖ ¬°Juntada propuesta!</div>'; setTimeout(()=>{ cerrarModalProponerJuntada(); location.reload(); },2000); }
            else msg.innerHTML=`<div style="color:#f44336;">‚ùå Error: ${res.error}</div>`;
        } catch { msg.innerHTML='<div style="color:#f44336;">‚ùå Error de conexi√≥n</div>'; }
    }

function editarBio() {
    const usuario = getUsuarioActual();
    const bioActual = usuario.Bio || '';
    const nueva = prompt('Tu bio (m√°x 100 caracteres):', bioActual);
    if (nueva === null) return; // cancel√≥
    const bioFinal = nueva.slice(0, 100);
    fetch(APPS_SCRIPT_URL, { method:'POST', body:JSON.stringify({ accion:'guardar_bio', email:currentUser, bio:bioFinal }) })
        .then(r=>r.json())
        .then(res => {
            if (res.success) {
                usuario.Bio = bioFinal;
                renderPerfilCulposo(null);
            } else alert('‚ùå Error guardando bio');
        })
        .catch(() => alert('‚ùå Error de conexi√≥n'));
}
    
    function renderPerfil() { renderPerfilCulposo(null); }

    function renderPerfilCulposo(nombreCulposo) {
        const esMio = !nombreCulposo;
        const usuario = esMio ? getUsuarioActual() : culpososData.find(c=>c.Nombre===nombreCulposo);
        if (!usuario) { document.getElementById('perfilData').innerHTML=`<div class="card"><p style="color:rgba(255,255,255,0.7);">No se encontr√≥ el perfil.</p></div>`; return; }
        const pct = parseFloat(usuario.Porcentaje).toFixed(0);
        const isPerfecto = pct==100;
        let col='#f44336';
        if(pct>=100)col='#4CAF50';else if(pct>=90)col='#8BC34A';else if(pct>=60)col='#FFD700';else if(pct>=35)col='#FF9800';
        const premios=premiosData.filter(p=>p.Ganador&&p.Ganador.trim()===usuario.Nombre&&p.Tipo==='Persona');
        const oro=premios.filter(p=>p.Terna&&p.Terna.includes('CULPOSO DE ORO'));
        const otros=premios.filter(p=>p.Terna&&!p.Terna.includes('CULPOSO DE ORO'));
        const premiosHTML=premios.length>0?`<div class="section-title" style="margin-top:25px;">üèÜ Palmar√©s</div><div class="card" style="padding:20px;">${oro.map(p=>`<div style="margin:12px 0;padding:12px;background:rgba(255,215,0,0.15);border-radius:8px;"><span style="font-size:18px;font-weight:bold;color:#FFD700;">üèÜ CULPOSO DE ORO (${p.A√±o||''})</span></div>`).join('')}${otros.map(p=>`<div style="margin:8px 0;color:rgba(255,255,255,0.9);">ü•á <span style="text-transform:uppercase;font-weight:bold;">${p.Terna||'PREMIO'} (${p.A√±o||''})</span></div>`).join('')}</div>`:'' ;
        const fotoUrl=FOTOS[usuario.Nombre]||'';
        const usuarioLogueado=getUsuarioActual();
        const esMiPerfil=usuarioLogueado&&usuarioLogueado.Nombre===usuario.Nombre;
        const r=calcularRacha(usuario.Nombre);
        const rachaCard=r>=10?`<div class="card" style="background:linear-gradient(135deg,rgba(255,100,0,0.15) 0%,rgba(255,60,0,0.05) 100%);border-left-color:#FF6600;"><div style="display:flex;align-items:center;gap:12px;"><div style="font-size:36px;">üî•</div><div><div class="card-title" style="color:#FF6600;">¬°${r} EN RACHA!</div><div class="card-details">${esMiPerfil?'Llevas':'Lleva'} ${r} juntadas seguidas sin faltar.</div></div></div></div>`:r>=5?`<div class="card" style="background:linear-gradient(135deg,rgba(204,153,0,0.15) 0%,rgba(204,153,0,0.05) 100%);border-left-color:#CC9900;"><div style="display:flex;align-items:center;gap:12px;"><div style="font-size:36px;">‚ö°</div><div><div class="card-title" style="color:#CC9900;">¬°${r} en racha!</div><div class="card-details">${esMiPerfil?'Llevas':'Lleva'} ${r} juntadas seguidas.</div></div></div></div>`:'';
        document.getElementById('perfilData').innerHTML=`
            ${!esMiPerfil?`<div style="text-align:center;margin-bottom:15px;"><button onclick="renderPerfil()" style="background:rgba(139,77,143,0.3);border:2px solid #8B4D8F;color:#FFD700;padding:8px 15px;border-radius:10px;font-size:12px;font-weight:bold;cursor:pointer;">‚Üê Volver a mi perfil</button></div>`:''}
            ${fotoUrl?`<div style="text-align:center;margin-bottom:20px;"><img src="${fotoUrl}" style="width:100px;height:100px;border-radius:50%;border:3px solid #C8A830;object-fit:cover;object-position:center top;"></div>`:''}
            <div class="card" style="border-left-color:${isPerfecto?'#FFD700':'#8B4D8F'};">
    <div class="card-title" style="font-size:24px;">${usuario.Nombre}</div>
    <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
    ${usuario.Bio ? `<div style="color:rgba(255,255,255,0.7);font-size:13px;font-style:italic;flex:1;">${usuario.Bio}</div>` : ''}
    ${esMiPerfil ? `<button onclick="editarBio()" style="background:none;border:1px solid rgba(200,168,48,0.3);color:rgba(200,168,48,0.6);font-size:11px;cursor:pointer;padding:3px 7px;border-radius:6px;flex-shrink:0;">${usuario.Bio ? '‚úèÔ∏è' : '‚úèÔ∏è Agregar descripci√≥n'}</button>` : ''}
    
</div>
</div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-number" style="color:${col};">${usuario.Asistencias}/${usuario['Total Juntadas']}</div><div class="stat-label">Asistencias</div></div>
                <div class="stat-card"><div class="stat-number" style="color:${col};">${pct}%</div><div class="stat-label">Porcentaje</div></div>
            </div>
            ${isPerfecto?`<div class="card" style="background:linear-gradient(135deg,rgba(255,215,0,0.1) 0%,rgba(255,215,0,0.05) 100%);border-left-color:#FFD700;"><div class="card-title">üèÜ ¬°CULPOSO PERFECTO!</div><div class="card-details">${esMiPerfil?'No te perdiste ninguna juntada. Sos un crack.':'No se perdi√≥ ninguna juntada. Un verdadero crack.'}</div></div>`:''}
            ${(()=>{
    const oros = premiosData.filter(p=>p.Terna&&p.Terna.toUpperCase().includes('CULPOSO DE ORO')).sort((a,b)=>(b.A√±o||0)-(a.A√±o||0));
    const esOro = oros.length && oros[0].Ganador === usuario.Nombre;
    return esOro ? `<div class="card" style="background:linear-gradient(135deg,rgba(255,215,0,0.18) 0%,rgba(255,165,0,0.08) 100%);border:2px solid #FFD700;border-left:4px solid #FFD700;text-align:center;padding:20px;">
        <div style="font-size:36px;margin-bottom:8px;">üèÜ</div>
        <div style="color:#FFD700;font-size:18px;font-weight:bold;letter-spacing:1px;">CULPOSO DE ORO ${oros[0].A√±o}</div>
        <div style="color:rgba(255,215,0,0.65);font-size:13px;margin-top:6px;">El culposo de Oro vigente. Una leyenda.</div>
    </div>` : '';
})()}
${rachaCard}
           
            ${renderHostPanel(usuario.Nombre)}
            ${premiosHTML}
           <div class="section-title" style="margin-top:25px;">üí¨ Comentarios</div>
            <div id="comentariosSection">
                <div id="comentariosList_${usuario.Nombre}" style="margin-bottom:15px;"></div>
                ${esMiPerfil || true ? `
                <div class="card" style="padding:15px;">
                    <textarea id="nuevoComentario_${usuario.Nombre}" placeholder="Dej√° un comentario culposo..." 
                        style="width:100%;padding:10px;border-radius:8px;border:2px solid rgba(139,77,143,0.3);background:rgba(30,30,63,0.5);color:white;font-size:14px;resize:none;height:80px;font-family:inherit;"></textarea>
                    <button onclick="enviarComentario('${usuario.Nombre}')" 
                        style="width:100%;margin-top:10px;background:linear-gradient(135deg,#6B2D91 0%,#4A1D6B 100%);border:2px solid #C8A830;color:#C8A830;padding:10px;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;">
                        üí¨ Comentar
                    </button>
                </div>` : ''}
            </div>
            ${esMiPerfil?`
            <div class="section-title">üìÖ Mi Participaci√≥n</div>
            <div class="card" onclick="showTab('juntadas',document.querySelectorAll('.tab')[2])" style="cursor:pointer;text-align:center;background:linear-gradient(135deg,rgba(139,77,143,0.2) 0%,rgba(139,77,143,0.1) 100%);">
                <div class="card-title" style="color:#FFD700;font-size:16px;">üìä Ver todas mis juntadas ‚Üí</div>
                <div class="card-details" style="margin-top:5px;">Revis√° tu historial completo de asistencias</div>
            </div>
            <div class="card" style="margin-top:10px;text-align:center;background:linear-gradient(135deg,rgba(107,45,145,0.15) 0%,rgba(74,29,107,0.1) 100%);">
                <div style="color:rgba(255,255,255,0.7);font-size:12px;margin-bottom:10px;">üîî Notificaciones de nueva juntada</div>
                <button id="btnNotif" onclick="activarNotificaciones()" style="background:linear-gradient(135deg,#6B2D91 0%,#4A1D6B 100%);border:2px solid #C8A830;color:#C8A830;padding:10px 20px;border-radius:10px;font-size:13px;font-weight:bold;cursor:pointer;">Activar notificaciones</button>
                <div id="notifStatus" style="margin-top:8px;font-size:12px;color:rgba(255,255,255,0.5);"></div>
           </div>`:''}`;
        cargarComentarios(usuario.Nombre);
    }

    function renderHostPanel(nombre) {
        const hoy = new Date(); hoy.setHours(0,0,0,0);
        const hosteadas = juntadasData.filter(j => {
            if (!j.Host || !esHostDe(j.Host, nombre) || !j.Fecha) return false;
            const f = parseFecha(j.Fecha);
            return f && f < hoy && tieneQuorum(j);
        });
        if (!hosteadas.length) return '';
        const cards = hosteadas.slice().reverse().map(j => {
            const ri = juntadasData.indexOf(j);
            const foto = j['Foto Juntada']||j['Foto juntada']||'';
            return `<div onclick="verDetalleJuntada(${ri})" style="cursor:pointer;background:linear-gradient(135deg,#1e1e3f 0%,#2a2a4f 100%);border-radius:12px;overflow:hidden;border:2px solid rgba(139,77,143,0.3);transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
                ${foto?`<div style="overflow:hidden;"><img src="${foto}" style="width:100%;height:90px;object-fit:cover;display:block;"></div>`:`<div style="height:80px;background:linear-gradient(135deg,rgba(139,77,143,0.3),rgba(107,56,112,0.3));display:flex;align-items:center;justify-content:center;font-size:28px;">üè†</div>`}
                <div style="padding:10px;"><div style="color:#FFD700;font-size:10px;font-weight:bold;">${j.Fecha||''}</div><div style="color:white;font-size:12px;font-weight:bold;margin-top:3px;line-height:1.3;">${j.Descripci√≥n||j.Descripcion||'Juntada'}</div><div style="color:rgba(255,255,255,0.5);font-size:11px;margin-top:4px;">üë• ${j['N¬∞ Asist']||'0'}</div></div>
            </div>`;
        }).join('');
        return `<div class="section-title" style="margin-top:25px;">üè† Host (${hosteadas.length})</div><div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:10px;">${cards}</div>`;
    }

    function verPerfilCulposo(nombre) {
    cerrarDetalle();
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab')[5].classList.add('active');
    showTab('perfil', document.querySelectorAll('.tab')[5]);
    renderPerfilCulposo(nombre);
}

    function renderAwards() {
        const year=document.getElementById('yearFilter').value;
        const filtrados=premiosData.filter(p=>p.A√±o==year);
        const oro=filtrados.filter(p=>p.Tipo==='Persona'&&p.Terna&&p.Terna.toUpperCase().includes('CULPOSO DE ORO'));
        const individuales=filtrados.filter(p=>p.Tipo==='Persona'&&p.Terna&&!p.Terna.toUpperCase().includes('CULPOSO DE ORO'));
        const juntadas=filtrados.filter(p=>p.Tipo==='Juntada');
        let html='';
        oro.forEach(p=>{ const f=FOTOS[p.Ganador]||''; html+=`<div style="background:linear-gradient(135deg,rgba(255,215,0,0.2) 0%,rgba(255,215,0,0.05) 100%);padding:30px;border-radius:20px;margin-bottom:30px;border:3px solid #FFD700;text-align:center;">${f?`<img src="${f}" onclick="verPerfilCulposo('${p.Ganador}')" style="width:100px;height:100px;border-radius:50%;border:4px solid #FFD700;object-fit:cover;object-position:center top;margin-bottom:15px;cursor:pointer;">`:''}<div style="font-size:40px;margin-bottom:10px;">üèÜ</div><div style="color:#FFD700;font-size:24px;font-weight:bold;margin-bottom:10px;">CULPOSO DE ORO ${year}</div><div onclick="verPerfilCulposo('${p.Ganador}')" style="color:white;font-size:28px;font-weight:bold;cursor:pointer;">${p.Ganador||'Sin ganador'}</div></div>`; });
        if(individuales.length>0){ html+='<div class="section-title" style="margin-top:25px;">ü•á Premios Individuales</div>';
            individuales.forEach(p=>{ const f=FOTOS[p.Ganador]||''; html+=`<div onclick="verPerfilCulposo('${p.Ganador}')" style="background:linear-gradient(135deg,#160D2E 0%,#1E1040 100%);border-radius:12px;border:2px solid rgba(107,45,145,0.4);padding:14px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:transform 0.2s;margin-bottom:10px;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'"><div style="width:52px;height:52px;min-width:52px;border-radius:50%;border:2px solid #C8A830;overflow:hidden;flex-shrink:0;"><img src="${f||'https://i.imgur.com/czObXpX.png'}" style="width:100%;height:100%;object-fit:cover;object-position:center top;display:block;"></div><div style="flex:1;min-width:0;"><div style="color:#C8A830;font-size:11px;font-weight:bold;text-transform:uppercase;letter-spacing:0.5px;">${p.Terna||'Premio'}</div><div style="color:white;font-size:15px;font-weight:bold;margin-top:3px;">${p.Ganador||'Sin ganador'}</div></div></div>`; }); }
        if(juntadas.length>0){ html+='<div class="section-title" style="margin-top:25px;">üéâ Mejores Juntadas</div>'; juntadas.forEach(p=>{ html+=`<div class="card"><div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;"><div style="font-size:24px;">üèÜ</div><div style="color:#FFD700;font-size:14px;font-weight:bold;text-transform:uppercase;flex:1;">${p.Terna||'Premio'}</div></div><div style="color:white;font-size:16px;font-weight:bold;">${p.Ganador||'Sin ganador'}</div></div>`; }); }
      
const driveLinks = {
    '2024': 'https://drive.google.com/drive/folders/1tFNvAYajjXgLRXpnuyMM2oe5M8fA__Wb?usp=sharing',
    '2025': 'https://drive.google.com/drive/folders/1o-b0n-iwafgcYfPq9_r_PzT0lI-eHeXc?usp=sharing'
};
document.getElementById('driveLinkInline').innerHTML = driveLinks[year]
    ? `<a href="${driveLinks[year]}" target="_blank" style="display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:8px;background:rgba(66,133,244,0.15);border:1.5px solid #4285F4;color:#4285F4;font-size:12px;font-weight:bold;text-decoration:none;">üìÅ Fotos LCA ${year}</a>`
    : '';
if(!html) html=`<p style="color:rgba(255,255,255,0.6);text-align:center;padding:40px;">No hay premios registrados para ${year}</p>`;
document.getElementById('awardsList').innerHTML=html;
    }

    let gastosArray=[];
    const TODOS_NOMBRES=['Toto','Caama√±o','Rama','Zabala','Santi','Mateo','Tirri','Toti','Cata','Lola','Sami','Leila','Juli','Manu','Matu'];

    function getAlias(nombre) { const c=culpososData.find(x=>x.Nombre===nombre); return c&&c.Alias?c.Alias:''; }

    function agregarGasto() { gastosArray.push({id:Date.now(),quien:'',concepto:'',monto:0,consumidores:[]}); renderGastos(); }
    function eliminarGasto(id) { gastosArray=gastosArray.filter(g=>g.id!==id); renderGastos(); }
    function toggleTodos(idx) { const todos=gastosArray[idx].consumidores.length===TODOS_NOMBRES.length; gastosArray[idx].consumidores=todos?[]:[...TODOS_NOMBRES]; renderGastos(); }

    function renderGastos() {
        const c=document.getElementById('gastosContainer');
        if(!gastosArray.length){ c.innerHTML=`<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.6);"><div style="font-size:48px;margin-bottom:15px;">üí∏</div><div>No hay gastos agregados</div></div>`; return; }
        c.innerHTML=gastosArray.map((g,idx)=>`
            <div class="card" style="margin-bottom:20px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;"><div style="color:#FFD700;font-weight:bold;">Gasto ${idx+1}</div><button onclick="eliminarGasto(${g.id})" style="background:rgba(244,67,54,0.2);border:2px solid #f44336;color:#f44336;padding:5px 10px;border-radius:5px;font-size:12px;cursor:pointer;">‚úï Eliminar</button></div>
                <div style="margin-bottom:10px;"><label style="color:rgba(255,255,255,0.8);font-size:13px;display:block;margin-bottom:5px;">¬øQui√©n pag√≥?</label><select onchange="gastosArray[${idx}].quien=this.value" class="form-select"><option value="">Seleccionar...</option>${TODOS_NOMBRES.map(n=>`<option value="${n}" ${g.quien===n?'selected':''}>${n}</option>`).join('')}</select></div>
                <div style="margin-bottom:10px;"><label style="color:rgba(255,255,255,0.8);font-size:13px;display:block;margin-bottom:5px;">Concepto</label><input type="text" value="${g.concepto}" oninput="gastosArray[${idx}].concepto=this.value" placeholder="Ej: Carne, Pan..." style="width:100%;padding:10px;border-radius:8px;border:2px solid rgba(139,77,143,0.3);background:rgba(30,30,63,0.5);color:white;font-size:14px;"></div>
                <div style="margin-bottom:10px;"><label style="color:rgba(255,255,255,0.8);font-size:13px;display:block;margin-bottom:5px;">Monto ($)</label><input type="number" value="${g.monto||''}" oninput="gastosArray[${idx}].monto=parseFloat(this.value)||0" placeholder="0" style="width:100%;padding:10px;border-radius:8px;border:2px solid rgba(139,77,143,0.3);background:rgba(30,30,63,0.5);color:white;font-size:14px;"></div>
                <div><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><label style="color:rgba(255,255,255,0.8);font-size:13px;">¬øQui√©nes consumen/usan?</label><button onclick="toggleTodos(${idx})" style="background:rgba(255,215,0,0.15);border:2px solid #FFD700;color:#FFD700;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:bold;cursor:pointer;">${g.consumidores.length===TODOS_NOMBRES.length?"‚òê Ninguno":"‚òëÔ∏è Todos"}</button></div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">${TODOS_NOMBRES.map(n=>`<label style="display:flex;align-items:center;gap:6px;color:rgba(255,255,255,0.9);font-size:13px;cursor:pointer;"><input type="checkbox" ${g.consumidores.includes(n)?'checked':''} onchange="if(this.checked){if(!gastosArray[${idx}].consumidores.includes('${n}'))gastosArray[${idx}].consumidores.push('${n}');}else{gastosArray[${idx}].consumidores=gastosArray[${idx}].consumidores.filter(x=>x!=='${n}');}" style="cursor:pointer;">${n}</label>`).join('')}</div></div>
            </div>`).join('');
    }

    function calcularDivision() {
        const res=document.getElementById('resultadoCalculo');
        if(!gastosArray.length){res.innerHTML='<div class="card" style="background:rgba(244,67,54,0.2);border-left-color:#f44336;"><div style="color:#f44336;">‚ö†Ô∏è No hay gastos para calcular</div></div>';return;}
        for(let g of gastosArray){if(!g.quien||!g.concepto||g.monto<=0||!g.consumidores.length){res.innerHTML='<div class="card" style="background:rgba(244,67,54,0.2);border-left-color:#f44336;"><div style="color:#f44336;">‚ö†Ô∏è Complet√° todos los campos</div></div>';return;}}
        const bal={};
        TODOS_NOMBRES.forEach(n=>bal[n]=0);
        gastosArray.forEach(g=>{ const cpp=g.monto/g.consumidores.length; g.consumidores.forEach(c=>bal[c]-=cpp); bal[g.quien]+=g.monto; });
        const PAREJAS = {
    'Toto':'Cata','Cata':'Toto',
    'Toti':'Leila','Leila':'Toti',
    'Mateo':'Juli','Juli':'Mateo',
    'Caama√±o':'Manu','Manu':'Caama√±o',
    'Tirri':'Lola','Lola':'Tirri',
    'Zabala':'Sami','Sami':'Zabala'
};
const deu=[],acr=[];
Object.entries(bal).forEach(([n,b])=>{ if(Math.abs(b)<1)return; if(b<0)deu.push({n,m:Math.abs(b)}); else acr.push({n,m:b}); });
const trans=[],dc=[...deu],ac=[...acr];
// Primero resolver deudas entre parejas
for(const d of dc){
    const pareja = PAREJAS[d.n];
    if(!pareja) continue;
    const aIdx = ac.findIndex(a=>a.n===pareja);
    if(aIdx===-1) continue;
    const a = ac[aIdx];
    const m = Math.min(d.m, a.m);
    trans.push({de:d.n, a:a.n, monto:m});
    d.m-=m; a.m-=m;
    if(a.m<1) ac.splice(aIdx,1);
}
// Luego el resto normal
const dcRest = dc.filter(d=>d.m>=1);
const acRest = ac.filter(a=>a.m>=1);
while(dcRest.length&&acRest.length){ const d=dcRest[0],a=acRest[0],m=Math.min(d.m,a.m); trans.push({de:d.n,a:a.n,monto:m}); d.m-=m;a.m-=m; if(d.m<1)dcRest.shift();if(a.m<1)acRest.shift(); }
        const total=gastosArray.reduce((s,g)=>s+g.monto,0);
        const acreedores=[...new Set(trans.map(t=>t.a))];
        const aliases=acreedores.map(n=>{const a=getAlias(n);return a?`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);"><span style="color:rgba(255,255,255,0.8);font-weight:bold;">${n}</span><span style="color:#FFD700;">üí≥ ${a}</span></div>`:''}).filter(Boolean).join('');
        res.innerHTML=`<div class="card" style="background:linear-gradient(135deg,rgba(76,175,80,0.15) 0%,rgba(76,175,80,0.05) 100%);border-left-color:#4CAF50;">
            <div style="text-align:center;margin-bottom:20px;"><div style="font-size:14px;color:rgba(255,255,255,0.7);margin-bottom:5px;">TOTAL GASTADO</div><div style="font-size:32px;font-weight:bold;color:#4CAF50;">$${total.toLocaleString('es-AR')}</div></div>
            <div style="border-top:1px solid rgba(255,255,255,0.2);padding-top:15px;"><div style="color:#FFD700;font-weight:bold;margin-bottom:15px;text-align:center;">üí∏ TRANSFERENCIAS A REALIZAR</div>
            ${trans.map(t=>`<div style="background:rgba(139,77,143,0.2);padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;"><div style="color:white;font-size:14px;"><span style="font-weight:bold;">${t.de}</span> ‚Üí <span style="font-weight:bold;color:#4CAF50;">${t.a}</span></div><div style="color:#FFD700;font-weight:bold;font-size:16px;">$${Math.round(t.monto).toLocaleString('es-AR')}</div></div>`).join('')}</div>
            ${aliases?`<div style="margin-top:15px;padding:12px;background:rgba(255,215,0,0.08);border-radius:8px;border:1px solid rgba(255,215,0,0.3);"><div style="color:#FFD700;font-size:12px;font-weight:bold;text-transform:uppercase;margin-bottom:8px;">Alias para transferir</div>${aliases}</div>`:''}
            <button onclick="compartirResultado()" style="width:100%;margin-top:15px;background:rgba(37,211,102,0.2);border:2px solid #25D366;color:#25D366;padding:12px;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;">üì± Compartir por WhatsApp</button>
        </div>`;
    }

    function compartirResultado() {
        const total=gastosArray.reduce((s,g)=>s+g.monto,0);
        let txt=`üí∞ *DIVISI√ìN DE GASTOS - LA CULPA*\n\nTotal: $${total.toLocaleString('es-AR')}\n\n`;
        gastosArray.forEach((g,i)=>{ txt+=`${i+1}. ${g.concepto}: $${g.monto.toLocaleString('es-AR')} (${g.quien})\n`; });
        txt+=`\nüí∏ *TRANSFERENCIAS:*\n`;
        const bal={};TODOS_NOMBRES.forEach(n=>bal[n]=0);
        gastosArray.forEach(g=>{ const cpp=g.monto/g.consumidores.length; g.consumidores.forEach(c=>bal[c]-=cpp); bal[g.quien]+=g.monto; });
        const PAREJAS = {
    'Toto':'Cata','Cata':'Toto',
    'Toti':'Leila','Leila':'Toti',
    'Mateo':'Juli','Juli':'Mateo',
    'Caama√±o':'Manu','Manu':'Caama√±o',
    'Tirri':'Lola','Lola':'Tirri',
    'Zabala':'Sami','Sami':'Zabala'
};
const deu=[],acr=[];
Object.entries(bal).forEach(([n,b])=>{ if(Math.abs(b)<1)return; if(b<0)deu.push({n,m:Math.abs(b)}); else acr.push({n,m:b}); });
const trans=[],dc=[...deu],ac=[...acr];
// Primero resolver deudas entre parejas
for(const d of dc){
    const pareja = PAREJAS[d.n];
    if(!pareja) continue;
    const aIdx = ac.findIndex(a=>a.n===pareja);
    if(aIdx===-1) continue;
    const a = ac[aIdx];
    const m = Math.min(d.m, a.m);
    trans.push({de:d.n, a:a.n, monto:m});
    d.m-=m; a.m-=m;
    if(a.m<1) ac.splice(aIdx,1);
}
// Luego el resto normal
const dcRest = dc.filter(d=>d.m>=1);
const acRest = ac.filter(a=>a.m>=1);
while(dcRest.length&&acRest.length){ const d=dcRest[0],a=acRest[0],m=Math.min(d.m,a.m); trans.push({de:d.n,a:a.n,monto:m}); d.m-=m;a.m-=m; if(d.m<1)dcRest.shift();if(a.m<1)acRest.shift(); }        trans.forEach(t=>{ txt+=`${t.de} ‚Üí ${t.a}: $${Math.round(t.monto).toLocaleString('es-AR')}\n`; });
        const aw=[...new Set(trans.map(t=>t.a))].map(n=>{const a=getAlias(n);return a?`${n}: üí≥ ${a}`:null;}).filter(Boolean);
        if(aw.length) txt+=`\nüí≥ *ALIAS:*\n`+aw.join('\n');
        const waLink = document.createElement('a');
waLink.href = `https://api.whatsapp.com/send?text=${encodeURIComponent(txt)}`;
waLink.target = '_blank';
document.body.appendChild(waLink);
waLink.click();
document.body.removeChild(waLink);
    }

    function showTab(tabName, el) {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    if(el) el.classList.add('active');
    
    const current = document.querySelector('.content.active');
    if(current) {
        current.style.opacity = '0';
        setTimeout(() => {
            document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
            const next = document.getElementById(tabName);
            next.classList.add('active');
            next.style.opacity = '0';
            setTimeout(() => { next.style.opacity = '1'; }, 20);
        }, 150);
    }
}

    const FIREBASE_CONFIG = {
        apiKey:"AIzaSyAamBVJC48CtEd41HtvF5Ek0Bxui5TfsjA",authDomain:"la-culpa.firebaseapp.com",
        projectId:"la-culpa",storageBucket:"la-culpa.firebasestorage.app",
        messagingSenderId:"339936091040",appId:"1:339936091040:web:608ec8df925b088472a2c5"
    };
    const VAPID_KEY = "BLTKtmHW3u6CS-uITlN19AF0IWzlQmOBSwWarERODdaqPZ0jXSoVvhqvz2E64w_Jue5Sa3cazO8gkFHXRfb1Zzs";
    let messagingInstance = null;

    async function initFirebase() {
        try {
            firebase.initializeApp(FIREBASE_CONFIG);
            messagingInstance = firebase.messaging();
            messagingInstance.onMessage(payload => {
                const { title, body } = payload.notification || {};
                if (title) showInAppNotification(title, body);
            });
        } catch(e) { console.warn('Firebase init error:', e); }
    }

    function showInAppNotification(title, body) {
        const el = document.createElement('div');
        el.style.cssText = `position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:9999;background:linear-gradient(135deg,#6B2D91 0%,#4A1D6B 100%);color:white;padding:16px 22px;border-radius:16px;border:2px solid #C8A830;box-shadow:0 8px 30px rgba(0,0,0,0.6);max-width:340px;width:90%;text-align:center;animation:slideDown 0.3s ease;`;
        el.innerHTML = `<div style="font-size:22px;margin-bottom:6px;">üéâ</div><div style="font-weight:bold;color:#FFD700;font-size:15px;margin-bottom:4px;letter-spacing:0.5px;">${title}</div><div style="font-size:13px;opacity:0.85;line-height:1.4;">${body||''}</div>`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 5000);
    }

    async function pedirPermisoNotificaciones() {
        if (!messagingInstance) return;
        try {
            const perm = await Notification.requestPermission();
            if (perm !== 'granted') return;
            let swReg = null;
            if ('serviceWorker' in navigator) {
                swReg = await navigator.serviceWorker.register('/la-culpa-app/firebase-messaging-sw.js');
                await navigator.serviceWorker.ready;
            }
            const tokenOpts = { vapidKey: VAPID_KEY };
            if (swReg) tokenOpts.serviceWorkerRegistration = swReg;
            const token = await messagingInstance.getToken(tokenOpts);
            if (!token) return;
            const saved = localStorage.getItem('fcmToken');
            if (saved === token) return;
            await fetch(APPS_SCRIPT_URL, { method:'POST', body:JSON.stringify({ accion:'guardar_token', email:currentUser, token }) });
            localStorage.setItem('fcmToken', token);
        } catch(e) { console.warn('Error registrando notificaciones:', e); }
    }

    async function activarNotificaciones() {
        const btn = document.getElementById('btnNotif');
        const status = document.getElementById('notifStatus');
        if (btn) btn.disabled = true;
        if (status) status.textContent = '‚è≥ Registrando...';
        localStorage.removeItem('fcmToken');
        try {
            if (!messagingInstance) throw new Error('Firebase no inicializado');
            const perm = await Notification.requestPermission();
            if (perm !== 'granted') throw new Error('Permiso denegado: ' + perm);
            let swReg = null;
            if ('serviceWorker' in navigator) {
                swReg = await navigator.serviceWorker.register('/la-culpa-app/firebase-messaging-sw.js', { scope:'/la-culpa-app/' });
                await navigator.serviceWorker.ready;
            }
            const tokenOpts = { vapidKey: VAPID_KEY };
            if (swReg) tokenOpts.serviceWorkerRegistration = swReg;
            const token = await messagingInstance.getToken(tokenOpts);
            if (!token) throw new Error('Token vac√≠o');
            const r = await fetch(APPS_SCRIPT_URL, { method:'POST', body:JSON.stringify({ accion:'guardar_token', email:currentUser, token }) });
            const res = await r.json();
            if (!res.success) throw new Error('Error guardando token');
            localStorage.setItem('fcmToken', token);
            if (btn) { btn.textContent='‚úÖ Notificaciones activas'; btn.style.borderColor='#4CAF50'; btn.style.color='#4CAF50'; btn.disabled=false; }
            if (status) status.textContent='Este dispositivo va a recibir avisos de nuevas juntadas üîî';
        } catch(e) {
            if (btn) { btn.disabled=false; btn.textContent='Reintentar'; }
            if (status) status.textContent='‚ùå ' + e.message;
        }
    }

    async function cargarComentarios(destinatario) {
        const el = document.getElementById('comentariosList_' + destinatario);
        if (!el) return;
        try {
            const r = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=COMENTARIOS`);
            const rows = parseCSV(await r.text());
            const mios = rows.filter(c => c.Destinatario === destinatario);
            if (!mios.length) {
                el.innerHTML = '<p style="color:rgba(255,255,255,0.4);font-size:13px;text-align:center;padding:10px;">Nadie coment√≥ todav√≠a. Sean los primeros, culposos.</p>';
                return;
            }
            el.innerHTML = mios.map(c => {
                const likes = c.Likes ? c.Likes.split(',').filter(Boolean) : [];
                const yaDiLike = likes.includes(currentUser);
                const esMio = c.Autor === currentUser;
                const cu = culpososData.find(x => x.Email && x.Email.toLowerCase() === c.Autor);
                const fotoAutor = cu ? (FOTOS[cu.Nombre] || '') : '';
                const nombreAutor = cu ? cu.Nombre : c.Autor;
                return `<div style="background:linear-gradient(135deg,#160D2E 0%,#1E1040 100%);border-radius:12px;padding:14px;margin-bottom:10px;border:1.5px solid rgba(107,45,145,0.35);">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                        <div style="width:32px;height:32px;border-radius:50%;flex-shrink:0;${fotoAutor ? `background:url('${fotoAutor}') center top/cover` : 'background:linear-gradient(135deg,#8B4D8F,#6B3870)'};"></div>
                        <div style="flex:1;">
                            <div style="color:#C8A830;font-size:12px;font-weight:bold;">${nombreAutor}</div>
                            <div style="color:rgba(255,255,255,0.35);font-size:10px;">${c.Fecha}</div>
                        </div>
                        ${esMio ? `<button onclick="eliminarComentario('${c.ID}','${destinatario}')" style="background:none;border:none;color:rgba(244,67,54,0.6);font-size:16px;cursor:pointer;padding:2px 6px;">üóë</button>` : ''}
                    </div>
                    <div style="color:rgba(255,255,255,0.9);font-size:14px;line-height:1.5;margin-bottom:10px;">${c.Texto}</div>
                    <button onclick="likearComentario('${c.ID}','${destinatario}')"
                        style="background:${yaDiLike ? 'rgba(255,80,80,0.2)' : 'rgba(255,255,255,0.05)'};border:1.5px solid ${yaDiLike ? '#ff5050' : 'rgba(255,255,255,0.15)'};color:${yaDiLike ? '#ff5050' : 'rgba(255,255,255,0.5)'};padding:5px 12px;border-radius:20px;font-size:12px;cursor:pointer;">
                        ‚ù§Ô∏è ${likes.length || ''}
                    </button>
                </div>`;
            }).join('');
        } catch(e) { console.error(e); }
    }

    async function enviarComentario(destinatario) {
        const ta = document.getElementById('nuevoComentario_' + destinatario);
        const texto = ta ? ta.value.trim() : '';
        if (!texto) return;
        try {
            const r = await fetch(APPS_SCRIPT_URL, { method:'POST', body:JSON.stringify({ accion:'comentar', destinatario, autor:currentUser, texto }) });
            const res = await r.json();
            if (res.success) { ta.value = ''; cargarComentarios(destinatario); }
            else alert('‚ùå Error: ' + res.error);
        } catch { alert('‚ùå Error de conexi√≥n'); }
    }

    async function likearComentario(id, destinatario) {
        try {
            const r = await fetch(APPS_SCRIPT_URL, { method:'POST', body:JSON.stringify({ accion:'likear_comentario', id, email:currentUser }) });
            const res = await r.json();
            if (res.success) cargarComentarios(destinatario);
        } catch(e) { console.error(e); }
    }

    async function eliminarComentario(id, destinatario) {
        if (!confirm('¬øEliminar este comentario?')) return;
        try {
            const r = await fetch(APPS_SCRIPT_URL, { method:'POST', body:JSON.stringify({ accion:'eliminar_comentario', id, email:currentUser }) });
            const res = await r.json();
            if (res.success) cargarComentarios(destinatario);
            else alert('‚ùå ' + res.error);
        } catch { alert('‚ùå Error de conexi√≥n'); }
    }

    window.onload = function() {
    initFirebase();
    setTimeout(() => {
        const splash = document.getElementById('splashScreen');
        splash.style.opacity = '0';
        setTimeout(() => splash.style.display = 'none', 600);
    }, 1800);
        const saved = localStorage.getItem('culpaUserEmail');
        if (saved) { document.getElementById('emailInput').value=saved; login(); }
    };
</script>
    
<!-- ===== CULPAPP PLAYER PRO ===== -->

<style>
#culpapp-player {
  background: linear-gradient(135deg, #1E0A35 0%, #2A1455 100%);
  color: white;
  padding: 16px;
  border-radius: 16px;
  box-shadow: 0 8px 25px rgba(107,45,145,0.4);
  border: 1px solid rgba(200,168,48,0.2);
  display: flex;
  flex-direction: column;
  gap: 12px;
  font-family: sans-serif;
  width: 100%;
  max-width: 420px;
  margin: 15px auto;
}

#culpapp-player button {
  background: rgba(107,45,145,0.5);
  border: 1px solid rgba(200,168,48,0.4);
  color: #C8A830;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 14px;
  transition: 0.2s;
}

#culpapp-player button:hover {
  background: rgba(107,45,145,0.9);
  transform: scale(1.08);
}

#progressBar {
  -webkit-appearance: none;
  width: 100%;
  height: 6px;
  border-radius: 5px;
  background: rgba(200,168,48,0.2);
}

#progressBar::-webkit-slider-thumb {
  -webkit-appearance: none;
  height: 14px;
  width: 14px;
  border-radius: 50%;
  background: #FFD700;
  cursor: pointer;
}

#songName {
  color: #C8A830;
  font-size: 16px;
  font-weight: bold;
  text-align: center;
}

#timeDisplay {
  font-weight: 500;
  letter-spacing: 0.5px;
}
    #volume {
  -webkit-appearance: none;
  height: 4px;
  border-radius: 5px;
  background: rgba(200,168,48,0.2);
  width: 80px;
}

#volume::-webkit-slider-thumb {
  -webkit-appearance: none;
  height: 12px;
  width: 12px;
  border-radius: 50%;
  background: #C8A830;
  cursor: pointer;
}
</style>

<audio id="player"></audio>

<script>
const songs = [
  { src: "https://drive.google.com/uc?export=download&id=1ZhZsTInCoxH4YwSHgPs_EFbgvFJmuKX8", name: "CULPA AWARDS 2024 opening" },
  { src: "https://drive.google.com/uc?export=download&id=1Rz6dn6Y0AN5HvrDl7I6s9d_xHjN2RoLN", name: "No nos detendr√°n" },
  { src: "https://drive.google.com/uc?export=download&id=14zrFFIU3sRFfQFoCD1EdWFlXl1hh73S9", name: "Viva la culpa" },
  { src: "https://drive.google.com/uc?export=download&id=1c5PFUy4pvF1e-hD7P1xzGr4xUjUfdihc", name: "Puro coraz√≥n" },
  { src: "https://drive.google.com/uc?export=download&id=1QvWpZUgQAP71LevMV0Mzkk_V4N3n94ns", name: "Ocho reyes" },
  { src: "https://drive.google.com/uc?export=download&id=1Ru4IrlMLkksHj0GTQmyCZhdRO6zyQ_ln", name: "No apto para d√©biles" },
  { src: "https://drive.google.com/uc?export=download&id=1vMbEf6OgZlxwvMvQksyE-6cHLieo9RUa", name: "Siempre juntos feat. Bad Bunny" },
  { src: "https://drive.google.com/uc?export=download&id=1dovTKGGkTi15LLkrP4uIPZB-MpWmErkc", name: "CULPA AWARDS 2024 ending" }
];

let currentIndex = 0;
const player = document.getElementById("player");
const playBtn = document.getElementById("playBtn");
const volume = document.getElementById("volume");

function loadSong(index) {
  player.src = songs[index].src;
  document.getElementById("songName").textContent = songs[index].name + " - LA CULPA";
}

function togglePlay() {
  if (player.paused) {
    player.play();
    playBtn.textContent = "‚è∏";
  } else {
    player.pause();
    playBtn.textContent = "‚ñ∂";
  }
}

function nextSong() {
  currentIndex = (currentIndex + 1) % songs.length;
  loadSong(currentIndex);
  player.play().catch(() => {});
  playBtn.textContent = "‚è∏";
}

function prevSong() {
  currentIndex = (currentIndex - 1 + songs.length) % songs.length;
  loadSong(currentIndex);
  player.play();
  playBtn.textContent = "‚è∏";
}
    function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return mins + ":" + (secs < 10 ? "0" : "") + secs;
}

player.onended = nextSong;

    player.ontimeupdate = function() {
  const progressBar = document.getElementById("progressBar");
  const currentTimeEl = document.getElementById("currentTime");

  progressBar.max = player.duration;
  progressBar.value = player.currentTime;

  currentTimeEl.textContent = formatTime(player.currentTime);
};

player.onloadedmetadata = function() {
  const durationEl = document.getElementById("duration");
  durationEl.textContent = formatTime(player.duration);
};

volume.addEventListener("input", () => {
  player.volume = volume.value;
});

const progressBar = document.getElementById("progressBar");

player.addEventListener("loadedmetadata", () => {
  progressBar.max = Math.floor(player.duration);
});

player.addEventListener("timeupdate", () => {
  progressBar.value = Math.floor(player.currentTime);
});    

    progressBar.addEventListener("input", () => {
  player.currentTime = progressBar.value;
});
    
loadSong(currentIndex);
</script>

<!-- ===== FIN PLAYER PRO ===== -->

</body>
</html>
